<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Prompt Flow -- æç¤ºè¯ç®¡ç†1</title>
    <style>
        :root {
            /* æµ…è‰²ä¸»é¢˜ */
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --text-main: #1a1a1a;
            --text-sub: #666666;
            --text-muted: #999999;
            --primary: #2563eb; /* æ›´ç°ä»£çš„è“è‰² */
            --primary-hover: #1d4ed8;
            --accent: #0ea5e9;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --header-height: 64px;
        }

        body.dark-theme {
            /* æ·±è‰²ä¸»é¢˜ */
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-glass: rgba(31, 41, 55, 0.9);
            --text-main: #f3f4f6;
            --text-sub: #d1d5db;
            --text-muted: #9ca3af;
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --border: #374151;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-top: calc(var(--header-height) + 24px);
            min-height: 100vh;
        }

        /* === é¡¶éƒ¨å¯¼èˆªæ  === */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            transition: all 0.3s ease;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .search-container {
            flex: 1;
            max-width: 480px;
            margin: 0 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            height: 38px;
            border-radius: 19px;
            border: 1px solid var(--border);
            background: var(--bg-body);
            color: var(--text-main);
            padding: 0 36px 0 16px;
            outline: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            font-size: 14px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn {
            height: 36px;
            padding: 0 14px;
            border-radius: 8px;
            border: 1px solid transparent;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary { background: var(--primary); color: #fff; border-color: transparent; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-ghost { background: transparent; color: var(--text-main); border-color: var(--border); }
        .btn-ghost:hover { background: rgba(128, 128, 128, 0.05); border-color: var(--text-sub); }
        .btn-icon { width: 36px; padding: 0; font-size: 1.1rem; }
        
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: transparent; }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .sync-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-sub);
            padding: 4px 10px;
            background: var(--bg-body);
            border-radius: 20px;
            border: 1px solid var(--border);
            margin-right: 4px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .status-dot.synced { background-color: var(--success); }
        .status-dot.syncing { background-color: var(--warning); animation: pulse 1.5s infinite; }
        .status-dot.offline { background-color: var(--text-muted); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* === ä¸»å†…å®¹åŒº === */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .filter-bar::-webkit-scrollbar { display: none; }
        
        .filter-chip {
            padding: 6px 14px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-sub);
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .filter-chip:hover { border-color: var(--primary); color: var(--primary); }
        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }

        /* === å¡ç‰‡ç½‘æ ¼ === */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding-bottom: 100px; /* ä¸ºFABç•™ç©ºé—´ */
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 200px;
            cursor: pointer;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .card-body {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .card-title {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--text-main);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-badges {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .visibility-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            height: fit-content;
        }
        .v-public { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .v-private { background: rgba(37, 99, 235, 0.1); color: var(--primary); }

        .card-desc {
            font-size: 0.875rem;
            color: var(--text-sub);
            line-height: 1.5;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            margin-bottom: 12px;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: auto;
        }

        .tag {
            font-size: 11px;
            color: var(--text-sub);
            background: var(--bg-body);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .card-footer {
            padding: 10px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.01);
        }

        .card-meta { font-size: 11px; color: var(--text-muted); }

        .card-actions { display: flex; gap: 4px; }
        
        .action-btn {
            width: 28px; height: 28px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            border: none; background: transparent;
            color: var(--text-sub);
            cursor: pointer;
            transition: background 0.2s;
        }
        .action-btn:hover { background: var(--bg-body); color: var(--primary); }
        .action-btn.delete:hover { color: var(--danger); }

        /* FAB (æ‚¬æµ®æŒ‰é’®) */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 90;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }
        .fab:active { transform: scale(0.9); }

        /* === æ¨¡æ€æ¡†ç³»ç»Ÿ === */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal {
            background: var(--bg-card);
            width: 90%;
            max-width: 640px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transform: scale(0.95);
            transition: transform 0.2s;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .close-btn {
            background: none; border: none; font-size: 20px;
            color: var(--text-sub); cursor: pointer; padding: 4px;
        }

        .modal-body { padding: 24px; overflow-y: auto; }

        /* Confirm Modal Specific */
        .confirm-modal { max-width: 400px; }
        .confirm-content { text-align: center; padding: 10px 0; }
        .confirm-actions { display: flex; gap: 12px; justify-content: center; margin-top: 24px; }

        /* è¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; color: var(--text-main); }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-body);
            color: var(--text-main);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus { border-color: var(--primary); }
        .form-textarea { min-height: 120px; resize: vertical; line-height: 1.6; }
        
        /* è¯¦æƒ…è§†å›¾æ ·å¼ */
        .detail-content-box {
            background: var(--bg-body);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid var(--border);
            position: relative;
        }
        .copy-btn-absolute {
            position: absolute; top: 8px; right: 8px;
            padding: 4px 8px; font-size: 12px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 4px; cursor: pointer;
        }

        /* === å“åº”å¼é€‚é… === */
        @media (max-width: 768px) {
            :root { --header-height: 60px; }
            .app-header { padding: 0 12px; }
            .brand span { display: none; } /* ä»…æ˜¾ç¤ºLogoå›¾æ ‡(å¦‚æœæœ‰)æˆ–ç®€åŒ– */
            .brand::before { content: 'âœ¨'; font-size: 1.5rem; }
            .search-container { margin: 0 10px; max-width: none; }
            .controls span.btn-text { display: none; } /* éšè—æŒ‰é’®æ–‡å­— */
            .sync-badge { display: none; } /* ç§»åŠ¨ç«¯éšè—åŒæ­¥çŠ¶æ€æ–‡æ¡ˆï¼Œä»…ä¿ç•™ç‚¹æˆ–å®Œå…¨éšè— */
            .modal { width: 100%; height: 100%; border-radius: 0; max-height: 100%; max-width: 100%; }
            .confirm-modal { height: auto; width: 90%; border-radius: 16px; margin: auto; }
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="brand" onclick="window.scrollTo(0,0)">
            <span>âœ¨ Prompt Flow</span>
        </div>

        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æç¤ºè¯..." oninput="handleSearch(this.value)">
            <span class="search-icon">ğŸ”</span>
        </div>

        <div class="controls">
            <div class="sync-badge" id="syncStatus" title="äº‘ç«¯åŒæ­¥çŠ¶æ€">
                <div class="status-dot offline" id="syncDot"></div>
                <span id="syncText">æœªåŒæ­¥</span>
            </div>

            <button class="btn btn-ghost btn-icon" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span id="themeIcon">ğŸŒ™</span>
            </button>
            
            <button class="btn btn-primary" id="authBtn" onclick="toggleAuth()">
                <span id="authIcon">ğŸ”‘</span>
                <span class="btn-text" id="authText">ç™»å½•</span>
            </button>
        </div>
    </header>

    <div class="container">
        <div class="filter-bar">
            <div class="filter-chip active" onclick="setFilter('all', this)">å…¨éƒ¨</div>
            <div class="filter-chip" onclick="setFilter('public', this)">ğŸŒ å…¬å¼€å¹¿åœº</div>
            <div class="filter-chip" onclick="setFilter('private', this)">ğŸ”’ æˆ‘çš„ç§è—</div>
            <div class="filter-chip" onclick="setFilter('coding', this)">ğŸ’» ç¼–ç¨‹</div>
            <div class="filter-chip" onclick="setFilter('writing', this)">âœï¸ å†™ä½œ</div>
            <div class="filter-chip" onclick="setFilter('ai', this)">ğŸ¤– AI è§’è‰²</div>
            <div class="filter-chip" onclick="setFilter('productivity', this)">âš¡ æ•ˆç‡</div>
        </div>

        <div class="grid" id="promptGrid">
            <!-- Cards rendered via JS -->
        </div>
    </div>

    <div class="fab" id="addFab" onclick="openEditModal()" style="display: none;">+</div>

    <!-- ç¼–è¾‘/æ–°å»º æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="editModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">æ–°å»ºæç¤ºè¯</div>
                <button class="close-btn" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="promptForm" onsubmit="savePrompt(event)">
                    <input type="hidden" id="p_id">
                    
                    <div class="form-group">
                        <label class="form-label">æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="p_title" required placeholder="ç®€çŸ­çš„æ ‡é¢˜">
                    </div>

                    <div class="form-group">
                        <label class="form-label">ç®€çŸ­æè¿° (ç”¨äºåˆ—è¡¨å±•ç¤º)</label>
                        <input type="text" class="form-input" id="p_desc" required placeholder="ä¸€å¥è¯æè¿°è¿™ä¸ªæç¤ºè¯çš„ç”¨é€”...">
                    </div>

                    <div class="form-group" style="display: flex; gap: 16px;">
                        <div style="flex: 1;">
                            <label class="form-label">åˆ†ç±»</label>
                            <select class="form-select" id="p_category">
                                <option value="coding">ğŸ’» ç¼–ç¨‹</option>
                                <option value="writing">âœï¸ å†™ä½œ</option>
                                <option value="ai">ğŸ¤– AI è§’è‰²</option>
                                <option value="productivity">âš¡ æ•ˆç‡</option>
                                <option value="other">ğŸ“ å…¶ä»–</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label class="form-label">æƒé™</label>
                            <select class="form-select" id="p_visibility">
                                <option value="private">ğŸ”’ ç§å¯† (ä»…è‡ªå·±)</option>
                                <option value="public">ğŸŒ å…¬å¼€ (æ‰€æœ‰äºº)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æç¤ºè¯å†…å®¹ (Prompt)</label>
                        <textarea class="form-textarea" id="p_content" required placeholder="åœ¨æ­¤è¾“å…¥å®Œæ•´çš„ Prompt..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                        <input type="text" class="form-input" id="p_tags" placeholder="ä¾‹å¦‚: python, ç¿»è¯‘, æ•ˆç‡">
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                        <button type="button" class="btn btn-ghost" onclick="closeEditModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ… æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="viewModalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" style="font-size: 1rem; color: var(--text-sub);">æç¤ºè¯è¯¦æƒ…</div>
                <button class="close-btn" onclick="closeViewModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <h2 id="v_title" style="margin-bottom: 8px; color: var(--text-main);">æ ‡é¢˜</h2>
                <div style="margin-bottom: 16px;">
                    <span id="v_badge" class="visibility-badge v-public" style="margin-right: 8px;">å…¬å¼€</span>
                    <span id="v_meta" style="font-size: 12px; color: var(--text-muted);">æ›´æ–°äº...</span>
                </div>
                
                <p id="v_desc" style="color: var(--text-sub); margin-bottom: 20px; font-style: italic;"></p>

                <label class="form-label">Prompt å†…å®¹</label>
                <div class="detail-content-box">
                    <button class="copy-btn-absolute" onclick="copyCurrentViewContent()">å¤åˆ¶</button>
                    <div id="v_content"></div>
                </div>

                <div id="v_tags" class="card-tags" style="margin-top: 20px;"></div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-ghost" onclick="closeViewModal()">å…³é—­</button>
                    <button class="btn btn-ghost" id="v_edit_btn" style="display:none;" onclick="openEditFromView()">âœï¸ ç¼–è¾‘</button>
                    <button class="btn btn-primary" onclick="copyCurrentViewContent()">å¤åˆ¶ Prompt</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤ æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal confirm-modal">
            <div class="modal-header">
                <div class="modal-title">ç¡®è®¤æ“ä½œ</div>
                <button class="close-btn" onclick="closeConfirmModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="confirm-content">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ¤”</div>
                    <h3 style="margin-bottom: 8px;">ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ</h3>
                    <p style="color: var(--text-sub);" id="confirmMsg">åˆ é™¤åæ•°æ®å°†æ— æ³•æ¢å¤ã€‚</p>
                </div>
                <div class="confirm-actions">
                    <button class="btn btn-ghost" onclick="closeConfirmModal()">å–æ¶ˆ</button>
                    <button class="btn btn-danger" id="confirmYesBtn">ç¡®å®šåˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½• æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal" style="max-width: 360px; height: auto;">
            <div class="modal-body" style="text-align: center; padding: 40px 24px;">
                <div style="font-size: 40px; margin-bottom: 16px;">ğŸ”</div>
                <h2 style="margin-bottom: 12px;">äº‘ç«¯ç™»å½•</h2>
                <p style="color: var(--text-sub); margin-bottom: 24px; font-size: 14px;">
                    ç™»å½•ä»¥ç®¡ç†æ‚¨çš„ç§æœ‰æç¤ºè¯åº“å¹¶åŒæ­¥æ•°æ®ã€‚<br>
                    <span style="color: var(--text-muted); font-size: 12px;">(é»˜è®¤æ¼”ç¤ºå¯†ç : admin123)</span>
                </p>
                <input type="password" class="form-input" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " style="text-align: center; margin-bottom: 16px;">
                <button class="btn btn-primary" id="loginSubmitBtn" style="width: 100%; justify-content: center; margin-bottom: 12px;" onclick="performLogin()">ç«‹å³ç™»å½•</button>
                <button class="btn btn-ghost" style="width: 100%; justify-content: center;" onclick="closeLoginModal()">æš‚ä¸ç™»å½• (ä»…æµè§ˆ)</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">âœ… æ“ä½œæˆåŠŸ</div>

    <script>
        // === Core State ===
        const state = {
            isLoggedIn: false,
            apiToken: null, // Cloudflare API Token
            prompts: [],
            filterType: 'all', 
            searchQuery: '',
            isOnline: navigator.onLine
        };

        // === Demo Data (Fallback) ===
        const demoData = [
            {
                id: '1',
                title: 'ä¸“ä¸šè‹±æ±‰äº’è¯‘ä¸“å®¶',
                desc: 'ä¸“æ³¨äºä¿¡è¾¾é›…çš„ç¿»è¯‘é£æ ¼ï¼Œé€‚ç”¨äºæ–‡å­¦å’Œå•†åŠ¡åœºæ™¯ã€‚',
                content: 'ä½ æ˜¯ä¸€åä¸“ä¸šçš„ç¿»è¯‘å®¶ï¼Œç²¾é€šä¸­è‹±æ–‡ã€‚è¯·å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆåœ°é“çš„{Target_Language}ï¼Œç¡®ä¿ä¿¡è¾¾é›…ã€‚',
                category: 'writing',
                visibility: 'public',
                tags: ['ç¿»è¯‘', 'è‹±è¯­', 'å†™ä½œ'],
                updatedAt: new Date(Date.now() - 10000000).toISOString()
            },
            {
                id: '2',
                title: 'Vue3 + TS ç»„ä»¶ç”Ÿæˆå™¨',
                desc: 'å¿«é€Ÿç”ŸæˆåŒ…å« setup è¯­æ³•ç³–çš„æ ‡å‡†ç»„ä»¶æ¨¡æ¿ã€‚',
                content: 'è¯·å¸®æˆ‘ç¼–å†™ä¸€ä¸ª Vue3 (Composition API) + TypeScript çš„ç»„ä»¶ã€‚éœ€æ±‚å¦‚ä¸‹ï¼š\n1. ç»„ä»¶åï¼š[Name]\n2. Props: [Props]\n3. åŠŸèƒ½ï¼š[Function]',
                category: 'coding',
                visibility: 'public',
                tags: ['Vue3', 'TypeScript', 'å‰ç«¯'],
                updatedAt: new Date(Date.now() - 5000000).toISOString()
            }
        ];

        // === Lifecycle ===
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            
            // æ£€æŸ¥ Token
            const token = localStorage.getItem('pf_token');
            if (token) {
                state.isLoggedIn = true;
                state.apiToken = token;
                updateAuthUI();
                // å°è¯•ä»äº‘ç«¯æ‹‰å–
                syncDown().then(success => {
                    if (!success) loadData(); // å¦‚æœäº‘ç«¯å¤±è´¥ï¼ŒåŠ è½½æœ¬åœ°
                });
            } else {
                loadData(); // æ—  Tokenï¼Œç›´æ¥åŠ è½½æœ¬åœ°
            }

            window.addEventListener('online', () => { state.isOnline = true; updateSyncUI('synced'); });
            window.addEventListener('offline', () => { state.isOnline = false; updateSyncUI('offline'); });
        });

        // === Data Management ===

        // åŠ è½½æ•°æ®ï¼ˆä¼˜å…ˆæœ¬åœ°ï¼‰
        function loadData() {
            const local = localStorage.getItem('pf_data');
            if (local) {
                state.prompts = JSON.parse(local);
            } else {
                state.prompts = demoData; // ä»…ç¬¬ä¸€æ¬¡ä½¿ç”¨æ¼”ç¤ºæ•°æ®
                saveData(false); // åˆå§‹åŒ–ä¸è§¦å‘ Sync
            }
            render();
        }

        // ä¿å­˜æ•°æ®ï¼ˆåŒæ—¶å°è¯•åŒæ­¥ï¼‰
        async function saveData(triggerSync = true) {
            localStorage.setItem('pf_data', JSON.stringify(state.prompts));
            if (triggerSync && state.isLoggedIn) {
                await syncUp();
            }
        }

        // API: æ‹‰å–æ•°æ®
        async function syncDown() {
            if (!state.apiToken || isLocalFile()) {
                updateSyncUI('offline');
                return false;
            }
            
            updateSyncUI('syncing');
            try {
                const res = await fetch('/api/data/load', {
                    headers: { 'Authorization': `Bearer ${state.apiToken}` }
                });
                
                if (res.ok) {
                    const { data } = await res.json();
                    if (data) {
                        state.prompts = data; // ç®€å•ç­–ç•¥ï¼šäº‘ç«¯è¦†ç›–æœ¬åœ°
                        localStorage.setItem('pf_data', JSON.stringify(state.prompts));
                        render();
                    }
                    updateSyncUI('synced');
                    return true;
                } else {
                    // Token å¤±æ•ˆ
                    if (res.status === 401) logout();
                    updateSyncUI('offline');
                    return false;
                }
            } catch (e) {
                console.error('Sync down failed:', e);
                updateSyncUI('offline');
                return false;
            }
        }

        // API: æ¨é€æ•°æ®
        async function syncUp() {
            if (!state.apiToken || isLocalFile()) {
                // æœ¬åœ°æ¨¡æ‹ŸåŒæ­¥
                simulateSync();
                return;
            }

            updateSyncUI('syncing');
            try {
                const res = await fetch('/api/data/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiToken}`
                    },
                    body: JSON.stringify(state.prompts)
                });

                if (res.ok) {
                    updateSyncUI('synced');
                } else {
                    if (res.status === 401) logout();
                    updateSyncUI('offline');
                }
            } catch (e) {
                console.error('Sync up failed:', e);
                updateSyncUI('offline');
            }
        }

        function simulateSync() {
            updateSyncUI('syncing');
            setTimeout(() => {
                if(state.isLoggedIn) updateSyncUI('synced'); // å‡è£…åŒæ­¥æˆåŠŸ
                else updateSyncUI('offline');
            }, 600);
        }

        // === Authentication ===
        
        function toggleAuth() {
            if (state.isLoggedIn) {
                if(confirm('ç¡®å®šé€€å‡ºç™»å½•å—ï¼Ÿ')) logout();
            } else {
                document.getElementById('loginModal').classList.add('active');
                setTimeout(() => document.getElementById('loginPassword').focus(), 100);
            }
        }

        function logout() {
            state.isLoggedIn = false;
            state.apiToken = null;
            localStorage.removeItem('pf_token');
            updateAuthUI();
            updateSyncUI('offline');
            render(); // é‡æ–°æ¸²æŸ“ä»¥éšè—ç§æœ‰å†…å®¹
            showToast('å·²é€€å‡º');
        }

        async function performLogin() {
            const pwd = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginSubmitBtn');
            const originalText = btn.innerText;
            
            btn.innerText = 'ç™»å½•ä¸­...';
            btn.disabled = true;

            // 1. å°è¯•çœŸå® API ç™»å½•
            if (!isLocalFile()) {
                try {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: pwd })
                    });

                    const data = await res.json();

                    if (res.ok && data.token) {
                        // æˆåŠŸ
                        loginSuccess(data.token);
                        btn.innerText = originalText;
                        btn.disabled = false;
                        return;
                    }
                } catch (e) {
                    console.log('API Login failed, falling back to local check');
                }
            }

            // 2. é™çº§ï¼šæœ¬åœ°æ¼”ç¤ºå¯†ç æ£€æŸ¥
            // é»˜è®¤å¯†ç  admin æˆ– admin123
            if (pwd === 'admin' || pwd === 'admin123') {
                // ç”Ÿæˆä¸€ä¸ªå‡ Token
                const fakeToken = 'local_demo_token_' + Date.now();
                loginSuccess(fakeToken);
                showToast('âš ï¸ ç¦»çº¿/æ¼”ç¤ºæ¨¡å¼ç™»å½•');
            } else {
                showToast('âŒ å¯†ç é”™è¯¯ (è¯•: admin123)');
            }
            
            btn.innerText = originalText;
            btn.disabled = false;
        }

        function loginSuccess(token) {
            state.isLoggedIn = true;
            state.apiToken = token;
            localStorage.setItem('pf_token', token);
            closeLoginModal();
            updateAuthUI();
            render();
            syncDown(); // ç™»å½•åå°è¯•æ‹‰å–
            showToast('ğŸ‰ ç™»å½•æˆåŠŸ');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('loginPassword').value = '';
        }

        function updateAuthUI() {
            const btnText = document.getElementById('authText');
            const btnIcon = document.getElementById('authIcon');
            const fab = document.getElementById('addFab');
            
            if (state.isLoggedIn) {
                btnText.textContent = 'é€€å‡º';
                btnIcon.textContent = 'ğŸšª';
                document.getElementById('authBtn').classList.replace('btn-primary', 'btn-ghost');
                fab.style.display = 'flex';
            } else {
                btnText.textContent = 'ç™»å½•';
                btnIcon.textContent = 'ğŸ”‘';
                document.getElementById('authBtn').classList.replace('btn-ghost', 'btn-primary');
                fab.style.display = 'none';
            }
        }

        function updateSyncUI(status) {
            const dot = document.getElementById('syncDot');
            const text = document.getElementById('syncText');
            const badge = document.getElementById('syncStatus');
            
            dot.className = 'status-dot ' + status;
            
            if (status === 'synced') {
                text.textContent = 'å·²åŒæ­¥';
                badge.style.opacity = '1';
            } else if (status === 'syncing') {
                text.textContent = 'åŒæ­¥ä¸­';
                badge.style.opacity = '1';
            } else {
                text.textContent = isLocalFile() ? 'æœ¬åœ°å­˜å‚¨' : 'æœªè¿æ¥';
                badge.style.opacity = state.isLoggedIn ? '1' : '0.5';
            }
        }

        // === Render Logic ===
        function render() {
            const grid = document.getElementById('promptGrid');
            grid.innerHTML = '';

            const filtered = state.prompts.filter(p => {
                // æƒé™è¿‡æ»¤
                if (!state.isLoggedIn && p.visibility === 'private') return false;
                
                // æœç´¢è¿‡æ»¤
                if (state.searchQuery) {
                    const q = state.searchQuery.toLowerCase();
                    return (p.title || '').toLowerCase().includes(q) || 
                           (p.desc || '').toLowerCase().includes(q) || 
                           (Array.isArray(p.tags) ? p.tags : []).join(' ').toLowerCase().includes(q);
                }

                // ç±»åˆ«/Tabè¿‡æ»¤
                if (state.filterType === 'all') return true;
                if (state.filterType === 'public') return p.visibility === 'public';
                if (state.filterType === 'private') return p.visibility === 'private';
                return p.category === state.filterType;
            });

            // æ’åºï¼šæ–°çš„åœ¨å‰
            filtered.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">ğŸ“­</div>
                        <p>æš‚æ— ç›¸å…³æç¤ºè¯</p>
                        ${!state.isLoggedIn ? '<p style="font-size: 12px; margin-top: 8px;">(ç™»å½•åæŸ¥çœ‹æ‚¨çš„ç§æœ‰åº“)</p>' : ''}
                    </div>
                `;
                return;
            }

            filtered.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = (e) => {
                    // é˜²æ­¢ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘å¡ç‰‡æŸ¥çœ‹
                    if (!e.target.closest('.action-btn')) {
                        openViewModal(p.id);
                    }
                };

                const isOwner = state.isLoggedIn;
                const visBadge = p.visibility === 'private' 
                    ? '<span class="visibility-badge v-private">ğŸ”’ ç§å¯†</span>'
                    : '<span class="visibility-badge v-public">ğŸŒ å…¬å¼€</span>';

                card.innerHTML = `
                    <div class="card-body">
                        <div class="card-header">
                            <div class="card-title">${esc(p.title)}</div>
                            <div class="card-badges">${visBadge}</div>
                        </div>
                        <div class="card-desc">${esc(p.desc || p.content)}</div>
                        <div class="card-tags">
                            ${(Array.isArray(p.tags) ? p.tags : []).map(t => `<span class="tag">#${esc(t)}</span>`).join('')}
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="card-meta">${timeAgo(p.updatedAt)}</div>
                        <div class="card-actions">
                            <button class="action-btn" onclick="copyText('${esc(p.content)}')" title="å¤åˆ¶"><span style="font-size: 14px;">ğŸ“‹</span></button>
                            ${isOwner ? `
                                <button class="action-btn" onclick="openEditModal('${p.id}')" title="ç¼–è¾‘"><span style="font-size: 14px;">âœï¸</span></button>
                                <button class="action-btn delete" onclick="confirmDelete('${p.id}')" title="åˆ é™¤"><span style="font-size: 14px;">ğŸ—‘ï¸</span></button>
                            ` : ''}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // === Interaction Handlers ===
        
        function handleSearch(val) {
            state.searchQuery = val;
            render();
        }

        function setFilter(type, el) {
            state.filterType = type;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            render();
        }

        // --- Edit/Create Modal ---
        function openEditModal(id = null) {
            if (!state.isLoggedIn) { toggleAuth(); return; }
            
            const modal = document.getElementById('editModalOverlay');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('promptForm');
            
            if (id) {
                const p = state.prompts.find(x => x.id === id);
                if (!p) return;
                title.textContent = 'ç¼–è¾‘æç¤ºè¯';
                document.getElementById('p_id').value = p.id;
                document.getElementById('p_title').value = p.title;
                document.getElementById('p_desc').value = p.desc || '';
                document.getElementById('p_category').value = p.category || 'other';
                document.getElementById('p_visibility').value = p.visibility || 'private';
                document.getElementById('p_content').value = p.content;
                document.getElementById('p_tags').value = (Array.isArray(p.tags) ? p.tags : []).join(', ');
            } else {
                title.textContent = 'æ–°å»ºæç¤ºè¯';
                form.reset();
                document.getElementById('p_id').value = '';
                document.getElementById('p_visibility').value = 'private';
            }
            modal.classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModalOverlay').classList.remove('active');
        }

        function savePrompt(e) {
            e.preventDefault();
            try {
                const id = document.getElementById('p_id').value;
                
                const newItem = {
                    id: id || Date.now().toString(),
                    title: document.getElementById('p_title').value,
                    desc: document.getElementById('p_desc').value,
                    category: document.getElementById('p_category').value,
                    visibility: document.getElementById('p_visibility').value,
                    content: document.getElementById('p_content').value,
                    tags: document.getElementById('p_tags').value.split(/[,ï¼Œ]/).map(t=>t.trim()).filter(t=>t),
                    updatedAt: new Date().toISOString()
                };

                if (id) {
                    const idx = state.prompts.findIndex(x => x.id === id);
                    if (idx > -1) state.prompts[idx] = newItem;
                } else {
                    state.prompts.unshift(newItem);
                }

                saveData();
                render();
                closeEditModal();
                showToast('âœ… å·²ä¿å­˜');
            } catch (err) {
                console.error('Save failed:', err);
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
            }
        }

        // --- Delete Confirmation ---
        let pendingDeleteId = null;
        
        function confirmDelete(id) {
            pendingDeleteId = id;
            const p = state.prompts.find(x => x.id === id);
            document.getElementById('confirmMsg').textContent = `æ‚¨ç¡®å®šè¦åˆ é™¤ "${p ? p.title : 'è¿™æ¡æç¤ºè¯'}" å—ï¼Ÿ`;
            
            const modal = document.getElementById('confirmModal');
            modal.classList.add('active');
            
            // Bind Confirm Action
            document.getElementById('confirmYesBtn').onclick = () => {
                executeDelete();
            };
        }

        function executeDelete() {
            if (pendingDeleteId) {
                state.prompts = state.prompts.filter(p => p.id !== pendingDeleteId);
                saveData();
                render();
                showToast('ğŸ—‘ï¸ å·²åˆ é™¤');
            }
            closeConfirmModal();
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingDeleteId = null;
        }

        // --- View Details Modal ---
        let currentViewId = null;

        function openViewModal(id) {
            const p = state.prompts.find(x => x.id === id);
            if (!p) return;
            currentViewId = id;

            document.getElementById('v_title').textContent = p.title;
            document.getElementById('v_desc').textContent = p.desc || 'æš‚æ— æè¿°';
            document.getElementById('v_content').textContent = p.content;
            document.getElementById('v_meta').textContent = 'æœ€åæ›´æ–°: ' + new Date(p.updatedAt).toLocaleString();
            
            const badge = document.getElementById('v_badge');
            badge.className = `visibility-badge ${p.visibility === 'public' ? 'v-public' : 'v-private'}`;
            badge.textContent = p.visibility === 'public' ? 'ğŸŒ å…¬å¼€' : 'ğŸ”’ ç§å¯†';

            const tagsContainer = document.getElementById('v_tags');
            tagsContainer.innerHTML = (Array.isArray(p.tags) ? p.tags : []).map(t => `<span class="tag">#${esc(t)}</span>`).join('');

            // Show/Hide Edit Button
            const editBtn = document.getElementById('v_edit_btn');
            if (state.isLoggedIn) {
                editBtn.style.display = 'inline-flex';
            } else {
                editBtn.style.display = 'none';
            }

            document.getElementById('viewModalOverlay').classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewModalOverlay').classList.remove('active');
            currentViewId = null;
        }

        function openEditFromView() {
            if (currentViewId) {
                closeViewModal();
                openEditModal(currentViewId);
            }
        }

        function copyCurrentViewContent() {
            if (currentViewId) {
                const p = state.prompts.find(x => x.id === currentViewId);
                if (p) copyText(p.content);
            }
        }

        // === Utils ===

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => showToast('ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
        }

        function esc(str) {
            if (!str) return '';
            return str.replace(/&/g, "&amp;")
                      .replace(/</g, "&lt;")
                      .replace(/>/g, "&gt;")
                      .replace(/"/g, "&quot;")
                      .replace(/'/g, "&#039;");
        }

        function timeAgo(dateStr) {
            const diff = (new Date() - new Date(dateStr)) / 1000;
            if (diff < 60) return 'åˆšåˆš';
            if (diff < 3600) return Math.floor(diff/60) + 'åˆ†é’Ÿå‰';
            if (diff < 86400) return Math.floor(diff/3600) + 'å°æ—¶å‰';
            if (diff < 2592000) return Math.floor(diff/86400) + 'å¤©å‰';
            return new Date(dateStr).toLocaleDateString();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function isLocalFile() {
            return window.location.protocol === 'file:';
        }

        // Theme
        function initTheme() {
            const theme = localStorage.getItem('pf_theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('themeIcon').textContent = 'â˜€ï¸';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('pf_theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        }
    </script>
</body>
</html>