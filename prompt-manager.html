<!DOCTYPE html>
<!-- 
  制作者：YN
  日期：2025-08-20
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>提示词管理工具</title>
    <style>
        :root {
            /* 主色系 */
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --primary-light: #5dade2;
            --success-color: #27ae60;
            --success-dark: #229954;
            --warning-color: #f39c12;
            --warning-dark: #e67e22;
            --danger-color: #e74c3c;
            --danger-dark: #c0392b;
            --secondary-color: #95a5a6;
            --secondary-dark: #7f8c8d;
            
            /* 中性色系 */
            --background-color: #f5f5f5;
            --surface-color: white;
            --border-color: #e0e0e0;
            --border-light: #f0f0f0;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --text-inverse: white;
            
            /* 间距系统 */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-xxl: 24px;
            --spacing-xxxl: 32px;
            
            /* 字体系统 */
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-xxl: 20px;
            --line-height-tight: 1.2;
            --line-height-normal: 1.4;
            --line-height-relaxed: 1.6;
            
            /* 圆角系统 */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 10px;
            --radius-pill: 20px;
            
            /* 阴影系统 */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 2px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
            
            /* 暗色主题变量 */
            --dark-background: #2c3e50;
            --dark-surface: #34495e;
            --dark-surface-light: #3a536b;
            --dark-border: #4a6741;
            --dark-text-primary: #ecf0f1;
            --dark-text-secondary: #bdc3c7;
            --dark-text-muted: #95a5a6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            font-size: var(--font-size-md);
            line-height: var(--line-height-relaxed);
            margin: 0;
            padding: 0;
            
            /* 移动端优化 */
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            
            /* 字体渲染优化 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            
            /* 修复鼠标位置偏移问题 */
            transform: none;
            -webkit-transform: none;
            position: relative;
            overflow-x: hidden;
        }
        
        /* 防止页面缩放导致的鼠标偏移 */
        html {
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        .header {
            background: var(--surface-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .header > div:first-child {
            text-align: center;
        }

        .header h1 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-xxl);
            font-weight: 600;
            margin: 0 0 8px 0;
            letter-spacing: -0.02em;
        }
        
        .header p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
            font-weight: 400;
            opacity: 0.8;
        }
        
        body.dark-theme .header p {
            color: #9ca3af;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            justify-content: center;
            
            /* 响应式尺寸 */
            flex: 1 1 auto;
            min-width: 120px;
            max-width: 200px;
            height: 48px;
            padding: 12px 16px;
            
            /* 样式 */
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-color);
            
            /* 文本 */
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            
            /* 交互 */
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            
            /* 触控优化 */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(52, 152, 219, 0.1);
            box-sizing: border-box;
        }

        .nav-tab:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .nav-tab.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* 平板端适配 */
        @media (max-width: 1024px) {
            .container {
                padding: 16px;
            }
            
            .nav-tab {
                min-width: 100px;
                max-width: 150px;
                font-size: 13px;
                padding: 10px 12px;
            }
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .header {
                flex-direction: row;
                position: relative;
                padding: 16px;
                justify-content: center;
                align-items: flex-start;
            }
            
            .header > div:first-child {
                text-align: center;
                flex: 1;
            }
            
            .theme-toggle {
                top: 16px;
                right: 16px;
                width: 38px;
                height: 38px;
                font-size: 14px;
            }
            
            .nav-tabs {
                flex-direction: row;
                gap: 6px;
                justify-content: center;
                align-items: center;
            }
            
            .nav-tab {
                flex: 1 1 auto;
                min-width: 60px;
                max-width: none;
                height: 48px;
                font-size: 13px;
                padding: 8px 12px;
                text-align: center;
            }
            
            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
            }
        }

        /* 小屏手机适配 */
        @media (max-width: 480px) {
            .items-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 8px;
            }
            .container {
                padding: 8px;
            }
            
            .header {
                padding: 12px;
            }
            
            .theme-toggle {
                top: 12px;
                right: 12px;
                width: 34px;
                height: 34px;
                font-size: 12px;
            }
            
            .nav-tabs {
                gap: 4px;
            }
            
            .nav-tab {
                height: 44px;
                font-size: 12px;
                padding: 6px 8px;
                min-width: 50px;
            }
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-header > div:last-child {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            font-weight: 600;
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            font-size: var(--font-size-md);
            line-height: var(--line-height-normal);
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            min-height: 36px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-inverse);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-success {
            background: var(--success-color);
            color: var(--text-inverse);
        }

        .btn-success:hover {
            background: var(--success-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-danger {
            background: var(--danger-color);
            color: var(--text-inverse);
        }

        .btn-danger:hover {
            background: var(--danger-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--text-inverse);
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--text-inverse);
        }

        .btn-warning:hover {
            background: var(--warning-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .form-control {
            flex: 1;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            line-height: var(--line-height-normal);
            background: var(--surface-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 40px;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .select-control {
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            background: var(--surface-color);
            color: var(--text-primary);
            line-height: var(--line-height-normal);
            min-height: 40px;
            min-width: 150px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .select-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .items-grid {
            display: grid;
            gap: var(--spacing-lg);
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            margin-bottom: var(--spacing-xl);
        }

        .item-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .item-card[draggable="true"] {
            cursor: grab;
        }

        .item-card:active {
            cursor: grabbing;
        }

        .item-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .item-card.drag-over {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .item-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .item-card.pinned {
            border-color: #f39c12;
            background: #fef9e7;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .item-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
            word-break: break-word;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .item-actions .btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        .item-content {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
            margin-bottom: 10px;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 8px;
        }

        .item-meta .category-path {
            flex: 1;
            margin-right: 10px;
        }

        .item-meta .usage-count {
            white-space: nowrap;
            align-self: center;
        }

        .item-category {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .usage-count {
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
            font-size: 14px;
        }

        .textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .regex-test {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }

        .regex-test textarea {
            width: 100%;
            min-height: 200px;
            margin-bottom: 10px;
        }

        /* 左右分栏布局 */
        .filter-test-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .filter-input-section, .filter-result-section {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 6px;
            padding: 15px;
        }

        .filter-input-section textarea, .filter-result-section textarea {
            width: 100%;
            min-height: 300px;
            margin-bottom: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        body.dark-theme .filter-input-section,
        body.dark-theme .filter-result-section {
            background: #2c5530;
            border-color: #3e7b3e;
        }

        body.dark-theme .filter-input-section textarea,
        body.dark-theme .filter-result-section textarea {
            background: #3a536b;
            color: #ecf0f1;
            border-color: #4a6741;
        }

        @media (max-width: 768px) {
            .filter-test-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        /* ===== 新的过滤器界面样式 ===== */
        
        /* 过滤器工具栏 */
        .filter-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* 新的过滤器主布局 - 三栏布局 */
        .filter-main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 20px;
            margin-top: 20px;
            align-items: start; /* 确保面板对齐到顶部 */
            min-height: 45px; /* 最小高度，确保折叠时有基本高度 */
            max-height: 65vh; /* 最大高度，防止无限拉伸 */
            /* 移除固定高度，让Grid根据内容自适应 */
        }

        /* 过滤器整体容器 - 包含主布局和测试面板 */
        .filter-layout-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 可折叠栏目通用样式 */
        .collapsible-panel {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-panel.collapsed {
            max-height: 45px;
        }

        .collapsible-header {
            background: #3498db;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
        }

        .collapsible-header:hover {
            background: #2980b9;
        }

        .collapsible-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .collapsible-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            transition: all 0.3s ease;
            max-height: calc(65vh - 45px); /* 减去header高度 */
        }

        .collapsible-content.collapsed {
            display: none;
        }

        .collapse-toggle {
            background: none;
            border: none;
            color: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.3s ease;
            padding: 2px;
        }

        .collapse-toggle.collapsed {
            transform: rotate(-90deg);
        }

        /* 左侧边栏 */
        .filter-sidebar {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            background: #3498db;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .sidebar-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .quick-actions {
            padding: 10px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .btn.btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* 分类目录树 */
        .category-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .tree-loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 14px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            margin-bottom: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            user-select: none;
            transition: all 0.2s;
        }

        .category-item:hover {
            background: #e3f2fd;
        }

        .category-item.selected {
            background: #3498db;
            color: white;
        }

        .category-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 10px;
            color: #666;
            transition: transform 0.2s;
        }

        .category-toggle.expanded {
            transform: rotate(90deg);
        }

        .category-label {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .category-count {
            background: #3498db;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .category-children {
            margin-left: 20px;
            border-left: 1px solid #e0e0e0;
            padding-left: 10px;
        }

        /* 三态复选框 */
        .tristate-checkbox {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #3498db;
            border-radius: 3px;
            background: white;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tristate-checkbox:checked {
            background: #3498db;
        }

        .tristate-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 1px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .tristate-checkbox.indeterminate {
            background: #f39c12;
        }

        .tristate-checkbox.indeterminate::after {
            content: '−';
            position: absolute;
            top: -3px;
            left: 2px;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* 中间预设管理栏目 */
        .filter-presets-panel {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .presets-panel-header {
            background: #27ae60;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .presets-panel-header:hover {
            background: #229954;
        }

        .presets-panel-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }

        .presets-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .presets-panel-content.collapsed {
            display: none;
        }

        /* 当前选择区域 */
        .current-selection {
            margin-bottom: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .current-selection-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-selection-header h5 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }

        .current-selection-content {
            padding: 10px 15px;
            max-height: 180px; /* 减少高度 */
            overflow-y: auto;
            min-height: 100px; /* 确保有最小高度 */
        }

        .selected-rule-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .selected-rule-item:last-child {
            border-bottom: none;
        }

        .selected-rule-checkbox {
            flex-shrink: 0;
        }

        .selected-rule-info {
            flex: 1;
            min-width: 0;
        }

        .selected-rule-name {
            font-size: 12px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .selected-rule-regex {
            font-size: 10px;
            color: #666;
            font-family: monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .selected-rule-remove {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .selected-rule-remove:hover {
            background: #f8d7da;
        }

        /* 预设组列表 */
        .preset-groups {
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .preset-groups-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preset-groups-header h5 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }

        .preset-groups-content {
            max-height: 250px; /* 减少高度给其他内容留空间 */
            overflow-y: auto;
            min-height: 150px; /* 确保有最小高度 */
        }

        .preset-group-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 12px 15px;
        }

        .preset-group-item:last-child {
            border-bottom: none;
        }

        .preset-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .preset-group-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        .preset-group-actions {
            display: flex;
            gap: 5px;
        }

        .preset-group-stats {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .preset-group-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preset-group-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .preset-group-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-xs {
            padding: 2px 6px;
            font-size: 10px;
            line-height: 1.2;
        }

        /* 预设操作按钮 */
        .preset-actions {
            background: #f8f9fa;
            padding: 10px 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* 规则预设（旧版样式保持兼容） */
        .filter-presets {
            border-top: 1px solid #e0e0e0;
            background: #ffffff;
        }

        .presets-header {
            padding: 10px 15px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .presets-header h5 {
            margin: 0;
            font-size: 13px;
            color: #2c3e50;
        }

        .presets-list {
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
        }

        .preset-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-bottom: 2px;
            transition: all 0.2s;
        }

        .preset-item:hover {
            background: #f0f0f0;
        }

        /* 右侧内容区 */
        .filter-content {
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 精简的标签面板 */
        .compact-tags-panel {
            border-bottom: 1px solid #e0e0e0;
        }

        .tags-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
        }

        .tags-header:hover {
            background: #e9ecef;
        }

        .tags-content {
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tags-content.collapsed {
            max-height: 0;
        }

        .tags-content #filterTagsContainer {
            padding: 10px 15px;
        }

        /* 搜索和控制区域 */
        .filter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            display: flex;
            align-items: center;
            position: relative;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .btn-clear {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .btn-clear:hover {
            background: #f0f0f0;
        }

        .filter-stats {
            color: #666;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-stats #activeFilterCount {
            color: #27ae60;
            font-weight: 600;
        }

        /* 规则列表容器 */
        .rules-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* 紧凑的规则项样式 */
        .rule-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 6px;
            background: white;
            transition: all 0.2s;
        }

        .rule-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
        }

        .rule-item.active {
            border-color: #27ae60;
            background: #f8fff8;
        }

        .rule-item.selected {
            background: #e3f2fd;
            border-color: #3498db;
        }

        .rule-checkbox {
            flex-shrink: 0;
        }

        .rule-info {
            flex: 1;
            min-width: 0;
            padding: 4px 0;
        }

        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .rule-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .rule-status {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .status-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 500;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.pinned {
            background: #fff3cd;
            color: #856404;
        }

        .rule-preview {
            font-size: 12px;
            color: #666;
            font-family: monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 6px;
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .rule-details {
            font-size: 11px;
            color: #666;
        }

        .rule-detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }

        .detail-label {
            font-weight: 500;
            min-width: 50px;
            flex-shrink: 0;
        }

        .detail-value {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .rule-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
            margin-right: 2px;
        }

        .rule-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .rule-actions .btn {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 30px;
        }

        /* 可折叠测试面板 */
        .test-panel {
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            transition: all 0.3s ease;
            position: relative; /* 确保自然流动布局 */
        }
        
        /* 测试面板的智能定位状态 */
        .test-panel.auto-positioned {
            transition: margin-top 0.4s ease; /* 平滑的位置转换动画 */
        }

        .test-panel.collapsed .test-panel-content {
            display: none;
        }

        .test-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .test-panel-header:hover {
            background: #e9ecef;
        }

        .test-panel-header h4 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .btn-toggle {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .test-panel:not(.collapsed) .btn-toggle {
            transform: rotate(180deg);
        }

        .test-panel-content {
            padding: 20px;
        }

        .test-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .test-label {
            display: block;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .test-textarea {
            width: 100%;
            height: 500px; /* 进一步增加高度 */
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            background: #fafafa;
            outline: none;
            transition: all 0.2s;
            min-height: 500px; /* 增加最小高度 */
        }

        .test-textarea:focus {
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* 选中同步的视觉增强 */
        .test-textarea::selection {
            background: #3498db;
            color: white;
        }
        
        .test-textarea::-moz-selection {
            background: #3498db;
            color: white;
        }
        
        /* 同步选中时的边框提示 */
        .test-textarea.syncing-selection {
            border-color: #27ae60;
            box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.3);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .test-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* 新样式的移动端适配 */
        @media (max-width: 768px) {
            .filter-layout-wrapper {
                gap: 15px;
            }
            
            .filter-main-layout {
                grid-template-columns: 1fr;
                gap: 15px;
                height: auto; /* 移动端允许自动高度 */
            }
            
            .filter-sidebar {
                order: 3;
                max-height: 300px;
            }

            .filter-presets-panel {
                order: 2;
                max-height: 400px;
            }
            
            .filter-content {
                order: 1;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .test-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .test-textarea {
                height: 300px; /* 移动端也增加高度 */
                min-height: 300px;
            }

            .filter-toolbar {
                justify-content: center;
            }

            .current-selection-content {
                max-height: 150px;
            }

            .preset-groups-content {
                max-height: 200px;
            }
        }

        .regex-result {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 60px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 9999;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background: #e74c3c;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 60px 40px;
            color: #7f8c8d;
            min-height: 200px;
            grid-column: 1 / -1; /* 占满整个网格 */
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
            line-height: 1;
        }

        .empty-state p {
            margin: 0;
            font-size: 16px;
            line-height: 1.5;
            max-width: 400px;
        }

        body.dark-theme .empty-state {
            color: #adb5bd;
        }

        /* 暗色主题 */
        body.dark-theme {
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        body.dark-theme .header,
        body.dark-theme .tab-content,
        body.dark-theme .modal-content {
            background: #34495e;
            color: #ecf0f1;
        }

        body.dark-theme .nav-tab {
            background: #34495e;
            border-color: #4a6741;
            color: #ecf0f1;
        }

        body.dark-theme .nav-tab.active {
            background: #3498db;
            color: white;
        }

        body.dark-theme .item-card {
            background: #3a536b;
            border-color: #4a6741;
            color: #ecf0f1;
        }

        body.dark-theme .item-card.pinned {
            background: #8b7355;
            border-color: #f39c12;
        }
        
        body.dark-theme .item-card.filter-active {
            border-color: #27ae60;
            background: #2d5a3d;
        }
        
        .item-card.filter-active {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        body.dark-theme .form-control,
        body.dark-theme .select-control,
        body.dark-theme .textarea {
            background: #3a536b;
            border-color: #4a6741;
            color: #ecf0f1;
        }
        
        body.dark-theme input[type="file"] {
            background: #3a536b !important;
            border-color: #4a6741 !important;
            color: #ecf0f1 !important;
        }
        
        body.dark-theme input[type="file"]::-webkit-file-upload-button {
            background: #2980b9;
            color: white;
        }

        body.dark-theme .filter-section {
            background: #3a536b;
            border-color: #4a6741;
        }

        body.dark-theme .regex-test {
            background: #2c5530;
            border-color: #3e7b3e;
        }

        body.dark-theme .regex-result {
            background: #3a536b;
            color: #ecf0f1;
            border-color: #4a6741;
        }

        /* 批量选择样式 */
        .batch-mode .item-card {
            position: relative;
            padding-left: 35px;
        }

        .batch-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            transform: scale(1.2);
            cursor: pointer;
        }
        
        .batch-mode .item-card.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        body.dark-theme .batch-mode .item-card.selected {
            background: #1e3a5f;
            border-color: #42a5f5;
        }

        body.dark-theme .btn-warning {
            background: #e67e22;
            color: white;
        }

        body.dark-theme .btn-warning:hover {
            background: #d35400;
        }

        .batch-actions {
            background: #3498db;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .batch-actions.active {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .batch-count {
            font-weight: 600;
        }

        .batch-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* 拖拽指示器 */
        .drag-handle {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: grab;
            opacity: 0.3;
            font-size: 12px;
            color: #666;
            z-index: 5;
            pointer-events: none;
        }

        .item-card:hover .drag-handle {
            opacity: 1;
        }
        
        .item-card[draggable="true"] .drag-handle {
            pointer-events: auto;
        }
        
        body.dark-theme .drag-handle {
            color: #bbb;
        }

        /* 主题切换按钮 */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.9);
            color: #666;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            flex-shrink: 0;
            position: absolute;
            top: 20px;
            right: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(52, 152, 219, 0.3);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: scale(1.05);
            color: #3498db;
        }

        .theme-toggle:active {
            transform: scale(0.98);
        }

        /* 暗色主题下的按钮样式 */
        body.dark-theme .theme-toggle {
            background: rgba(44, 62, 80, 0.9);
            color: #ecf0f1;
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.dark-theme .theme-toggle:hover {
            background: rgba(52, 73, 94, 0.95);
            border-color: rgba(52, 152, 219, 0.3);
            color: #5dade2;
        }

        /* 快捷键提示面板 */
        .shortcuts-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 250px;
            max-width: 300px;
            z-index: 999; /* 降低z-index避免遮挡 */
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            pointer-events: none;
            visibility: hidden; /* 隐藏时完全不可见 */
        }

        .shortcuts-panel.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }
        
        /* 当快捷键面板显示时，确保不会意外遮挡其他内容 */
        .shortcuts-panel:not(.show) {
            display: none; /* 完全隐藏未显示的面板 */
        }

        .shortcuts-panel-header {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shortcuts-panel-header h4 {
            margin: 0;
            font-size: 14px;
            color: #2c3e50;
        }

        .shortcuts-panel-content {
            padding: 12px 15px;
            font-size: 12px;
            color: #555;
        }

        .shortcuts-panel-content div {
            margin: 6px 0;
            padding: 3px 0;
        }

        .shortcuts-panel-content strong {
            color: #3498db;
            font-weight: 600;
        }

        /* 暗色主题支持 */
        body.dark-theme .shortcuts-panel {
            background: #34495e;
            border-color: #4a6741;
        }

        body.dark-theme .shortcuts-panel-header {
            background: #2c3e50;
            border-bottom-color: #4a6741;
        }

        body.dark-theme .shortcuts-panel-header h4 {
            color: #ecf0f1;
        }

        body.dark-theme .shortcuts-panel-content {
            color: #bdc3c7;
        }

        body.dark-theme .shortcuts-panel-content strong {
            color: #5dade2;
        }

        /* 标签系统样式 */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .tag {
            display: inline-block;
            background: linear-gradient(135deg, #e1f5fe 0%, #f3e5f5 100%);
            color: #0277bd;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            border: 1px solid #b3e5fc;
            font-weight: 500;
            margin: 2px;
        }

        body.dark-theme .tag {
            background: linear-gradient(135deg, #263238 0%, #37474f 100%);
            color: #4fc3f7;
            border-color: #37474f;
        }

        .tag.clickable {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .tag.clickable::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .tag.clickable:hover {
            background: linear-gradient(135deg, #b3e5fc 0%, #e1bee7 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(2, 119, 189, 0.3);
        }

        .tag.clickable:hover::before {
            left: 100%;
        }

        body.dark-theme .tag.clickable:hover {
            background: linear-gradient(135deg, #37474f 0%, #455a64 100%);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.2);
        }

        .tag.clickable:active {
            transform: translateY(0) scale(0.98);
        }

        .tags-suggestions {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        .tag-suggestion {
            display: inline-block;
            background: #f5f5f5;
            color: #666;
            padding: 2px 6px;
            border-radius: 8px;
            margin: 2px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: all 0.2s;
        }

        .tag-suggestion:hover {
            background: #e0e0e0;
            color: #333;
        }

        body.dark-theme .tag-suggestion {
            background: #424242;
            color: #bbb;
            border-color: #555;
        }

        body.dark-theme .tag-suggestion:hover {
            background: #555;
            color: #fff;
        }

        /* 全局标签面板 */
        .global-tags-panel {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .global-tags-panel:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }

        body.dark-theme .global-tags-panel {
            background: #34495e;
            border-color: #4a6741;
        }

        body.dark-theme .global-tags-panel:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

        .global-tags-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 16px;
            user-select: none;
        }

        body.dark-theme .global-tags-title {
            color: #ecf0f1;
        }

        .tags-toggle {
            background: rgba(52, 152, 219, 0.1);
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 16px;
            padding: 6px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .tags-toggle:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: scale(1.1);
        }

        body.dark-theme .tags-toggle {
            background: rgba(52, 152, 219, 0.15);
            color: #5dade2;
        }

        body.dark-theme .tags-toggle:hover {
            background: rgba(52, 152, 219, 0.25);
        }

        .global-tags-content {
            max-height: 120px;
            overflow-y: auto;
            transition: all 0.3s ease;
            padding: 2px;
        }

        .global-tags-content::-webkit-scrollbar {
            width: 6px;
        }

        .global-tags-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .global-tags-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .global-tags-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .global-tags-content.collapsed {
            max-height: 0;
            overflow: hidden;
            padding: 0 2px;
        }

        /* 折叠组样式 */
        .collapsible-group {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        body.dark-theme .collapsible-group {
            border-color: #4a6741;
        }

        .group-header {
            background: #f8f9fa;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        body.dark-theme .group-header {
            background: #3a536b;
        }

        .group-header:hover {
            background: #e9ecef;
        }

        body.dark-theme .group-header:hover {
            background: #4a6741;
        }

        .group-title {
            font-weight: 600;
            color: #2c3e50;
        }

        body.dark-theme .group-title {
            color: #ecf0f1;
        }

        .group-toggle {
            background: none;
            border: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .group-toggle.expanded {
            transform: rotate(90deg);
        }

        .group-content {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }

        body.dark-theme .group-content {
            border-top-color: #4a6741;
        }

        .group-content.collapsed {
            display: none;
        }

        .group-items {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        /* 分类面包屑导航样式 */
        .category-breadcrumb {
            display: inline-block;
            background: #f8f9fa;
            color: #495057;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin: 0 2px;
            cursor: pointer;
            border: 1px solid #dee2e6;
            transition: all 0.2s;
        }

        .category-breadcrumb:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }

        body.dark-theme .category-breadcrumb {
            background: #495057;
            color: #f8f9fa;
            border-color: #6c757d;
        }

        body.dark-theme .category-breadcrumb:hover {
            background: #6c757d;
        }

        .category-breadcrumb-separator {
            color: #6c757d;
            margin: 0 4px;
            font-size: 10px;
        }

        .category-path {
            margin-top: 5px;
            font-size: 12px;
            color: #6c757d;
        }

        body.dark-theme .category-path {
            color: #adb5bd;
        }

        /* 导出对话框样式 */
        .export-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease-out;
        }

        .export-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease-out;
        }

        .export-dialog h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .export-dialog p {
            margin: 0 0 20px 0;
            color: #6c757d;
            font-size: 14px;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .export-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .export-option:hover {
            border-color: #3498db;
            background: #f8f9ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
        }

        .option-icon {
            font-size: 24px;
            margin-right: 16px;
            min-width: 32px;
        }

        .option-content {
            flex: 1;
        }

        .option-content strong {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .option-content small {
            color: #6c757d;
            font-size: 13px;
            line-height: 1.4;
        }

        .export-dialog-buttons {
            display: flex;
            justify-content: flex-end;
        }

        /* 暗色主题的导出对话框 */
        body.dark-theme .export-dialog {
            background: #34495e;
            color: #ecf0f1;
        }

        body.dark-theme .export-dialog h3 {
            color: #ecf0f1;
        }

        body.dark-theme .export-dialog p {
            color: #bdc3c7;
        }

        body.dark-theme .export-option {
            background: #3a536b;
            border-color: #4a6741;
            color: #ecf0f1;
        }

        body.dark-theme .export-option:hover {
            border-color: #5dade2;
            background: #4a6741;
        }

        body.dark-theme .option-content strong {
            color: #ecf0f1;
        }

        body.dark-theme .option-content small {
            color: #bdc3c7;
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 批量导入工具样式 */
        .batch-import-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }
        
        /* 验证结果模态框样式 */
        .validation-result-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000; /* 确保在批量导入模态框之上 */
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .validation-result-modal.show {
            opacity: 1;
        }
        
        .validation-result-modal.hide {
            opacity: 0;
        }
        
        .validation-result-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .validation-result-modal.show .validation-result-content {
            transform: translateY(0);
        }
        
        .validation-result-content.success {
            border-top: 4px solid var(--success-color);
        }
        
        .validation-result-content.warning {
            border-top: 4px solid var(--warning-color);
        }
        
        .validation-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .validation-result-header h3 {
            margin: 0;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .close-validation-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .close-validation-btn:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .validation-result-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .validation-result-body pre {
            white-space: pre-wrap;
            font-family: inherit;
            margin: 0;
            line-height: 1.6;
            color: #333;
        }
        
        .validation-result-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
        }
        
        /* 验证模态框的暗色主题 */
        body.dark-theme .validation-result-content {
            background: #34495e;
            color: #ecf0f1;
        }
        
        body.dark-theme .validation-result-header {
            border-bottom-color: #4a6741;
        }
        
        body.dark-theme .validation-result-header h3 {
            color: #ecf0f1;
        }
        
        body.dark-theme .validation-result-body pre {
            color: #ecf0f1;
        }
        
        body.dark-theme .validation-result-footer {
            border-top-color: #4a6741;
        }
        
        body.dark-theme .close-validation-btn {
            color: #bbb;
        }
        
        body.dark-theme .close-validation-btn:hover {
            background: #4a6741;
            color: #ecf0f1;
        }

        .batch-import-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .batch-import-container {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .batch-import-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .batch-import-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .batch-import-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .batch-import-close:hover {
            background: #e0e0e0;
        }

        .batch-import-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            height: calc(90vh - 80px);
            overflow: hidden;
        }

        @media (max-width: 968px) {
            .batch-import-content {
                grid-template-columns: 1fr;
                overflow-y: auto;
            }
        }

        .batch-input-panel, .batch-preview-panel {
            padding: 25px;
            overflow-y: auto;
        }

        .batch-input-panel {
            border-right: 1px solid #e0e0e0;
        }

        .batch-panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .batch-input-method {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .batch-method-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px 12px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            text-align: center;
        }

        .batch-method-btn:hover {
            background: #e9ecef;
        }

        .batch-method-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: #2980b9;
        }

        .batch-input-area {
            display: none;
        }

        .batch-input-area.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .batch-text-input {
            width: 100%;
            min-height: 280px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
        }

        .batch-text-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .batch-example-box {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .batch-example-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .batch-example-content {
            color: #666;
            line-height: 1.5;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .batch-file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .batch-file-upload-area:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }

        .batch-file-upload-area.dragover {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        .batch-upload-icon {
            font-size: 36px;
            margin-bottom: 8px;
            color: #95a5a6;
        }

        .batch-upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .batch-upload-hint {
            color: #999;
            font-size: 12px;
        }

        .batch-template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .batch-template-card {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
        }

        .batch-template-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .batch-template-card.selected {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }

        .batch-template-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .batch-template-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .batch-template-desc {
            font-size: 11px;
            color: #666;
            line-height: 1.3;
        }

        .batch-stats-bar {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .batch-stat-item {
            flex: 1;
            text-align: center;
        }

        .batch-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .batch-stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }

        .batch-preview-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            background: #fafafa;
        }

        .batch-preview-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
            font-size: 13px;
        }

        .batch-preview-item.error {
            border-left-color: #e74c3c;
            background: #ffebee;
        }

        .batch-preview-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .batch-preview-content {
            color: #666;
            font-size: 12px;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .batch-preview-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: #999;
            flex-wrap: wrap;
        }

        .batch-preview-tag {
            display: inline-block;
            padding: 2px 6px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 10px;
            font-size: 10px;
            margin-right: 3px;
        }

        .batch-alert {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .batch-alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .batch-progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin: 12px 0;
        }

        .batch-progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s;
            border-radius: 2px;
        }

        /* 暗色主题支持 */
        body.dark-theme .batch-import-container {
            background: #34495e;
            color: #ecf0f1;
        }

        body.dark-theme .batch-import-header {
            border-bottom-color: #4a6741;
        }

        body.dark-theme .batch-import-header h2 {
            color: #ecf0f1;
        }

        body.dark-theme .batch-import-close {
            background: #4a6741;
            color: #ecf0f1;
        }

        body.dark-theme .batch-input-panel {
            border-right-color: #4a6741;
        }

        body.dark-theme .batch-panel-title {
            color: #ecf0f1;
        }

        body.dark-theme .batch-method-btn {
            background: #3a536b;
            color: #ecf0f1;
            border-color: #4a6741;
        }

        body.dark-theme .batch-method-btn:hover {
            background: #4a6741;
        }
        
        body.dark-theme .batch-method-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
        }

        body.dark-theme .batch-text-input {
            background: #3a536b;
            border-color: #4a6741;
            color: #ecf0f1;
        }

        body.dark-theme .batch-example-box {
            background: #2c5530;
            border-left-color: #3498db;
        }

        body.dark-theme .batch-example-title {
            color: #ecf0f1;
        }

        body.dark-theme .batch-example-content {
            color: #bdc3c7;
        }

        body.dark-theme .batch-file-upload-area {
            background: #3a536b;
            border-color: #4a6741;
            color: #ecf0f1;
        }

        body.dark-theme .batch-template-card {
            background: #3a536b;
            border-color: #4a6741;
            color: #ecf0f1;
        }

        body.dark-theme .batch-stats-bar {
            background: #3a536b;
        }

        body.dark-theme .batch-preview-container {
            background: #2c5530;
            border-color: #4a6741;
        }

        body.dark-theme .batch-preview-item {
            background: #3a536b;
            color: #ecf0f1;
        }

        /* 现有数据项样式 */
        .existing-data-item {
            padding: 8px;
            margin-bottom: 6px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .existing-data-item:hover {
            border-color: var(--primary-color);
            background: #f8f9ff;
        }

        .existing-data-item.selected {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }

        .existing-data-item input[type="checkbox"] {
            margin: 0;
        }

        /* 暗色主题的现有数据项 */
        body.dark-theme .existing-data-item {
            background: #3a536b;
            border-color: #4a6741;
            color: #ecf0f1;
        }

        body.dark-theme .existing-data-item:hover {
            border-color: #5dade2;
            background: #4a6741;
        }

        body.dark-theme .existing-data-item.selected {
            border-color: #5dade2;
            background: #2c5530;
        }

        /* 平板端适配 */
        @media (max-width: 1024px) {
            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: var(--spacing-md);
            }
            
            .container {
                padding: var(--spacing-lg);
            }
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .input-group {
                flex-direction: row;
                gap: 8px;
                flex-wrap: nowrap;
            }
            
            .input-group .form-control {
                flex: 2;
                min-width: 0;
            }
            
            .input-group .select-control {
                flex: 1;
                min-width: 0;
            }
            
            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
            }
            
            .item-card {
                padding: 12px;
            }
            
            .item-title {
                font-size: 15px;
                line-height: 1.2;
            }
            
            .item-content {
                font-size: 13px;
                line-height: 1.3;
                max-height: 75px;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 4;
                -webkit-box-orient: vertical;
            }
            
            .item-actions .btn {
                padding: 6px 8px;
                font-size: 13px;
                min-height: 32px;
            }
            
            .item-meta {
                font-size: 11px;
            }
            
            .tags-container .tag {
                font-size: 11px;
                padding: 3px 8px;
            }
            
            .section-header {
                flex-direction: row;
                gap: 10px;
                align-items: center;
                text-align: left;
            }
            
            .section-title {
                font-size: 1.2em;
                flex-shrink: 0;
                min-width: fit-content;
            }
            
            .section-header > div:last-child {
                justify-content: flex-end;
                flex-wrap: wrap;
                gap: 6px;
                flex: 1;
            }
            
            .section-header > div:last-child .btn {
                padding: 8px 10px;
                font-size: 12px;
                white-space: nowrap;
            }
            
            .empty-state {
                padding: 40px 20px;
                min-height: 150px;
            }
            
            .empty-state-icon {
                font-size: 48px;
            }
            
            /* 移动端按钮优化 */
            .btn {
                padding: 12px 16px;
                min-height: 44px;
                font-size: 14px;
                touch-action: manipulation;
            }
            
            .item-actions .btn {
                padding: 8px 12px;
                min-height: 36px;
                font-size: 16px;
            }
            
            /* 模态框移动端优化 */
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px;
                max-height: 90vh;
            }
            
            /* 表单控件移动端优化 */
            .form-control, .select-control, .textarea {
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
                border-radius: 8px;
                -webkit-appearance: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            .textarea {
                min-height: 120px;
                resize: vertical;
            }
            
            /* 文件输入框移动端优化 */
            input[type="file"] {
                padding: 8px !important;
                font-size: 14px !important;
                min-height: 44px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                background: white;
                width: 100%;
                box-sizing: border-box;
                word-break: break-all;
                overflow-wrap: break-word;
            }
            
            input[type="file"]::-webkit-file-upload-button {
                padding: 8px 12px;
                margin-right: 8px;
                border: none;
                border-radius: 4px;
                background: #3498db;
                color: white;
                font-size: 14px;
                cursor: pointer;
            }
            
            /* 标签面板移动端优化 */
            .global-tags-panel {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .global-tags-title {
                font-size: 14px;
            }
            
            .tags-toggle {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            .tag {
                padding: 6px 12px;
                font-size: 12px;
                margin: 3px;
                border-radius: 18px;
                min-height: 32px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                touch-action: manipulation;
            }
            
            .tag.clickable {
                min-height: 36px;
            }
            
            /* 批量操作移动端优化 */
            .batch-actions {
                padding: 12px;
                border-radius: 8px;
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .batch-buttons {
                justify-content: space-between;
                flex-wrap: wrap;
            }
            
            .batch-buttons .btn {
                flex: 1;
                min-width: 80px;
                margin: 2px;
            }
            
            /* 项目卡片移动端优化 */
            .item-card {
                padding: 12px;
                border-radius: 10px;
                touch-action: manipulation;
            }
            
            .item-header {
                margin-bottom: 8px;
            }
            
            .item-title {
                font-size: 16px;
                line-height: 1.3;
            }
            
            .item-content {
                font-size: 14px;
                line-height: 1.4;
                margin-bottom: 8px;
            }
            
            /* 拖拽句柄移动端隐藏 */
            .drag-handle {
                display: none;
            }
            
            /* 主题切换按钮移动端优化 - 已迁移到具体的媒体查询中 */
            
            /* 快捷键面板移动端优化 */
            .shortcuts-panel {
                bottom: 15px;
                right: 15px;
                left: 15px;
                max-width: none;
                min-width: auto;
            }
            
            .shortcuts-panel-header {
                padding: 10px 12px;
            }
            
            .shortcuts-panel-header h4 {
                font-size: 13px;
            }
            
            .shortcuts-panel-content {
                padding: 10px 12px;
                font-size: 11px;
            }
            
            .shortcuts-panel-content div {
                margin: 4px 0;
                padding: 2px 0;
            }
            
            /* 滚动条移动端优化 */
            .global-tags-content::-webkit-scrollbar {
                width: 4px;
            }
            
            /* 分类面包屑移动端优化 */
            .category-breadcrumb {
                font-size: 10px;
                padding: 3px 6px;
                margin: 1px;
                border-radius: 3px;
            }
            
            /* 过滤器组移动端优化 */
            .checkbox-group {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .checkbox-item {
                padding: 8px;
                background: rgba(0,0,0,0.05);
                border-radius: 6px;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .checkbox-item input[type="checkbox"] {
                transform: scale(1.3);
                margin-right: 12px;
            }
            
            .checkbox-item label {
                font-size: 14px;
                line-height: 1.3;
                cursor: pointer;
                flex: 1;
            }
            
            /* Toast通知移动端优化 */
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
                border-radius: 8px;
                font-size: 14px;
                padding: 12px 16px;
                transform: translateY(-100%);
            }
            
            .toast.show {
                transform: translateY(0);
            }
        }
        
        /* 高DPI设备优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .tag.clickable:hover {
                transform: translateY(-1px) scale(1.02);
            }
            
            .item-card:hover {
                transform: translateY(-1px);
            }
        }
        
        /* 鼠标位置修复 */
        @media (pointer: fine) {
            /* 桌面端：正常的hover效果 */
            .btn:hover {
                transform: translateY(-1px);
            }
            
            .item-card:hover {
                transform: translateY(-2px);
            }
        }
        
        @media (pointer: coarse) {
            /* 移动端：减少transform效果 */
            .btn:hover, .btn:active {
                transform: none;
            }
            
            .item-card:hover, .item-card:active {
                transform: none;
            }
            
            .tag.clickable:hover, .tag.clickable:active {
                transform: none;
            }
        }
        
        /* 横屏模式优化 */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-content {
                max-height: 85vh;
            }
            
            /* 旧的复杂规则已删除，使用简单inline-block布局 */
        }
        
        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }
            
            .global-tags-panel {
                padding: 10px;
                margin-bottom: 12px;
            }
            
            .section-header {
                gap: 8px;
            }
            
            .section-title {
                font-size: 1.1em;
            }
            
            .section-header > div:last-child {
                flex-direction: row;
                gap: 4px;
            }
            
            .section-header > div:last-child .btn {
                padding: 6px 8px;
                font-size: 11px;
                min-height: 32px;
            }
            
            .input-group {
                gap: 6px;
            }
            
            .input-group .form-control {
                flex: 2;
                font-size: 14px;
            }
            
            .input-group .select-control {
                flex: 1;
                font-size: 12px;
            }
            
            .items-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 8px;
            }
            
            .item-card {
                padding: 10px;
            }
            
            .item-title {
                font-size: 14px;
                line-height: 1.2;
            }
            
            .item-content {
                font-size: 12px;
                line-height: 1.3;
                max-height: 60px;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
            }
            
            .item-actions .btn {
                padding: 4px 6px;
                font-size: 12px;
                min-height: 28px;
            }
            
            .item-meta {
                font-size: 10px;
            }
            
            .tags-container .tag {
                font-size: 10px;
                padding: 2px 6px;
            }
            
            .modal-content {
                width: 98%;
                margin: 5px;
            }
            
            .item-actions {
                flex-direction: row;
                gap: 6px;
                justify-content: flex-end;
                flex-wrap: nowrap;
            }
            
            .item-actions .btn {
                flex: 0 0 auto;
                padding: 8px 10px;
                font-size: 14px;
                min-height: 36px;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>🚀 提示词管理工具</h1>
                <p>高效管理您的提示词、网站收藏和隐私过滤规则</p>
            </div>
            <!-- 主题切换按钮 -->
            <button class="theme-toggle" onclick="toggleTheme()" title="切换主题">🌙</button>
        </div>

        <!-- 快捷键提示面板 -->
        <div class="shortcuts-panel collapsible-panel" id="shortcutsPanel">
            <div class="shortcuts-panel-header collapsible-header" onclick="togglePanel('shortcuts')">
                <h4>⌨️ 快捷键</h4>
                <button class="collapse-toggle" id="shortcutsToggle">▼</button>
            </div>
            
            <div class="shortcuts-panel-content collapsible-content" id="shortcutsContent">
                <div><strong>Ctrl+N:</strong> 添加新项目</div>
                <div><strong>Ctrl+S:</strong> 导出数据</div>
                <div><strong>Ctrl+B:</strong> 批量操作</div>
                <div><strong>Esc:</strong> 关闭模态框</div>
                <div><strong>?:</strong> 显示/隐藏此提示</div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="prompts">📝 提示词管理</div>
            <div class="nav-tab" data-tab="websites">🌐 网站收藏</div>
            <div class="nav-tab" data-tab="privacy">🔒 隐私过滤</div>
            <div class="nav-tab" data-tab="settings">⚙️ 设置</div>
        </div>


        <!-- 提示词管理 -->
        <div id="prompts" class="tab-content active">
            <div class="section-header">
                <div class="section-title">提示词管理</div>
                <div>
                    <button class="btn btn-primary" onclick="toggleBatchMode('prompts')" id="batchModePrompts">📋 批量操作</button>
                    <button class="btn btn-success" onclick="openModal('addPromptModal')">➕ 添加提示词</button>
                    <button class="btn btn-secondary" onclick="importModuleData('prompts')">📤 导入</button>
                    <button class="btn btn-secondary" onclick="exportData('prompts')">📥 导出</button>
                </div>
            </div>
            
            <!-- 提示词标签面板 -->
            <div class="global-tags-panel" id="promptTagsPanel">
                <div class="global-tags-title">
                    🏷️ 提示词标签
                    <button class="tags-toggle" onclick="toggleFunctionTags('prompts')" id="promptTagsToggle">▼</button>
                </div>
                <div class="global-tags-content" id="promptTagsContent">
                    <div id="promptTagsContainer">正在加载标签...</div>
                </div>
            </div>

            <!-- 批量操作栏 -->
            <div class="batch-actions" id="batchActionsPrompts">
                <div class="batch-count">
                    已选择 <span id="selectedCountPrompts">0</span> 项
                </div>
                <div class="batch-buttons">
                    <button class="btn btn-secondary" onclick="selectAllItems('prompts')">全选</button>
                    <button class="btn btn-secondary" onclick="clearSelection('prompts')">清空选择</button>
                    <button class="btn btn-primary" onclick="batchPin('prompts')">批量置顶</button>
                    <button class="btn btn-danger" onclick="batchDelete('prompts')">批量删除</button>
                </div>
            </div>

            <div class="input-group">
                <input type="text" class="form-control" id="promptSearch" placeholder="搜索提示词..." oninput="filterItems('prompts')">
                <select class="select-control" id="promptCategory" onchange="filterItems('prompts')">
                    <option value="">所有分类</option>
                </select>
                <select class="select-control" id="promptSort" onchange="sortItems('prompts')">
                    <option value="usage">按使用频率</option>
                    <option value="name">按名称</option>
                    <option value="date">按时间</option>
                </select>
            </div>

            <div id="promptsContainer" class="items-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">📝</div>
                    <p>还没有提示词，点击上方按钮添加第一个提示词吧！</p>
                </div>
            </div>
        </div>

        <!-- 网站收藏 -->
        <div id="websites" class="tab-content">
            <div class="section-header">
                <div class="section-title">网站收藏</div>
                <div>
                    <button class="btn btn-primary" onclick="toggleBatchMode('websites')" id="batchModeWebsites">📋 批量操作</button>
                    <button class="btn btn-success" onclick="openModal('addWebsiteModal')">➕ 添加网站</button>
                    <button class="btn btn-secondary" onclick="importModuleData('websites')">📤 导入</button>
                    <button class="btn btn-secondary" onclick="exportData('websites')">📥 导出</button>
                </div>
            </div>
            
            <!-- 网站标签面板 -->
            <div class="global-tags-panel" id="websiteTagsPanel">
                <div class="global-tags-title">
                    🏷️ 网站标签
                    <button class="tags-toggle" onclick="toggleFunctionTags('websites')" id="websiteTagsToggle">▼</button>
                </div>
                <div class="global-tags-content" id="websiteTagsContent">
                    <div id="websiteTagsContainer">正在加载标签...</div>
                </div>
            </div>

            <!-- 批量操作栏 -->
            <div class="batch-actions" id="batchActionsWebsites">
                <div class="batch-count">
                    已选择 <span id="selectedCountWebsites">0</span> 项
                </div>
                <div class="batch-buttons">
                    <button class="btn btn-secondary" onclick="selectAllItems('websites')">全选</button>
                    <button class="btn btn-secondary" onclick="clearSelection('websites')">清空选择</button>
                    <button class="btn btn-primary" onclick="batchPin('websites')">批量置顶</button>
                    <button class="btn btn-danger" onclick="batchDelete('websites')">批量删除</button>
                </div>
            </div>

            <div class="input-group">
                <input type="text" class="form-control" id="websiteSearch" placeholder="搜索网站..." oninput="filterItems('websites')">
                <select class="select-control" id="websiteCategory" onchange="filterItems('websites')">
                    <option value="">所有分类</option>
                </select>
                <select class="select-control" id="websiteSort" onchange="sortItems('websites')">
                    <option value="usage">按使用频率</option>
                    <option value="name">按名称</option>
                    <option value="date">按时间</option>
                </select>
            </div>

            <div id="websitesContainer" class="items-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">🌐</div>
                    <p>还没有收藏网站，点击上方按钮添加第一个网站吧！</p>
                </div>
            </div>
        </div>

        <!-- 隐私过滤 -->
        <div id="privacy" class="tab-content">
            <div class="section-header">
                <div class="section-title">隐私过滤器</div>
                <div class="filter-toolbar">
                    <button class="btn btn-success" onclick="openModal('addFilterModal')">➕ 添加规则</button>
                    <button class="btn btn-primary" onclick="toggleTestPanel()">🧪 测试面板</button>
                    <button class="btn btn-secondary" onclick="importModuleData('filters')">📤 导入</button>
                    <button class="btn btn-secondary" onclick="exportData('filters')">📥 导出</button>
                    <button class="btn btn-warning" onclick="enableSelectedFilters()" id="enableFiltersBtn" style="display:none;">🔓 启用选中规则</button>
                    <button class="btn btn-secondary" onclick="disableSelectedFilters()" id="disableFiltersBtn" style="display:none;">🔒 停用选中规则</button>
                    <button class="btn btn-primary" onclick="testSelectedFilters()" id="testFiltersBtn" style="display:none;">🧪 测试选中规则</button>
                </div>
            </div>

            <!-- 过滤器布局容器 -->
            <div class="filter-layout-wrapper">
                <!-- 新的三栏布局 -->
                <div class="filter-main-layout">
                <!-- 左侧：分类目录树 -->
                <div class="filter-sidebar collapsible-panel" id="categoriesPanel">
                    <div class="collapsible-header" onclick="togglePanel('categories')">
                        <h4>📁 规则分类</h4>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="sidebar-actions">
                                <button class="btn-icon" onclick="event.stopPropagation(); expandAllCategories()" title="展开全部">📂</button>
                                <button class="btn-icon" onclick="event.stopPropagation(); collapseAllCategories()" title="折叠全部">📁</button>
                            </div>
                            <button class="collapse-toggle" id="categoriesToggle">▼</button>
                        </div>
                    </div>
                    
                    <div class="collapsible-content" id="categoriesContent">
                        <!-- 快速操作按钮 -->
                        <div class="quick-actions">
                            <button class="btn btn-sm btn-primary" onclick="selectAllFilters()">全选</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearAllFilters()">清空</button>
                        </div>
                        
                        <!-- 分类目录树 -->
                        <div class="category-tree" id="filterCategoryTree">
                            <div class="tree-loading">正在加载分类...</div>
                        </div>
                    </div>
                </div>

                <!-- 中间：规则列表和内容 -->
                <div class="filter-content collapsible-panel" id="rulesPanel">
                    <div class="collapsible-header" onclick="togglePanel('rules')">
                        <h4>📋 规则详情</h4>
                        <button class="collapse-toggle" id="rulesToggle">▼</button>
                    </div>
                    
                    <div class="collapsible-content" id="rulesContent">
                        <!-- 过滤器标签面板（精简版） -->
                        <div class="compact-tags-panel" id="filterTagsPanel">
                            <div class="tags-header">
                                <span>🏷️ 标签筛选</span>
                                <button class="btn-icon" onclick="toggleFunctionTags('filters')" id="filterTagsToggle">▼</button>
                            </div>
                            <div class="tags-content collapsed" id="filterTagsContent">
                                <div id="filterTagsContainer">正在加载标签...</div>
                            </div>
                        </div>

                        <!-- 搜索和筛选 -->
                        <div class="filter-controls">
                            <div class="search-box">
                                <input type="text" class="search-input" id="filterSearch" placeholder="🔍 搜索规则..." oninput="searchFilters()">
                                <button class="btn-clear" onclick="clearFilterSearch()" id="clearSearchBtn" style="display:none;">❌</button>
                            </div>
                            <div class="filter-stats" id="filterStats">
                                <span id="activeFilterCount">0</span> / <span id="totalFilterCount">0</span> 规则激活
                            </div>
                        </div>

                        <!-- 规则列表 -->
                        <div class="rules-container" id="filtersContainer">
                            <div class="empty-state">
                                <div class="empty-state-icon">🔒</div>
                                <p>还没有过滤规则，点击上方按钮添加第一个规则吧！</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧：预设管理 -->
                <div class="filter-presets-panel collapsible-panel" id="presetsPanel">
                    <div class="presets-panel-header collapsible-header" onclick="togglePanel('presets')">
                        <h4>⭐ 预设管理</h4>
                        <button class="collapse-toggle" id="presetsToggle">▼</button>
                    </div>
                    
                    <div class="presets-panel-content collapsible-content" id="presetsContent">
                        <!-- 当前选择区域 -->
                        <div class="current-selection">
                            <div class="current-selection-header">
                                <h5>当前选择 (<span id="currentSelectionCount">0</span>)</h5>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn-icon" onclick="enableAllSelected()" title="全部启用">🔓</button>
                                    <button class="btn-icon" onclick="disableAllSelected()" title="全部停用">🔒</button>
                                    <button class="btn-icon" onclick="clearCurrentSelection()" title="清空选择">🗑️</button>
                                </div>
                            </div>
                            <div class="current-selection-content" id="currentSelectionContent">
                                <div style="text-align: center; color: #666; padding: 20px; font-size: 13px;">
                                    暂无选择的规则<br>
                                    <small>从中间规则列表中选择规则</small>
                                </div>
                            </div>
                        </div>

                        <!-- 预设组列表 -->
                        <div class="preset-groups">
                            <div class="preset-groups-header">
                                <h5>预设组</h5>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn-icon" onclick="saveAsNewPreset()" title="保存为新预设">💾</button>
                                    <button class="btn-icon" onclick="showPresetImportDialog()" title="导入预设">📥</button>
                                    <button class="btn-icon" onclick="showPresetExportDialog()" title="导出预设">📤</button>
                                </div>
                            </div>
                            <div class="preset-groups-content" id="presetGroupsContent">
                                <div style="text-align: center; color: #666; padding: 20px; font-size: 13px;">
                                    暂无预设组<br>
                                    <small>选择规则后点击💾保存</small>
                                </div>
                            </div>
                        </div>

                        <!-- 预设操作按钮 -->
                        <div class="preset-actions">
                            <button class="btn btn-sm btn-success" onclick="enableSelectedPresets()">🔓 启用选中预设</button>
                            <button class="btn btn-sm btn-secondary" onclick="disableSelectedPresets()">🔒 停用选中预设</button>
                            <button class="btn btn-sm btn-primary" onclick="testSelectedPresets()">🧪 测试选中预设</button>
                        </div>
                    </div>
                </div>
            </div>
                
                <!-- 可折叠的测试面板 -->
                <div class="test-panel collapsed" id="testPanel">
                    <div class="test-panel-header" onclick="toggleTestPanel()">
                        <h4>🧪 规则测试</h4>
                        <button class="btn-toggle">▼</button>
                    </div>
                    <div class="test-panel-content">
                        <div class="test-layout">
                            <div class="test-input-section">
                                <label class="test-label">📝 原始文本</label>
                                <textarea class="test-textarea" id="testInput" placeholder="在这里输入要测试的文本..."></textarea>
                                <div class="test-actions">
                                <button class="btn btn-sm btn-primary" onclick="testSelectedFilters()">🧪 测试选中规则</button>
                                <button class="btn btn-sm btn-secondary" onclick="clearTestInput()">🗑️ 清空</button>
                                <button class="btn btn-sm btn-secondary" onclick="copyOriginalText()">📋 复制原文</button>
                                </div>
                            </div>
                        
                            <div class="test-result-section">
                                <label class="test-label">✨ 过滤结果</label>
                                <textarea class="test-textarea" id="testResult" placeholder="过滤结果将显示在这里..."></textarea>
                                <div class="test-actions">
                                <button class="btn btn-sm btn-success" onclick="copyEditedResult()">📋 复制结果</button>
                                <button class="btn btn-sm btn-secondary" onclick="clearTestResult()">🗑️ 清空</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设置 -->
        <div id="settings" class="tab-content">
            <div class="section-header">
                <div class="section-title">数据管理</div>
            </div>

            <div class="form-group">
                <label class="form-label">导入数据文件</label>
                <input type="file" class="form-control" id="importFile" accept=".json,.csv,.txt" onchange="importData()">
                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                    💡 支持格式：JSON（完整备份/单模块/预设组）、CSV（表格格式）、TXT（纯文本格式）
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">智能批量导入</label>
                <button class="btn btn-success" onclick="openBatchImportTool()">🚀 打开批量导入工具</button>
                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                    💡 支持自然语言输入、表格编辑、拖拽上传等多种方式，让数据导入变得简单高效
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">导出全部数据</label>
                <div>
                    <button class="btn btn-primary" onclick="exportAllData()">📥 导出全部数据</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ 清空全部数据</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">主题设置</label>
                <div>
                    <button class="btn btn-primary" onclick="toggleTheme()">🌙 切换主题</button>
                    <button class="btn btn-secondary" onclick="toggleShortcuts()">⌨️ 快捷键提示</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">使用统计</label>
                <div id="statsContainer">
                    <p>提示词总数: <span id="promptsCount">0</span></p>
                    <p>网站总数: <span id="websitesCount">0</span></p>
                    <p>过滤规则总数: <span id="filtersCount">0</span></p>
                    <p>总使用次数: <span id="totalUsage">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量导入工具模态框 -->
    <div id="batchImportModal" class="batch-import-modal">
        <div class="batch-import-container">
            <div class="batch-import-header">
                <h2>🚀 智能批量导入工具</h2>
                <button class="batch-import-close" onclick="closeBatchImportTool()">×</button>
            </div>
            
            <div class="batch-import-content">
                <!-- 左侧：输入面板 -->
                <div class="batch-input-panel">
                    <h3 class="batch-panel-title">
                        <span>📝 数据输入</span>
                    </h3>

                    <!-- 输入方式选择 -->
                    <div class="batch-input-method">
                        <button class="batch-method-btn active" onclick="switchBatchMethod('text')">
                            📄 文本输入
                        </button>
                        <button class="batch-method-btn" onclick="switchBatchMethod('existing')">
                            📚 加载现有
                        </button>
                        <button class="batch-method-btn" onclick="switchBatchMethod('file')">
                            📁 文件导入
                        </button>
                        <button class="batch-method-btn" onclick="switchBatchMethod('template')">
                            📋 使用模板
                        </button>
                    </div>

                    <!-- 文本输入区 -->
                    <div id="batchTextInput" class="batch-input-area active">
                        <div class="batch-alert batch-alert-info">
                            💡 支持自然语言输入，每行一个项目，系统会智能识别类型
                        </div>

                        <textarea class="batch-text-input" id="batchNaturalInput" placeholder="请输入内容，支持多种格式..."></textarea>

                        <div class="btn-group" style="margin: 15px 0;">
                            <button class="btn" onclick="parseBatchNaturalInput()">🤖 智能解析</button>
                            <button class="btn btn-secondary" onclick="clearBatchInput()">🗑️ 清空</button>
                        </div>

                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #666; margin-bottom: 10px;">📋 输入格式说明</summary>
                            
                            <div class="batch-example-box">
                                <div class="batch-example-title">📝 提示词格式：</div>
                                <div class="batch-example-content">标题：内容 #标签1 #标签2 @来源</div>
                            </div>

                            <div class="batch-example-box">
                                <div class="batch-example-title">🌐 网站格式：</div>
                                <div class="batch-example-content">名称 - 网址 - 描述 #标签1 #标签2 @来源</div>
                            </div>

                            <div class="batch-example-box">
                                <div class="batch-example-title">🔧 过滤规则格式：</div>
                                <div class="batch-example-content">名称 正则：正则表达式 替换：替换内容 #标签1 #标签2
或简化格式：正则表达式 -> 替换内容 #标签1 #标签2</div>
                            </div>

                            <div class="batch-example-box">
                                <div class="batch-example-title">📦 预设组格式：</div>
                                <div class="batch-example-content">名称：描述
规则：filter_001, filter_002, filter_003
状态：启用/禁用</div>
                            </div>
                        </details>

                        <div style="background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 6px; padding: 12px; margin: 10px 0; font-size: 14px;">
                            <strong>📝 转义符格式说明：</strong><br>
                            • 换行符：<code>\n</code> - 用于内容中的换行<br>
                            • 制表符：<code>\t</code> - 用于缩进对齐<br>
                            • 反斜杠：<code>\\</code> - 用于输入字面量反斜杠<br>
                            • 条目分隔：使用 <code>===ENTRY_SEPARATOR===</code> 明确分隔不同条目<br>
                            • 示例：<code>产品需求分析师：分析需求\n\n1. 背景\n2. 功能\n\n需求描述：</code>
                        </div>

                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #666; margin-bottom: 10px;">💡 输入示例</summary>
                            
                            <div class="batch-example-box">
                                <div class="batch-example-title">✨ 提示词示例（支持完整转义符）：</div>
                                <div class="batch-example-content">产品需求分析师：作为产品需求分析专家，请帮我分析以下产品需求：\n\n1. 需求背景和目标用户\n2. 功能需求详细拆解\n3. 非功能性需求\n\n需求描述： #产品管理 #需求分析

===ENTRY_SEPARATOR===

会议纪要整理：按标准格式整理会议记录\n\n- 记录会议主题\n- 整理讨论要点\n- 跟进行动项 #会议 #管理</div>
                            </div>

                            <div class="batch-example-box">
                                <div class="batch-example-title">🌐 网站示例（多行用\n表示换行）：</div>
                                <div class="batch-example-content">GitHub - https://github.com - 代码托管平台，支持Git版本控制\n提供协作开发、项目管理等功能 #开发 #Git
Stack Overflow - https://stackoverflow.com - 程序员问答社区\n解决编程问题的最佳平台 #问答 #编程</div>
                            </div>

                            <div class="batch-example-box">
                                <div class="batch-example-title">🔧 过滤规则示例：</div>
                                <div class="batch-example-content">手机号脱敏 正则：(\d{3})\d{4}(\d{4}) 替换：$1****$2 #隐私 #脱敏
邮箱脱敏 正则：(\w+)@(\w+) 替换：***@$2 #隐私 #邮箱</div>
                            </div>

                            <div class="batch-example-box">
                                <div class="batch-example-title">📦 预设组示例（多行用\n表示换行）：</div>
                                <div class="batch-example-content">隐私保护套装：包含手机号、身份证、邮箱脱敏规则\n规则：filter_001, filter_002, filter_003\n状态：启用

文本清理套装：清理空格、HTML标签、换行符\n规则：filter_004, filter_005, filter_006\n状态：启用</div>
                            </div>
                        </details>
                    </div>

                    <!-- 加载现有数据区 -->
                    <div id="batchExistingInput" class="batch-input-area">
                        <div class="batch-alert batch-alert-info">
                            📚 从现有数据中选择并加载到编辑器中，支持批量修改后重新导入
                        </div>

                        <!-- 数据类型选择 -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">选择数据类型：</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="loadPrompts" checked onchange="updateExistingDataPreview()"> 提示词 (<span id="existingPromptsCount">0</span>)
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="loadWebsites" checked onchange="updateExistingDataPreview()"> 网站 (<span id="existingWebsitesCount">0</span>)
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="loadFilters" checked onchange="updateExistingDataPreview()"> 过滤规则 (<span id="existingFiltersCount">0</span>)
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="loadPresets" checked onchange="updateExistingDataPreview()"> 预设组 (<span id="existingPresetsCount">0</span>)
                                </label>
                            </div>
                        </div>

                        <!-- 筛选选项 -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">筛选条件：</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 13px; color: #666;">按分类筛选：</label>
                                    <select id="categoryFilter" onchange="updateExistingDataPreview()" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">全部分类</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 13px; color: #666;">按标签筛选：</label>
                                    <input type="text" id="tagFilter" placeholder="输入标签关键词" onchange="updateExistingDataPreview()" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                            </div>
                        </div>

                        <!-- 其他选项 -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="onlyPinned" onchange="updateExistingDataPreview()"> 仅显示固定项目
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 13px;">
                                <input type="checkbox" id="onlyActive" onchange="updateExistingDataPreview()"> 仅显示激活的过滤规则
                            </label>
                        </div>

                        <!-- 预览已有数据 -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">预览数据 (<span id="filteredDataCount">0</span> 条)：</label>
                            <div id="existingDataPreview" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9; font-size: 13px;">
                                <!-- 预览内容将通过JavaScript填充 -->
                            </div>
                        </div>

                        <div class="btn-group">
                            <button class="btn" onclick="loadExistingDataToBatch()">📥 加载选中数据</button>
                            <button class="btn btn-secondary" onclick="selectAllExistingData()">✅ 全选</button>
                            <button class="btn btn-secondary" onclick="clearAllExistingData()">🗑️ 清除选择</button>
                        </div>
                    </div>

                    <!-- 文件导入区 -->
                    <div id="batchFileInput" class="batch-input-area">
                        <div class="batch-alert batch-alert-info">
                            📈 支持Excel、CSV、TXT文件导入，自动识别数据格式
                        </div>

                        <div class="batch-file-upload-area" id="batchUploadArea" onclick="document.getElementById('batchFileInput').click()">
                            <div class="batch-upload-icon">📁</div>
                            <div class="batch-upload-text">点击选择文件或拖拽到此处</div>
                            <div class="batch-upload-hint">支持 .xlsx, .csv, .txt 格式</div>
                            <input type="file" id="batchFileInputElement" style="display: none;" accept=".xlsx,.xls,.csv,.txt,.json" onchange="handleBatchFileSelect(event)">
                        </div>

                        <div class="batch-example-box">
                            <div class="batch-example-title">📋 文件格式要求：</div>
                            <div class="batch-example-content">• CSV格式：第一行为标题行
• 提示词：标题,内容,分类,标签
• 网站：名称,网址,描述,分类,标签
• 过滤规则：名称,正则表达式,替换内容,分组,标签
• 预设组：名称,描述,规则ID列表,启用状态</div>
                        </div>

                        <button class="btn btn-secondary" onclick="downloadBatchTemplate()">📥 下载模板文件</button>
                    </div>

                    <!-- 模板选择区 -->
                    <div id="batchTemplateInput" class="batch-input-area">
                        <div class="batch-alert batch-alert-info">
                            📋 选择预设模板，快速导入常用数据
                        </div>

                        <div class="batch-template-grid">
                            <div class="batch-template-card" onclick="selectBatchTemplate('dev-prompts')">
                                <div class="batch-template-icon">👨‍💻</div>
                                <div class="batch-template-name">开发提示词</div>
                                <div class="batch-template-desc">常用编程提示词</div>
                            </div>
                            <div class="batch-template-card" onclick="selectBatchTemplate('ai-tools')">
                                <div class="batch-template-icon">🤖</div>
                                <div class="batch-template-name">AI工具</div>
                                <div class="batch-template-desc">AI相关网站</div>
                            </div>
                            <div class="batch-template-card" onclick="selectBatchTemplate('writing')">
                                <div class="batch-template-icon">✍️</div>
                                <div class="batch-template-name">写作助手</div>
                                <div class="batch-template-desc">写作相关提示词</div>
                            </div>
                            <div class="batch-template-card" onclick="selectBatchTemplate('learning')">
                                <div class="batch-template-icon">📚</div>
                                <div class="batch-template-name">学习资源</div>
                                <div class="batch-template-desc">学习网站合集</div>
                            </div>
                            <div class="batch-template-card" onclick="selectBatchTemplate('productivity')">
                                <div class="batch-template-icon">⚡</div>
                                <div class="batch-template-name">效率工具</div>
                                <div class="batch-template-desc">提高效率的网站</div>
                            </div>
                            <div class="batch-template-card" onclick="selectBatchTemplate('design')">
                                <div class="batch-template-icon">🎨</div>
                                <div class="batch-template-name">设计资源</div>
                                <div class="batch-template-desc">设计相关网站</div>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button class="btn" onclick="loadBatchSelectedTemplate()">📥 加载模板</button>
                            <button class="btn btn-secondary" onclick="previewBatchTemplate()">👁️ 预览模板</button>
                        </div>
                    </div>
                </div>

                <!-- 右侧：预览面板 -->
                <div class="batch-preview-panel">
                    <h3 class="batch-panel-title">
                        <span>👁️ 数据预览</span>
                        <span id="batchPreviewCount" style="font-size: 14px; color: #666;"></span>
                    </h3>

                    <!-- 统计信息 -->
                    <div class="batch-stats-bar">
                        <div class="batch-stat-item">
                            <div class="batch-stat-value" id="batchTotalItems">0</div>
                            <div class="batch-stat-label">总数据</div>
                        </div>
                        <div class="batch-stat-item">
                            <div class="batch-stat-value" id="batchPromptItems">0</div>
                            <div class="batch-stat-label">提示词</div>
                        </div>
                        <div class="batch-stat-item">
                            <div class="batch-stat-value" id="batchWebsiteItems">0</div>
                            <div class="batch-stat-label">网站</div>
                        </div>
                        <div class="batch-stat-item">
                            <div class="batch-stat-value" id="batchFilterItems">0</div>
                            <div class="batch-stat-label">过滤规则</div>
                        </div>
                        <div class="batch-stat-item">
                            <div class="batch-stat-value" id="batchPresetItems">0</div>
                            <div class="batch-stat-label">预设组</div>
                        </div>
                        <div class="batch-stat-item">
                            <div class="batch-stat-value" id="batchErrorItems">0</div>
                            <div class="batch-stat-label">错误</div>
                        </div>
                    </div>

                    <!-- 预览区域 -->
                    <div class="batch-preview-container" id="batchPreviewContainer">
                        <div style="text-align: center; color: #999; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">📋</div>
                            <div>暂无数据，请在左侧输入或导入数据</div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="importBatchToSystem()" id="batchImportBtn" disabled>
                            🚀 导入到系统
                        </button>
                        <button class="btn btn-secondary" onclick="exportBatchAsJson()">
                            📥 导出JSON
                        </button>
                        <button class="btn btn-warning" onclick="validateBatchData()">
                            ✔️ 验证数据
                        </button>
                    </div>

                    <!-- 进度条 -->
                    <div class="batch-progress-bar" id="batchProgressBar" style="display: none;">
                        <div class="batch-progress-fill" id="batchProgressFill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加提示词模态框 -->
    <div id="addPromptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加提示词</div>
                <button class="close-btn" onclick="closeModal('addPromptModal')">&times;</button>
            </div>
            <form onsubmit="savePrompt(event)">
                <div class="form-group">
                    <label class="form-label">标题</label>
                    <input type="text" class="form-control" id="promptTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">内容</label>
                    <textarea class="textarea" id="promptContent" required placeholder="输入提示词内容..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">分类</label>
                    <input type="text" class="form-control" id="promptCategoryInput" list="promptCategories" placeholder="输入或选择分类（支持多级：工作/开发/AI）">
                    <datalist id="promptCategories"></datalist>
                    <small style="color: #666; font-size: 12px;">💡 使用"/"分隔多级分类，如：工作/开发/前端</small>
                </div>
                <div class="form-group">
                    <label class="form-label">标签（用逗号分隔）</label>
                    <input type="text" class="form-control" id="promptTags" placeholder="例如：工作,效率,AI">
                    <div class="tags-suggestions" id="promptTagsSuggestions"></div>
                </div>
                <div class="form-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="promptPinned">
                        <label for="promptPinned">置顶此提示词</label>
                    </div>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-warning" onclick="clearPromptForm()">🗑️ 清除</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addPromptModal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加网站模态框 -->
    <div id="addWebsiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加网站</div>
                <button class="close-btn" onclick="closeModal('addWebsiteModal')">&times;</button>
            </div>
            <form onsubmit="saveWebsite(event)">
                <div class="form-group">
                    <label class="form-label">网站名称</label>
                    <input type="text" class="form-control" id="websiteTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">网站URL</label>
                    <input type="url" class="form-control" id="websiteUrl" required placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">描述</label>
                    <textarea class="textarea" id="websiteDescription" placeholder="网站描述（可选）"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">分类</label>
                    <input type="text" class="form-control" id="websiteCategoryInput" list="websiteCategories" placeholder="输入或选择分类（支持多级：开发/工具/前端）">
                    <datalist id="websiteCategories"></datalist>
                    <small style="color: #666; font-size: 12px;">💡 使用"/"分隔多级分类，如：开发/工具/设计</small>
                </div>
                <div class="form-group">
                    <label class="form-label">标签（用逗号分隔）</label>
                    <input type="text" class="form-control" id="websiteTags" placeholder="例如：开发,工具,文档">
                    <div class="tags-suggestions" id="websiteTagsSuggestions"></div>
                </div>
                <div class="form-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="websitePinned">
                        <label for="websitePinned">置顶此网站</label>
                    </div>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-warning" onclick="clearWebsiteForm()">🗑️ 清除</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addWebsiteModal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 添加过滤规则模态框 -->
    <div id="addFilterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加过滤规则</div>
                <button class="close-btn" onclick="closeModal('addFilterModal')">&times;</button>
            </div>
            <form onsubmit="saveFilter(event)">
                <div class="form-group">
                    <label class="form-label">规则名称</label>
                    <input type="text" class="form-control" id="filterName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">正则表达式</label>
                    <input type="text" class="form-control" id="filterRegex" required placeholder="例: \\b\\d{4}\\b (匹配4位数字)">
                </div>
                <div class="form-group">
                    <label class="form-label">替换为</label>
                    <input type="text" class="form-control" id="filterReplace" placeholder="留空则删除匹配内容，或输入替换文本">
                </div>
                <div class="form-group">
                    <label class="form-label">规则组</label>
                    <input type="text" class="form-control" id="filterGroup" list="filterGroups" placeholder="输入或选择规则组（可留空）">
                    <datalist id="filterGroups"></datalist>
                </div>
                <div class="form-group">
                    <label class="form-label">标签（用逗号分隔）</label>
                    <input type="text" class="form-control" id="filterTags" placeholder="例如：隐私,数据,清理">
                    <div class="tags-suggestions" id="filterTagsSuggestions"></div>
                </div>
                <div class="form-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filterPinned">
                        <label for="filterPinned">固定此规则</label>
                    </div>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addFilterModal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div id="toast" class="toast"></div>

    <script>
        // 全局数据存储
        let appData = {
            prompts: [],
            websites: [],
            filters: [],
            settings: {
                theme: 'light',
                autoBackup: true
            }
        };
        
        // 编辑状态管理
        let editState = {
            type: null, // 'prompt', 'website', 'filter'
            id: null,
            isEditing: false
        };

        // 批量操作状态
        let batchMode = {
            prompts: false,
            websites: false,
            filters: false
        };

        let selectedItems = {
            prompts: new Set(),
            websites: new Set(),
            filters: new Set()
        };

        // 拖拽状态
        let dragState = {
            draggedElement: null,
            draggedId: null,
            draggedType: null
        };

        // 新的过滤器状态管理
        let filterState = {
            selectedRules: new Set(),
            categoryTree: {},
            expandedCategories: new Set(),
            selectedCategory: null,
            searchTerm: '',
            presets: JSON.parse(localStorage.getItem('filterPresets') || '[]'),
            selectedPresets: new Set(),
            panelStates: {
                categories: true,
                presets: true,
                rules: true
            }
        };

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            loadData();
            initTabs();
            updateStats();
            clearLoadingStates();
            initTagsPanelsState();
            updateAllFunctionTags();
            updateCategories();
            initResizeHandlers();
            // 初始化过滤器预设
            initFilterPresets();
            // 初始化测试面板状态
            initTestPanelState();
            // 初始化面板状态
            initFilterPanelStates();
            // 初始化测试面板同步滚动
            initTestPanelSyncScroll();
        });

        // 初始化主题
        function initTheme() {
            const savedTheme = localStorage.getItem('promptManagerTheme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                // 延迟设置图标，确保元素已加载
                setTimeout(() => {
                    const toggleBtn = document.querySelector('.theme-toggle');
                    if (toggleBtn) toggleBtn.textContent = '☀️';
                }, 100);
            } else {
                setTimeout(() => {
                    const toggleBtn = document.querySelector('.theme-toggle');
                    if (toggleBtn) toggleBtn.textContent = '🌙';
                }, 100);
            }
            appData.settings.theme = savedTheme;
        }

        // 切换主题
        function toggleTheme() {
            const isDark = document.body.classList.contains('dark-theme');
            if (isDark) {
                document.body.classList.remove('dark-theme');
                document.querySelector('.theme-toggle').textContent = '🌙';
                appData.settings.theme = 'light';
            } else {
                document.body.classList.add('dark-theme');
                document.querySelector('.theme-toggle').textContent = '☀️';
                appData.settings.theme = 'dark';
            }
            localStorage.setItem('promptManagerTheme', appData.settings.theme);
            saveData();
        }

        // 切换快捷键提示
        function toggleShortcuts() {
            const panel = document.getElementById('shortcutsPanel');
            panel.classList.toggle('show');
        }


        // 简化的标签页切换 - 专注移动端兼容
        function initTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                const targetTab = tab.getAttribute('data-tab');
                if (!targetTab) return;
                
                // 标签切换逻辑
                const switchTab = function(e) {
                    e.preventDefault();
                    
                    // 移除所有激活状态
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    // 激活当前标签
                    tab.classList.add('active');
                    const targetContent = document.getElementById(targetTab);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                };
                
                // 绑定点击和触摸事件
                tab.addEventListener('click', switchTab);
                tab.addEventListener('touchstart', switchTab, { passive: false });
                
                // 键盘支持
                tab.setAttribute('tabindex', '0');
                tab.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        switchTab(e);
                    }
                });
            });
        }

        // 简单的resize处理
        function initResizeHandlers() {
            // 防抖处理resize事件
            let resizeTimer;
            const handleResize = () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    // 在窗口大小改变后重新初始化标签
                    initTabs();
                }, 100);
            };
            
            window.addEventListener('resize', handleResize);
            window.addEventListener('orientationchange', () => {
                setTimeout(initTabs, 200);
            });
        }

        // 本地存储相关函数
        function saveData() {
            try {
                // 验证数据结构
                if (!appData || typeof appData !== 'object') {
                    throw new Error('数据结构错误');
                }
                
                const dataString = JSON.stringify(appData);
                
                // 检查localStorage容量
                if (dataString.length > 5 * 1024 * 1024) { // 5MB limit
                    throw new Error('数据过大，请删除一些项目');
                }
                
                localStorage.setItem('promptManagerData', dataString);
                updateStats();
            } catch (error) {
                console.error('Save error:', error);
                if (error.name === 'QuotaExceededError') {
                    showToast('存储空间不足，请清理数据', 'error');
                } else {
                    showToast('保存失败: ' + error.message, 'error');
                }
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('promptManagerData');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    
                    // 数据结构验证和修复
                    appData = {
                        prompts: Array.isArray(parsedData.prompts) ? parsedData.prompts : [],
                        websites: Array.isArray(parsedData.websites) ? parsedData.websites : [],
                        filters: Array.isArray(parsedData.filters) ? parsedData.filters : [],
                        settings: parsedData.settings || { theme: 'light', autoBackup: true }
                    };
                    
                    // 清理和修复数据
                    appData.prompts = appData.prompts.filter(p => p && p.id && p.title && p.content).map(p => ({
                        ...p,
                        category: p.category || '默认',
                        tags: Array.isArray(p.tags) ? p.tags : [],
                        usageCount: Number(p.usageCount) || 0,
                        pinned: Boolean(p.pinned)
                    }));
                    
                    appData.websites = appData.websites.filter(w => w && w.id && w.title && w.url).map(w => ({
                        ...w,
                        category: w.category || '默认',
                        tags: Array.isArray(w.tags) ? w.tags : [],
                        usageCount: Number(w.usageCount) || 0,
                        pinned: Boolean(w.pinned)
                    }));
                    
                    appData.filters = appData.filters.filter(f => f && f.id && f.name && f.regex).map(f => ({
                        ...f,
                        tags: Array.isArray(f.tags) ? f.tags : [],
                        usageCount: Number(f.usageCount) || 0,
                        pinned: Boolean(f.pinned),
                        active: Boolean(f.active),
                        group: f.group || '未分组'
                    }));
                    
                    // 执行数据迁移
                    migrateData();
                }
                
                renderAll();
                updateCategories();
            } catch (error) {
                console.error('Load error:', error);
                showToast('加载数据失败，使用默认设置: ' + error.message, 'error');
                // 重置为默认数据
                appData = {
                    prompts: [],
                    websites: [],
                    filters: [],
                    settings: { theme: 'light', autoBackup: true }
                };
                renderAll();
            }
        }
        
        function migrateData() {
            let hasChanges = false;
            
            // 检查是否需要数据版本升级
            if (!appData.settings.dataVersion || appData.settings.dataVersion < 2) {
                console.log('执行数据迁移到版本 2.0...');
                
                // 确保所有项目都有正确的默认值
                appData.prompts.forEach(prompt => {
                    if (!prompt.category) {
                        prompt.category = '默认';
                        hasChanges = true;
                    }
                    if (!Array.isArray(prompt.tags)) {
                        prompt.tags = [];
                        hasChanges = true;
                    }
                });
                
                appData.websites.forEach(website => {
                    if (!website.category) {
                        website.category = '默认';
                        hasChanges = true;
                    }
                    if (!Array.isArray(website.tags)) {
                        website.tags = [];
                        hasChanges = true;
                    }
                });
                
                appData.filters.forEach(filter => {
                    if (!Array.isArray(filter.tags)) {
                        filter.tags = [];
                        hasChanges = true;
                    }
                    if (!filter.group) {
                        filter.group = '未分组';
                        hasChanges = true;
                    }
                });
                
                // 更新数据版本
                appData.settings.dataVersion = 2;
                hasChanges = true;
                
                if (hasChanges) {
                    saveData();
                    showToast('数据已升级到最新版本');
                }
            }
        }

        // 渲染所有内容
        function renderAll() {
            try {
                renderPrompts();
                renderWebsites();
                renderFilters();
                updateFilterGroups();
            } catch (error) {
                console.error('Render error:', error);
                showToast('渲染错误，请刷新页面', 'error');
            }
        }

        // 模态框控制
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.classList.add('active');
            
            // 移动端修复：延迟聚焦第一个输入框，避免键盘弹出问题
            setTimeout(() => {
                const firstInput = modal.querySelector('input[type="text"], textarea');
                if (firstInput && !firstInput.disabled && !firstInput.readOnly) {
                    // 移动端检测
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        // 移动端：确保元素可见并且具有正确的属性
                        firstInput.setAttribute('inputmode', 'text');
                        firstInput.setAttribute('autocomplete', 'off');
                        firstInput.setAttribute('spellcheck', 'false');
                        // 延迟聚焦以确保模态框完全显示
                        setTimeout(() => {
                            firstInput.focus();
                            firstInput.click(); // iOS Safari额外的点击
                        }, 300);
                    } else {
                        firstInput.focus();
                    }
                }
            }, 100);
            
            // 只在非编辑模式下处理表单
            if (!editState.isEditing) {
                if (modalId === 'addPromptModal') {
                    // 尝试恢复草稿
                    const draft = loadDraft('prompt');
                    if (draft) {
                        document.getElementById('promptTitle').value = draft.title || '';
                        document.getElementById('promptContent').value = draft.content || '';
                        document.getElementById('promptCategoryInput').value = draft.category || '';
                        document.getElementById('promptTags').value = draft.tags || '';
                        document.getElementById('promptPinned').checked = draft.pinned || false;
                        showToast('已恢复上次编辑的草稿', 'info');
                    } else {
                        // 清空表单
                        document.getElementById('promptTitle').value = '';
                        document.getElementById('promptContent').value = '';
                        document.getElementById('promptCategoryInput').value = '';
                        document.getElementById('promptTags').value = '';
                        document.getElementById('promptPinned').checked = false;
                    }
                    
                    // 更新标题
                    const modalTitle = modal.querySelector('.modal-title');
                    modalTitle.textContent = '添加提示词';
                    
                    // 绑定自动保存草稿
                    bindDraftAutoSave('prompt');
                    
                } else if (modalId === 'addWebsiteModal') {
                    // 尝试恢复草稿
                    const draft = loadDraft('website');
                    if (draft) {
                        document.getElementById('websiteTitle').value = draft.title || '';
                        document.getElementById('websiteUrl').value = draft.url || '';
                        document.getElementById('websiteDescription').value = draft.description || '';
                        document.getElementById('websiteCategoryInput').value = draft.category || '';
                        document.getElementById('websiteTags').value = draft.tags || '';
                        document.getElementById('websitePinned').checked = draft.pinned || false;
                        showToast('已恢复上次编辑的草稿', 'info');
                    } else {
                        // 清空表单
                        document.getElementById('websiteTitle').value = '';
                        document.getElementById('websiteUrl').value = '';
                        document.getElementById('websiteDescription').value = '';
                        document.getElementById('websiteCategoryInput').value = '';
                        document.getElementById('websiteTags').value = '';
                        document.getElementById('websitePinned').checked = false;
                    }
                    
                    const modalTitle = modal.querySelector('.modal-title');
                    modalTitle.textContent = '添加网站';
                    
                    // 绑定自动保存草稿
                    bindDraftAutoSave('website');
                    
                } else if (modalId === 'addFilterModal') {
                    // 尝试恢复草稿
                    const draft = loadDraft('filter');
                    if (draft) {
                        document.getElementById('filterName').value = draft.name || '';
                        document.getElementById('filterRegex').value = draft.regex || '';
                        document.getElementById('filterReplace').value = draft.replace || '';
                        document.getElementById('filterGroup').value = draft.group || '';
                        document.getElementById('filterTags').value = draft.tags || '';
                        document.getElementById('filterPinned').checked = draft.pinned || false;
                        showToast('已恢复上次编辑的草稿', 'info');
                    } else {
                        // 清空表单
                        document.getElementById('filterName').value = '';
                        document.getElementById('filterRegex').value = '';
                        document.getElementById('filterReplace').value = '';
                        document.getElementById('filterGroup').value = '';
                        document.getElementById('filterTags').value = '';
                        document.getElementById('filterPinned').checked = false;
                    }
                    
                    const modalTitle = modal.querySelector('.modal-title');
                    modalTitle.textContent = '添加过滤规则';
                    
                    // 绑定自动保存草稿
                    bindDraftAutoSave('filter');
                }
            }
            
            // 初始化标签建议
            updateTagsSuggestions();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
            
            // 重置编辑状态
            editState = {
                type: null,
                id: null,
                isEditing: false
            };
        }

        // 提示词相关函数
        // 草稿持久化辅助函数
        function loadDraft(type) {
            try {
                const draftKey = `promptManager_draft_${type}`;
                const draftData = localStorage.getItem(draftKey);
                return draftData ? JSON.parse(draftData) : null;
            } catch (error) {
                console.warn('加载草稿失败:', error);
                return null;
            }
        }

        function saveDraft(type, data) {
            try {
                const draftKey = `promptManager_draft_${type}`;
                localStorage.setItem(draftKey, JSON.stringify(data));
            } catch (error) {
                console.warn('保存草稿失败:', error);
            }
        }

        function clearDraft(type) {
            try {
                const draftKey = `promptManager_draft_${type}`;
                localStorage.removeItem(draftKey);
            } catch (error) {
                console.warn('清除草稿失败:', error);
            }
        }

        function bindDraftAutoSave(type) {
            const fieldMappings = {
                'prompt': {
                    'title': 'promptTitle',
                    'content': 'promptContent',
                    'category': 'promptCategoryInput',
                    'tags': 'promptTags',
                    'pinned': 'promptPinned'
                },
                'website': {
                    'title': 'websiteTitle',
                    'url': 'websiteUrl',
                    'description': 'websiteDescription',
                    'category': 'websiteCategoryInput',
                    'tags': 'websiteTags',
                    'pinned': 'websitePinned'
                },
                'filter': {
                    'name': 'filterName',
                    'regex': 'filterRegex',
                    'replace': 'filterReplace',
                    'group': 'filterGroupInput',
                    'tags': 'filterTags',
                    'pinned': 'filterPinned'
                }
            };

            const fields = fieldMappings[type];
            if (!fields) return;

            let saveTimeout;
            const saveDelay = 500; // 延迟500ms保存，避免频繁操作

            function draftAutoSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    const draftData = {};
                    let hasContent = false;

                    Object.keys(fields).forEach(key => {
                        const elementId = fields[key];
                        const element = document.getElementById(elementId);
                        if (element) {
                            if (element.type === 'checkbox') {
                                draftData[key] = element.checked;
                                if (element.checked) hasContent = true;
                            } else {
                                draftData[key] = element.value;
                                if (element.value.trim()) hasContent = true;
                            }
                        }
                    });

                    // 只在有内容时保存草稿
                    if (hasContent) {
                        saveDraft(type, draftData);
                    }
                }, saveDelay);
            }

            // 为所有字段添加事件监听器
            Object.values(fields).forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.addEventListener('change', draftAutoSave);
                    } else {
                        element.addEventListener('input', draftAutoSave);
                        element.addEventListener('change', draftAutoSave);
                    }
                }
            });
        }

        function savePrompt(event) {
            event.preventDefault();
            
            const title = document.getElementById('promptTitle').value.trim();
            const content = document.getElementById('promptContent').value.trim();
            const category = document.getElementById('promptCategoryInput').value.trim() || '默认';
            const tagsInput = document.getElementById('promptTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            const pinned = document.getElementById('promptPinned').checked;

            if (!title || !content) {
                showToast('请填写完整信息', 'error');
                return;
            }

            if (editState.isEditing && editState.type === 'prompt') {
                // 编辑模式
                const prompt = appData.prompts.find(p => p.id === editState.id);
                if (prompt) {
                    prompt.title = title;
                    prompt.content = content;
                    prompt.category = category;
                    prompt.tags = tags;
                    prompt.pinned = pinned;
                    prompt.updatedAt = new Date().toISOString();
                }
                showToast('提示词已更新');
            } else {
                // 添加模式
                const prompt = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    title,
                    content,
                    category,
                    tags,
                    pinned,
                    usageCount: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastUsed: null
                };
                appData.prompts.push(prompt);
                showToast('提示词添加成功');
            }

            // 保存成功后清除草稿
            clearDraft('prompt');

            saveData();
            renderPrompts();
            // 延迟更新分类以确保DOM已更新
            setTimeout(() => updateCategories(), 10);
            updateAllFunctionTags();
            closeModal('addPromptModal');
        }

        function renderPrompts() {
            const container = document.getElementById('promptsContainer');
            
            if (!container) return;
            
            if (appData.prompts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <p>还没有提示词，点击上方按钮添加第一个提示词吧！</p>
                    </div>
                `;
                return;
            }

            let filteredPrompts = [...appData.prompts];
            
            // 应用搜索过滤
            const searchElement = document.getElementById('promptSearch');
            const searchTerm = searchElement ? searchElement.value.toLowerCase() : '';
            if (searchTerm) {
                filteredPrompts = filteredPrompts.filter(prompt => 
                    prompt.title.toLowerCase().includes(searchTerm) || 
                    prompt.content.toLowerCase().includes(searchTerm) ||
                    (prompt.tags && prompt.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
            }

            // 应用分类过滤（支持多级分类）
            const categoryElement = document.getElementById('promptCategory');
            const categoryFilter = categoryElement ? categoryElement.value : '';
            if (categoryFilter) {
                filteredPrompts = filteredPrompts.filter(prompt => {
                    // 完全匹配、父级匹配或子级匹配
                    return prompt.category === categoryFilter || 
                           prompt.category.startsWith(categoryFilter + '/') ||
                           categoryFilter.startsWith(prompt.category + '/');
                });
            }

            // 应用排序
            const sortElement = document.getElementById('promptSort');
            const sortBy = sortElement ? sortElement.value : 'usage';
            filteredPrompts.sort((a, b) => {
                if (a.pinned !== b.pinned) return b.pinned - a.pinned;
                
                switch (sortBy) {
                    case 'usage':
                        return b.usageCount - a.usageCount;
                    case 'name':
                        return a.title.localeCompare(b.title);
                    case 'date':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    default:
                        return 0;
                }
            });

            container.innerHTML = filteredPrompts.map((prompt, index) => `
                <div class="item-card ${prompt.pinned ? 'pinned' : ''} ${batchMode.prompts && selectedItems.prompts.has(prompt.id) ? 'selected' : ''}" 
                     draggable="${!batchMode.prompts}" 
                     data-id="${prompt.id}" 
                     data-type="prompts"
                     data-index="${index}"
                     onclick="${batchMode.prompts ? `toggleSelection('prompts', '${prompt.id}', event)` : `copyPrompt('${prompt.id}')`}">
                    ${batchMode.prompts ? `<input type="checkbox" class="batch-checkbox" ${selectedItems.prompts.has(prompt.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelection('prompts', '${prompt.id}', event)">` : ''}
                    ${!batchMode.prompts ? '<div class="drag-handle">⋮⋮</div>' : ''}
                    <div class="item-header">
                        <div class="item-title">${escapeHtml(prompt.title)}</div>
                        <div class="item-actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); editPrompt('${prompt.id}')" title="编辑">✏️</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deletePrompt('${prompt.id}')" title="删除">🗑️</button>
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); togglePin('prompts', '${prompt.id}')" title="${prompt.pinned ? '取消置顶' : '置顶'}">
                                ${prompt.pinned ? '📌' : '📍'}
                            </button>
                        </div>
                    </div>
                    <div class="item-content">${escapeHtml(prompt.content.substring(0, 100))}${prompt.content.length > 100 ? '...' : ''}</div>
                    <div class="item-meta">
                        <div class="category-path">${renderCategoryBreadcrumb(prompt.category, 'prompts')}</div>
                        <span class="usage-count">使用 ${prompt.usageCount} 次</span>
                    </div>
                    ${prompt.tags && prompt.tags.length > 0 ? `<div class="tags-container">${prompt.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
            
            // 添加拖拽事件监听器
            if (!batchMode.prompts) {
                addDragListeners('prompts');
            }
        }

        function copyPrompt(id) {
            if (batchMode.prompts) return;
            
            const prompt = appData.prompts.find(p => p.id === id);
            if (prompt) {
                // 使用回退方案以兼容老版本浏览器
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(prompt.content).then(() => {
                        prompt.usageCount++;
                        prompt.lastUsed = new Date().toISOString();
                        saveData();
                        renderPrompts();
                        showToast('提示词已复制到剪贴板');
                    }).catch(() => {
                        fallbackCopyTextToClipboard(prompt.content, prompt);
                    });
                } else {
                    fallbackCopyTextToClipboard(prompt.content, prompt);
                }
            }
        }
        
        function fallbackCopyTextToClipboard(text, prompt) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful && prompt) {
                    prompt.usageCount++;
                    prompt.lastUsed = new Date().toISOString();
                    saveData();
                    renderPrompts();
                    showToast('提示词已复制到剪贴板');
                } else {
                    showToast('复制失败，请手动选择复制', 'error');
                }
            } catch (err) {
                showToast('复制失败，请手动选择复制', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        function deletePrompt(id) {
            if (confirm('确定要删除这个提示词吗？')) {
                appData.prompts = appData.prompts.filter(p => p.id !== id);
                saveData();
                renderPrompts();
                updateCategories();
                showToast('提示词已删除');
            }
        }

        function editPrompt(id) {
            const prompt = appData.prompts.find(p => p.id === id);
            if (prompt) {
                // 设置编辑状态
                editState = {
                    type: 'prompt',
                    id: id,
                    isEditing: true
                };
                
                // 填充表单
                document.getElementById('promptTitle').value = prompt.title;
                document.getElementById('promptContent').value = prompt.content;
                document.getElementById('promptCategoryInput').value = prompt.category;
                document.getElementById('promptTags').value = (prompt.tags || []).join(', ');
                document.getElementById('promptPinned').checked = prompt.pinned;
                
                // 更新模态框标题
                const modal = document.getElementById('addPromptModal');
                const modalTitle = modal.querySelector('.modal-title');
                modalTitle.textContent = '编辑提示词';
                
                openModal('addPromptModal');
            }
        }

        // 网站相关函数
        function saveWebsite(event) {
            event.preventDefault();
            
            const title = document.getElementById('websiteTitle').value.trim();
            const url = document.getElementById('websiteUrl').value.trim();
            const description = document.getElementById('websiteDescription').value.trim();
            const category = document.getElementById('websiteCategoryInput').value.trim() || '默认';
            const tagsInput = document.getElementById('websiteTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            const pinned = document.getElementById('websitePinned').checked;

            if (!title || !url) {
                showToast('请填写完整信息', 'error');
                return;
            }

            if (editState.isEditing && editState.type === 'website') {
                // 编辑模式
                const website = appData.websites.find(w => w.id === editState.id);
                if (website) {
                    website.title = title;
                    website.url = url;
                    website.description = description;
                    website.category = category;
                    website.tags = tags;
                    website.pinned = pinned;
                    website.updatedAt = new Date().toISOString();
                }
                showToast('网站已更新');
            } else {
                // 添加模式
                const website = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    title,
                    url,
                    description,
                    category,
                    tags,
                    pinned,
                    usageCount: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastUsed: null
                };
                appData.websites.push(website);
                showToast('网站添加成功');
            }

            // 保存成功后清除草稿
            clearDraft('website');

            saveData();
            renderWebsites();
            // 延迟更新分类以确保DOM已更新
            setTimeout(() => updateCategories(), 10);
            updateAllFunctionTags();
            closeModal('addWebsiteModal');
        }

        // 清除提示词表单
        function clearPromptForm() {
            if (confirm('确定要清除当前填写的内容吗？此操作无法撤销。')) {
                document.getElementById('promptTitle').value = '';
                document.getElementById('promptContent').value = '';
                document.getElementById('promptCategoryInput').value = '';
                document.getElementById('promptTags').value = '';
                document.getElementById('promptPinned').checked = false;
                
                // 清除标签建议
                const suggestionsElement = document.getElementById('promptTagsSuggestions');
                if (suggestionsElement) {
                    suggestionsElement.innerHTML = '';
                }
                
                showToast('表单已清除', 'success');
            }
        }

        // 清除网站表单
        function clearWebsiteForm() {
            if (confirm('确定要清除当前填写的内容吗？此操作无法撤销。')) {
                document.getElementById('websiteTitle').value = '';
                document.getElementById('websiteUrl').value = '';
                document.getElementById('websiteDescription').value = '';
                document.getElementById('websiteCategoryInput').value = '';
                document.getElementById('websiteTags').value = '';
                document.getElementById('websitePinned').checked = false;
                
                // 清除标签建议
                const suggestionsElement = document.getElementById('websiteTagsSuggestions');
                if (suggestionsElement) {
                    suggestionsElement.innerHTML = '';
                }
                
                showToast('表单已清除', 'success');
            }
        }

        function renderWebsites() {
            const container = document.getElementById('websitesContainer');
            
            if (!container) return;
            
            if (appData.websites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🌐</div>
                        <p>还没有收藏网站，点击上方按钮添加第一个网站吧！</p>
                    </div>
                `;
                return;
            }

            let filteredWebsites = [...appData.websites];
            
            // 应用搜索过滤
            const searchElement = document.getElementById('websiteSearch');
            const searchTerm = searchElement ? searchElement.value.toLowerCase() : '';
            if (searchTerm) {
                filteredWebsites = filteredWebsites.filter(website => 
                    website.title.toLowerCase().includes(searchTerm) || 
                    (website.description && website.description.toLowerCase().includes(searchTerm)) ||
                    website.url.toLowerCase().includes(searchTerm) ||
                    (website.tags && website.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
            }

            // 应用分类过滤（支持多级分类）
            const categoryElement = document.getElementById('websiteCategory');
            const categoryFilter = categoryElement ? categoryElement.value : '';
            if (categoryFilter) {
                filteredWebsites = filteredWebsites.filter(website => {
                    // 完全匹配、父级匹配或子级匹配
                    return website.category === categoryFilter || 
                           website.category.startsWith(categoryFilter + '/') ||
                           categoryFilter.startsWith(website.category + '/');
                });
            }

            // 应用排序
            const sortElement = document.getElementById('websiteSort');
            const sortBy = sortElement ? sortElement.value : 'usage';
            filteredWebsites.sort((a, b) => {
                if (a.pinned !== b.pinned) return b.pinned - a.pinned;
                
                switch (sortBy) {
                    case 'usage':
                        return b.usageCount - a.usageCount;
                    case 'name':
                        return a.title.localeCompare(b.title);
                    case 'date':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    default:
                        return 0;
                }
            });

            container.innerHTML = filteredWebsites.map((website, index) => `
                <div class="item-card ${website.pinned ? 'pinned' : ''} ${batchMode.websites && selectedItems.websites.has(website.id) ? 'selected' : ''}" 
                     draggable="${!batchMode.websites}" 
                     data-id="${website.id}" 
                     data-type="websites"
                     data-index="${index}"
                     onclick="${batchMode.websites ? `toggleSelection('websites', '${website.id}', event)` : `openWebsite('${website.id}')`}">
                    ${batchMode.websites ? `<input type="checkbox" class="batch-checkbox" ${selectedItems.websites.has(website.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelection('websites', '${website.id}', event)">` : ''}
                    ${!batchMode.websites ? '<div class="drag-handle">⋮⋮</div>' : ''}
                    <div class="item-header">
                        <div class="item-title">${escapeHtml(website.title)}</div>
                        <div class="item-actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); editWebsite('${website.id}')" title="编辑">✏️</button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteWebsite('${website.id}')" title="删除">🗑️</button>
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); togglePin('websites', '${website.id}')" title="${website.pinned ? '取消置顶' : '置顶'}">
                                ${website.pinned ? '📌' : '📍'}
                            </button>
                        </div>
                    </div>
                    <div class="item-content">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${escapeHtml(website.url)}</div>
                        ${website.description ? escapeHtml(website.description.substring(0, 80)) + (website.description.length > 80 ? '...' : '') : ''}
                    </div>
                    <div class="item-meta">
                        <div class="category-path">${renderCategoryBreadcrumb(website.category, 'websites')}</div>
                        <span class="usage-count">访问 ${website.usageCount} 次</span>
                    </div>
                    ${website.tags && website.tags.length > 0 ? `<div class="tags-container">${website.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
            
            // 添加拖拽事件监听器
            if (!batchMode.websites) {
                addDragListeners('websites');
            }
        }

        function openWebsite(id) {
            if (batchMode.websites) return;
            
            const website = appData.websites.find(w => w.id === id);
            if (website) {
                website.usageCount++;
                website.lastUsed = new Date().toISOString();
                saveData();
                renderWebsites();
                
                // 验证URL格式
                let url = website.url;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                try {
                    window.open(url, '_blank', 'noopener,noreferrer');
                    showToast('网站已打开');
                } catch (error) {
                    showToast('无法打开网站，请检查URL格式', 'error');
                }
            }
        }

        function deleteWebsite(id) {
            if (confirm('确定要删除这个网站吗？')) {
                appData.websites = appData.websites.filter(w => w.id !== id);
                saveData();
                renderWebsites();
                updateCategories();
                showToast('网站已删除');
            }
        }

        function editWebsite(id) {
            const website = appData.websites.find(w => w.id === id);
            if (website) {
                // 设置编辑状态
                editState = {
                    type: 'website',
                    id: id,
                    isEditing: true
                };
                
                // 填充表单
                document.getElementById('websiteTitle').value = website.title;
                document.getElementById('websiteUrl').value = website.url;
                document.getElementById('websiteDescription').value = website.description || '';
                document.getElementById('websiteCategoryInput').value = website.category;
                document.getElementById('websiteTags').value = (website.tags || []).join(', ');
                document.getElementById('websitePinned').checked = website.pinned;
                
                // 更新模态框标题
                const modal = document.getElementById('addWebsiteModal');
                const modalTitle = modal.querySelector('.modal-title');
                modalTitle.textContent = '编辑网站';
                
                openModal('addWebsiteModal');
            }
        }

        // 过滤器相关函数
        function saveFilter(event) {
            event.preventDefault();
            
            const name = document.getElementById('filterName').value.trim();
            const regex = document.getElementById('filterRegex').value.trim();
            const replace = document.getElementById('filterReplace').value;
            const group = document.getElementById('filterGroup').value.trim() || '未分组';
            const tagsInput = document.getElementById('filterTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            const pinned = document.getElementById('filterPinned').checked;

            if (!name || !regex) {
                showToast('请填写完整信息', 'error');
                return;
            }

            // 验证正则表达式
            try {
                new RegExp(regex);
            } catch (error) {
                showToast('正则表达式格式错误: ' + error.message, 'error');
                return;
            }

            if (editState.isEditing && editState.type === 'filter') {
                // 编辑模式
                const filter = appData.filters.find(f => f.id === editState.id);
                if (filter) {
                    filter.name = name;
                    filter.regex = regex;
                    filter.replace = replace;
                    filter.group = group;
                    filter.tags = tags;
                    filter.pinned = pinned;
                    filter.updatedAt = new Date().toISOString();
                }
                showToast('过滤规则已更新');
            } else {
                // 添加模式
                const filter = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    name,
                    regex,
                    replace,
                    group,
                    tags,
                    pinned,
                    active: false,
                    usageCount: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                appData.filters.push(filter);
                showToast('过滤规则添加成功');
            }

            // 保存成功后清除草稿
            clearDraft('filter');

            saveData();
            renderFilters();
            updateFilterGroups();
            updateAllFunctionTags();
            closeModal('addFilterModal');
        }

        function renderFilters() {
            // 构建分类树
            filterState.categoryTree = buildFilterCategoryTree();
            
            // 渲染分类目录树
            renderFilterCategoryTree();
            
            // 渲染规则列表
            renderFilterRulesList();
            
            // 更新统计信息
            updateFilterStats();
            
            // 更新标签显示
            updateAllFunctionTags();
            
            // 渲染新的预设管理面板
            renderCurrentSelection();
            renderPresetGroups();
            
            // 渲染旧版预设列表（保持兼容性）
            renderFilterPresets();
        }

        // 渲染分类目录树
        function renderFilterCategoryTree() {
            const container = document.getElementById('filterCategoryTree');
            if (!container) return;
            
            const tree = filterState.categoryTree;
            
            if (Object.keys(tree).length === 0) {
                container.innerHTML = `
                    <div class="tree-loading">
                        <div class="empty-state-icon" style="font-size: 2em; margin-bottom: 10px;">📁</div>
                        <p>暂无分类</p>
                        <small style="color: #666;">添加规则时可以创建分类</small>
                    </div>
                `;
                return;
            }
            
            function renderTreeNode(node, level = 0) {
                const selectionState = getCategorySelectionState(node.fullPath);
                const isSelected = filterState.selectedCategory === node.fullPath;
                const hasChildren = Object.keys(node.children).length > 0;
                const isExpanded = node.expanded || filterState.expandedCategories.has(node.fullPath);
                
                let html = `
                    <div class="category-item ${isSelected ? 'selected' : ''}" style="margin-left: ${level * 16}px">
                        <input type="checkbox" 
                               class="tristate-checkbox ${selectionState === 'partial' ? 'indeterminate' : ''}" 
                               ${selectionState === 'all' ? 'checked' : ''} 
                               onchange="toggleCategorySelection('${escapeHtml(node.fullPath)}')"
                               title="${selectionState === 'all' ? '已全选' : selectionState === 'partial' ? '部分选择' : '未选择'}">
                        ${hasChildren ? 
                            `<button class="category-toggle ${isExpanded ? 'expanded' : ''}" 
                                     onclick="toggleCategoryExpansion('${escapeHtml(node.fullPath)}')" 
                                     title="${isExpanded ? '折叠' : '展开'}">▶</button>` : 
                            '<span style="width: 16px;"></span>'
                        }
                        <div class="category-label" onclick="selectCategory('${escapeHtml(node.fullPath)}')">
                            <span>📁 ${escapeHtml(node.name)}</span>
                            <span class="category-count">${node.count}</span>
                        </div>
                    </div>
                `;
                
                if (hasChildren && isExpanded) {
                    html += '<div class="category-children">';
                    Object.keys(node.children).sort().forEach(childKey => {
                        html += renderTreeNode(node.children[childKey], level + 1);
                    });
                    html += '</div>';
                }
                
                return html;
            }
            
            let html = '';
            
            // 添加"所有分类"选项
            const allSelectionState = getCategorySelectionState(null);
            const isAllSelected = filterState.selectedCategory === null;
            html += `
                <div class="category-item ${isAllSelected ? 'selected' : ''}">
                    <input type="checkbox" 
                           class="tristate-checkbox ${allSelectionState === 'partial' ? 'indeterminate' : ''}" 
                           ${allSelectionState === 'all' ? 'checked' : ''} 
                           onchange="toggleCategorySelection(null)"
                           title="${allSelectionState === 'all' ? '已全选' : allSelectionState === 'partial' ? '部分选择' : '未选择'}">
                    <span style="width: 16px;"></span>
                    <div class="category-label" onclick="selectCategory(null)">
                        <span>📂 所有分类</span>
                        <span class="category-count">${appData.filters.length}</span>
                    </div>
                </div>
            `;
            
            // 渲染树节点
            Object.keys(tree).sort().forEach(key => {
                html += renderTreeNode(tree[key]);
            });
            
            container.innerHTML = html;
        }

        // 渲染规则列表
        function renderFilterRulesList() {
            const container = document.getElementById('filtersContainer');
            if (!container) return;
            
            // 获取要显示的规则
            let displayRules = [];
            
            if (filterState.selectedCategory) {
                displayRules = getFiltersByCategory(filterState.selectedCategory);
            } else {
                displayRules = [...appData.filters];
            }
            
            // 应用搜索筛选
            if (filterState.searchTerm) {
                displayRules = displayRules.filter(rule => {
                    const searchTerm = filterState.searchTerm.toLowerCase();
                    return rule.name.toLowerCase().includes(searchTerm) ||
                           rule.regex.toLowerCase().includes(searchTerm) ||
                           (rule.replace && rule.replace.toLowerCase().includes(searchTerm)) ||
                           (rule.tags && rule.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
                });
            }
            
            // 排序
            displayRules.sort((a, b) => {
                if (a.pinned !== b.pinned) return b.pinned - a.pinned;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            if (displayRules.length === 0) {
                const emptyMessage = filterState.searchTerm ? 
                    `未找到包含"${filterState.searchTerm}"的规则` :
                    filterState.selectedCategory ? 
                        `分类"${filterState.selectedCategory}"中暂无规则` :
                        '还没有过滤规则，点击上方按钮添加第一个规则吧！';
                        
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <p>${emptyMessage}</p>
                    </div>
                `;
                return;
            }
            
            // 渲染规则列表
            container.innerHTML = displayRules.map(rule => {
                const isSelected = filterState.selectedRules.has(rule.id);
                const previewText = rule.replace ? 
                    `/${rule.regex}/ → "${rule.replace}"` : 
                    `/${rule.regex}/ → [删除]`;
                
                // 构建详细信息
                const categoryPath = rule.group || '未分组';
                const tagsHtml = rule.tags && rule.tags.length > 0 ? 
                    rule.tags.map(tag => `<span class="rule-tag">${escapeHtml(tag)}</span>`).join('') : '';
                const usageInfo = `使用 ${rule.usageCount || 0} 次`;
                const createdDate = rule.createdAt ? new Date(rule.createdAt).toLocaleDateString() : '';
                
                return `
                    <div class="rule-item ${rule.active ? 'active' : ''} ${isSelected ? 'selected' : ''}" id="rule-${rule.id}">
                        <div class="rule-checkbox">
                            <input type="checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleRuleSelection('${rule.id}')"
                                   title="${isSelected ? '取消选择' : '选择规则'}">
                        </div>
                        <div class="rule-info" onclick="toggleRuleSelection('${rule.id}')" style="cursor: pointer;">
                            <div class="rule-header">
                                <div class="rule-name">${escapeHtml(rule.name)}</div>
                                <div class="rule-status">
                                    ${rule.active ? '<span class="status-badge active">已启用</span>' : '<span class="status-badge inactive">已停用</span>'}
                                    ${rule.pinned ? '<span class="status-badge pinned">📌</span>' : ''}
                                </div>
                            </div>
                            <div class="rule-preview">${escapeHtml(previewText)}</div>
                            <div class="rule-details">
                                <div class="rule-detail-row">
                                    <span class="detail-label">📁 分类：</span>
                                    <span class="detail-value">${escapeHtml(categoryPath)}</span>
                                </div>
                                ${tagsHtml ? `
                                    <div class="rule-detail-row">
                                        <span class="detail-label">🏷️ 标签：</span>
                                        <span class="detail-value">${tagsHtml}</span>
                                    </div>
                                ` : ''}
                                <div class="rule-detail-row">
                                    <span class="detail-label">📊 统计：</span>
                                    <span class="detail-value">${usageInfo}${createdDate ? ` · 创建于 ${createdDate}` : ''}</span>
                                </div>
                            </div>
                        </div>
                        <div class="rule-actions">
                            <button class="btn ${rule.active ? 'btn-success' : 'btn-secondary'}" 
                                    onclick="toggleFilter('${rule.id}')" 
                                    title="${rule.active ? '停用规则' : '启用规则'}">
                                ${rule.active ? '🔓' : '🔒'}
                            </button>
                            <button class="btn btn-primary" 
                                    onclick="editFilter('${rule.id}')" 
                                    title="编辑规则">✏️</button>
                            <button class="btn btn-danger" 
                                    onclick="deleteFilter('${rule.id}')" 
                                    title="删除规则">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 更新过滤器统计信息
        function updateFilterStats() {
            const activeCount = appData.filters.filter(f => f.active).length;
            const totalCount = appData.filters.length;
            
            const activeCountElement = document.getElementById('activeFilterCount');
            const totalCountElement = document.getElementById('totalFilterCount');
            
            if (activeCountElement) activeCountElement.textContent = activeCount;
            if (totalCountElement) totalCountElement.textContent = totalCount;
        }

        // 更新操作按钮状态
        function updateActionButtons() {
            const enableBtn = document.getElementById('enableFiltersBtn');
            const disableBtn = document.getElementById('disableFiltersBtn');
            const testBtn = document.getElementById('testFiltersBtn');
            
            const selectedCount = filterState.selectedRules.size;
            
            if (selectedCount > 0) {
                if (enableBtn) {
                    enableBtn.style.display = 'inline-block';
                    enableBtn.textContent = `🔓 启用选中规则 (${selectedCount})`;
                }
                if (disableBtn) {
                    disableBtn.style.display = 'inline-block';
                    disableBtn.textContent = `🔒 停用选中规则 (${selectedCount})`;
                }
                if (testBtn) {
                    testBtn.style.display = 'inline-block';
                    testBtn.textContent = `🧪 测试选中规则 (${selectedCount})`;
                }
            } else {
                if (enableBtn) enableBtn.style.display = 'none';
                if (disableBtn) disableBtn.style.display = 'none';
                if (testBtn) testBtn.style.display = 'none';
            }
        }

        // 更新显示状态
        function updateFilterDisplay() {
            renderFilterCategoryTree();
            renderFilterRulesList();
            updateFilterStats();
        }

        function toggleFilter(id) {
            const filter = appData.filters.find(f => f.id === id);
            if (filter) {
                filter.active = !filter.active;
                saveData();
                renderFilters();
                updateFilterGroups();
                testFilters();
                showToast(filter.active ? '规则已启用' : '规则已禁用');
            }
        }

        function deleteFilter(id) {
            if (confirm('确定要删除这个过滤规则吗？')) {
                appData.filters = appData.filters.filter(f => f.id !== id);
                saveData();
                renderFilters();
                updateFilterGroups();
                showToast('过滤规则已删除');
            }
        }

        function editFilter(id) {
            const filter = appData.filters.find(f => f.id === id);
            if (filter) {
                // 设置编辑状态
                editState = {
                    type: 'filter',
                    id: id,
                    isEditing: true
                };
                
                // 填充表单
                document.getElementById('filterName').value = filter.name;
                document.getElementById('filterRegex').value = filter.regex;
                document.getElementById('filterReplace').value = filter.replace || '';
                document.getElementById('filterGroup').value = filter.group;
                document.getElementById('filterTags').value = (filter.tags || []).join(', ');
                document.getElementById('filterPinned').checked = filter.pinned;
                
                // 更新模态框标题
                const modal = document.getElementById('addFilterModal');
                const modalTitle = modal.querySelector('.modal-title');
                modalTitle.textContent = '编辑过滤规则';
                
                openModal('addFilterModal');
            }
        }

        function updateFilterGroups() {
            const groups = [...new Set(appData.filters.map(f => f.group))];
            const container = document.getElementById('filterGroups');
            
            if (!container) return;
            
            if (groups.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; margin: 10px 0;">暂无规则组</p>';
                return;
            }
            
            container.innerHTML = groups.map((group, index) => {
                const safeGroup = group.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                const groupFilters = appData.filters.filter(f => f.group === group);
                const activeCount = groupFilters.filter(f => f.active).length;
                const totalCount = groupFilters.length;
                const isAllActive = activeCount === totalCount && totalCount > 0;
                
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" id="group_${index}" ${isAllActive ? 'checked' : ''} onchange="toggleFilterGroup('${safeGroup}')">
                        <label for="group_${index}">${escapeHtml(group)} (${activeCount}/${totalCount})</label>
                    </div>
                `;
            }).join('');
        }

        function toggleFilterGroup(group) {
            const checkbox = document.getElementById(`group_${group}`);
            const groupFilters = appData.filters.filter(f => f.group === group);
            
            groupFilters.forEach(filter => {
                filter.active = checkbox.checked;
            });
            
            saveData();
            renderFilters();
            updateFilterGroups();
            testFilters();
            showToast(`规则组 "${group}" 已${checkbox.checked ? '启用' : '禁用'}`);
        }

        function selectAllFilters() {
            appData.filters.forEach(filter => {
                filterState.selectedRules.add(filter.id);
            });
            updateFilterDisplay();
            updateActionButtons();
            renderCurrentSelection();
            showToast('所有规则已选中');
        }

        function clearAllFilters() {
            filterState.selectedRules.clear();
            updateFilterDisplay();
            updateActionButtons();
            renderCurrentSelection();
            showToast('已清空规则选择');
        }

        function applyFilters() {
            testSelectedFilters();
        }

        function testFilters(preserveSelection = false) {
            const testInput = document.getElementById('testInput');
            const testResult = document.getElementById('testResult');
            
            if (!testInput || !testResult) return;
            
            const inputText = testInput.value;
            if (!inputText.trim()) {
                testResult.value = '';
                if (!preserveSelection) {
                    clearAllSelections();
                }
                return;
            }
            
            // 保存当前光标位置和焦点状态
            const wasInputFocused = document.activeElement === testInput;
            const savedSelectionStart = testInput.selectionStart;
            const savedSelectionEnd = testInput.selectionEnd;
            
            // 获取当前激活的规则
            const activeFilters = appData.filters.filter(f => f.active);
            
            let processedText = inputText;
            let appliedCount = 0;
            
            activeFilters.forEach(filter => {
                try {
                    const regex = new RegExp(filter.regex, 'gi');
                    const beforeLength = processedText.length;
                    
                    if (filter.replace) {
                        processedText = processedText.replace(regex, filter.replace);
                    } else {
                        processedText = processedText.replace(regex, '');
                    }
                    
                    if (processedText.length !== beforeLength) {
                        appliedCount++;
                        filter.usageCount = (filter.usageCount || 0) + 1;
                    }
                } catch (error) {
                    console.warn('Filter regex error:', filter.regex, error);
                }
            });
            
            testResult.value = processedText;
            
            // 在保留选择模式下（用户输入时），恢复光标位置和焦点
            if (preserveSelection && wasInputFocused && 
                savedSelectionStart !== undefined && savedSelectionEnd !== undefined) {
                // 使用requestAnimationFrame确保DOM更新完成后再恢复状态
                requestAnimationFrame(() => {
                    try {
                        testInput.focus();
                        testInput.setSelectionRange(savedSelectionStart, savedSelectionEnd);
                    } catch (error) {
                        console.warn('Failed to restore cursor position:', error);
                    }
                });
            } else if (!preserveSelection) {
                // 只有在非输入调用时才清除选中状态
                clearAllSelections();
            }
            
            // 保存使用统计
            if (appliedCount > 0) {
                saveData();
            }
        }

        // 专门用于输入时的处理函数
        function testFiltersOnInput() {
            testFilters(true); // 保持选中状态
        }
        
        function clearTestInput() {
            const testInput = document.getElementById('testInput');
            if (testInput) {
                testInput.value = '';
                clearAllSelections(); // 清除选中状态
                testFilters();
            }
        }
        
        function clearTestResult() {
            const testResult = document.getElementById('testResult');
            if (testResult) {
                testResult.value = '';
                clearAllSelections(); // 清除选中状态
            }
        }

        // 初始化测试面板的同步滚动功能
        function initTestPanelSyncScroll() {
            const testInput = document.getElementById('testInput');
            const testResult = document.getElementById('testResult');
            
            if (!testInput || !testResult) return;
            
            let isSyncing = false;
            
            // 同步滚动函数
            function syncScroll(source, target) {
                if (isSyncing) return;
                isSyncing = true;
                
                const sourceRatio = source.scrollTop / (source.scrollHeight - source.clientHeight);
                const targetScrollTop = sourceRatio * (target.scrollHeight - target.clientHeight);
                target.scrollTop = targetScrollTop;
                
                setTimeout(() => { isSyncing = false; }, 10);
            }
            
            // 绑定滚动事件
            testInput.addEventListener('scroll', () => syncScroll(testInput, testResult));
            testResult.addEventListener('scroll', () => syncScroll(testResult, testInput));
            
            // 初始化选中同步功能
            initTextSelectionSync();
        }

        // 文本选中同步功能
        function initTextSelectionSync() {
            const testInput = document.getElementById('testInput');
            const testResult = document.getElementById('testResult');
            
            if (!testInput || !testResult) return;
            
            let isUpdatingSelection = false;
            let lastSelection = { input: null, result: null };
            let inputDebounceTimer = null;
            let isProcessingInput = false;
            
            // 绑定输入事件，使用防抖，防止光标跳动
            testInput.addEventListener('input', (e) => {
                if (isProcessingInput) return; // 防止递归调用
                
                if (inputDebounceTimer) {
                    clearTimeout(inputDebounceTimer);
                }
                
                inputDebounceTimer = setTimeout(() => {
                    isProcessingInput = true;
                    testFiltersOnInput();
                    isProcessingInput = false;
                }, 250); // 减少防抖时间到250ms以提高响应性
            });
            
            // 鼠标选中事件 - 确保不会干扰正常的文本输入
            testInput.addEventListener('mouseup', () => {
                if (!isUpdatingSelection && !isProcessingInput) {
                    // 延迟处理，确保鼠标事件完成
                    setTimeout(() => handleSelectionChange('input'), 100);
                }
            });
            
            // 键盘选中事件，只处理选择相关的导航键，不处理普通输入
            testInput.addEventListener('keyup', (e) => {
                if (!isUpdatingSelection && !isProcessingInput) {
                    // 只处理选择导航键组合（Shift + 方向键等）
                    if (e.shiftKey && (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
                                      e.key === 'ArrowUp' || e.key === 'ArrowDown' || 
                                      e.key === 'Home' || e.key === 'End' || 
                                      e.key === 'PageUp' || e.key === 'PageDown')) {
                        setTimeout(() => handleSelectionChange('input'), 50);
                    }
                }
            });
            
            // 处理Ctrl+A全选事件
            testInput.addEventListener('keydown', (e) => {
                if (!isUpdatingSelection && e.ctrlKey && e.key === 'a') {
                    setTimeout(() => handleSelectionChange('input'), 50);
                }
            });
            
            testResult.addEventListener('mouseup', () => {
                if (!isUpdatingSelection && !isProcessingInput) {
                    setTimeout(() => handleSelectionChange('result'), 100);
                }
            });
            
            testResult.addEventListener('keyup', (e) => {
                if (!isUpdatingSelection && !isProcessingInput) {
                    if (e.shiftKey && (e.key === 'ArrowLeft' || e.key === 'ArrowRight' || 
                                      e.key === 'ArrowUp' || e.key === 'ArrowDown' || 
                                      e.key === 'Home' || e.key === 'End' || 
                                      e.key === 'PageUp' || e.key === 'PageDown')) {
                        setTimeout(() => handleSelectionChange('result'), 50);
                    }
                }
            });
            
            testResult.addEventListener('keydown', (e) => {
                if (!isUpdatingSelection && e.ctrlKey && e.key === 'a') {
                    setTimeout(() => handleSelectionChange('result'), 50);
                }
            });
            
            function handleSelectionChange(source) {
                if (isUpdatingSelection) return;
                
                const sourceElement = source === 'input' ? testInput : testResult;
                const targetElement = source === 'input' ? testResult : testInput;
                
                const selectionStart = sourceElement.selectionStart;
                const selectionEnd = sourceElement.selectionEnd;
                
                // 检查选中是否真的发生了变化
                const currentSelection = { start: selectionStart, end: selectionEnd };
                if (lastSelection[source] && 
                    lastSelection[source].start === selectionStart && 
                    lastSelection[source].end === selectionEnd) {
                    return; // 选中没有变化，不处理
                }
                
                lastSelection[source] = currentSelection;
                
                if (selectionStart === selectionEnd) {
                    // 没有选中文本，清除对面的选中
                    clearTargetSelection(targetElement, source === 'input' ? 'result' : 'input');
                    return;
                }
                
                // 计算对应的选中范围
                const mappedRange = calculateMappedSelection(
                    selectionStart, 
                    selectionEnd, 
                    source === 'input' ? 'input-to-result' : 'result-to-input'
                );
                
                if (mappedRange && mappedRange.start !== mappedRange.end) {
                    syncSelectionToTarget(targetElement, mappedRange, source === 'input' ? 'result' : 'input');
                }
            }
            
            function syncSelectionToTarget(targetElement, mappedRange, targetType) {
                if (isUpdatingSelection || isProcessingInput) return;
                
                isUpdatingSelection = true;
                
                try {
                    // 使用requestAnimationFrame确保在正确的时机设置选择
                    requestAnimationFrame(() => {
                        try {
                            // 验证选择范围的有效性
                            const textLength = targetElement.value.length;
                            const start = Math.min(Math.max(0, mappedRange.start), textLength);
                            const end = Math.min(Math.max(start, mappedRange.end), textLength);
                            
                            if (start !== end && start < textLength) {
                                targetElement.setSelectionRange(start, end);
                                
                                // 更新记录，防止循环
                                lastSelection[targetType] = { start, end };
                                
                                // 添加视觉反馈
                                targetElement.classList.add('syncing-selection');
                                setTimeout(() => {
                                    targetElement.classList.remove('syncing-selection');
                                }, 300);
                            }
                        } catch (innerError) {
                            console.warn('Inner selection sync error:', innerError);
                        } finally {
                            // 确保标志被重置
                            setTimeout(() => {
                                isUpdatingSelection = false;
                            }, 150);
                        }
                    });
                } catch (error) {
                    console.warn('Selection sync error:', error);
                    isUpdatingSelection = false;
                }
            }
            
            function clearTargetSelection(targetElement, targetType) {
                if (isUpdatingSelection || isProcessingInput) return;
                
                isUpdatingSelection = true;
                
                try {
                    requestAnimationFrame(() => {
                        try {
                            // 只有当目标确实有选中时才清除
                            if (targetElement.selectionStart !== targetElement.selectionEnd) {
                                const currentPos = targetElement.selectionStart;
                                targetElement.setSelectionRange(currentPos, currentPos);
                                lastSelection[targetType] = { start: currentPos, end: currentPos };
                            }
                        } catch (innerError) {
                            console.warn('Inner clear selection error:', innerError);
                        } finally {
                            setTimeout(() => {
                                isUpdatingSelection = false;
                            }, 100);
                        }
                    });
                } catch (error) {
                    console.warn('Clear selection error:', error);
                    isUpdatingSelection = false;
                }
            }
            
            function calculateMappedSelection(start, end, direction) {
                const sourceText = direction === 'input-to-result' ? testInput.value : testResult.value;
                const targetText = direction === 'input-to-result' ? testResult.value : testInput.value;
                
                if (!sourceText || !targetText) return null;
                
                const sourceLength = sourceText.length;
                const targetLength = targetText.length;
                
                if (sourceLength === 0 || targetLength === 0) return null;
                
                // 使用基于行的智能映射
                return calculateLineBasedMapping(start, end, direction, sourceText, targetText);
            }
            
            function calculateLineBasedMapping(start, end, direction, sourceText, targetText) {
                // 优先使用智能词语匹配
                const intelligentMapping = calculateIntelligentMapping(start, end, direction, sourceText, targetText);
                if (intelligentMapping) {
                    return intelligentMapping;
                }
                
                // 回退到行基础映射
                return calculateProportionalMapping(start, end, sourceText, targetText);
            }
            
            function calculateIntelligentMapping(start, end, direction, sourceText, targetText) {
                const selectedText = sourceText.substring(start, end);
                
                // 如果选中的文本太短或为空，使用比例映射
                if (!selectedText || selectedText.length < 2) {
                    return calculateProportionalMapping(start, end, sourceText, targetText);
                }
                
                // 先尝试完全匹配
                let targetIndex = targetText.indexOf(selectedText);
                if (targetIndex !== -1) {
                    return {
                        start: targetIndex,
                        end: targetIndex + selectedText.length
                    };
                }
                
                // 尝试trim后的匹配
                const trimmedText = selectedText.trim();
                if (trimmedText && trimmedText !== selectedText) {
                    targetIndex = targetText.indexOf(trimmedText);
                    if (targetIndex !== -1) {
                        return {
                            start: targetIndex,
                            end: targetIndex + trimmedText.length
                        };
                    }
                }
                
                // 对于较长的文本，尝试关键词匹配
                if (selectedText.length >= 10) {
                    const words = selectedText.split(/\s+/).filter(word => word.length >= 3);
                    if (words.length > 0) {
                        // 寻找第一个和最后一个关键词的位置
                        const firstWordIndex = targetText.indexOf(words[0]);
                        const lastWordIndex = words.length > 1 ? targetText.lastIndexOf(words[words.length - 1]) : firstWordIndex;
                        
                        if (firstWordIndex !== -1 && lastWordIndex !== -1 && lastWordIndex >= firstWordIndex) {
                            const endPos = lastWordIndex + words[words.length - 1].length;
                            return {
                                start: firstWordIndex,
                                end: Math.min(endPos, targetText.length)
                            };
                        }
                    }
                }
                
                // 如果智能匹配失败，返回null使用比例映射
                return null;
            }
            
            function calculateProportionalMapping(start, end, sourceText, targetText) {
                const sourceLength = sourceText.length;
                const targetLength = targetText.length;
                
                if (sourceLength === 0 || targetLength === 0) {
                    return { start: 0, end: 0 };
                }
                
                const startRatio = start / sourceLength;
                const endRatio = end / sourceLength;
                
                let mappedStart = Math.floor(startRatio * targetLength);
                let mappedEnd = Math.ceil(endRatio * targetLength);
                
                // 确保至少选中1个字符
                if (mappedEnd <= mappedStart) {
                    mappedEnd = mappedStart + 1;
                }
                
                // 确保范围在有效区间内
                mappedStart = Math.max(0, Math.min(mappedStart, targetLength - 1));
                mappedEnd = Math.max(mappedStart + 1, Math.min(mappedEnd, targetLength));
                
                return {
                    start: mappedStart,
                    end: mappedEnd
                };
            }
        }

        // 清除所有选中状态的全局函数
        function clearAllSelections() {
            const testInput = document.getElementById('testInput');
            const testResult = document.getElementById('testResult');
            
            try {
                if (testInput && testInput.selectionStart !== testInput.selectionEnd) {
                    const currentPos = testInput.selectionStart;
                    testInput.setSelectionRange(currentPos, currentPos);
                }
                if (testResult && testResult.selectionStart !== testResult.selectionEnd) {
                    const currentPos = testResult.selectionStart;
                    testResult.setSelectionRange(currentPos, currentPos);
                }
            } catch (error) {
                console.warn('Clear all selections error:', error);
            }
        }
        
        function copyOriginalText() {
            const testInput = document.getElementById('testInput');
            if (!testInput || !testInput.value.trim()) {
                showToast('没有原文可复制', 'error');
                return;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(testInput.value).then(() => {
                    showToast('原文已复制到剪贴板');
                }).catch(() => {
                    fallbackCopyTextToClipboard(testInput.value);
                });
            } else {
                fallbackCopyTextToClipboard(testInput.value);
            }
        }
        
        function copyTestResult() {
            const testResult = document.getElementById('testResult');
            if (!testResult || !testResult.value.trim()) {
                showToast('没有结果可复制', 'error');
                return;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(testResult.value).then(() => {
                    showToast('过滤结果已复制到剪贴板');
                }).catch(() => {
                    fallbackCopyTextToClipboard(testResult.value);
                });
            } else {
                fallbackCopyTextToClipboard(testResult.value);
            }
        }
        
        function copyEditedResult() {
            const testResult = document.getElementById('testResult');
            if (!testResult || !testResult.value.trim()) {
                showToast('没有内容可复制', 'error');
                return;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(testResult.value).then(() => {
                    showToast('编辑后的结果已复制到剪贴板');
                }).catch(() => {
                    fallbackCopyTextToClipboard(testResult.value);
                });
            } else {
                fallbackCopyTextToClipboard(testResult.value);
            }
        }

        function processText(text) {
            if (!text) return '';
            
            const activeFilters = appData.filters.filter(f => f.active);
            let result = text;
            let hasChanges = false;
            
            activeFilters.forEach(filter => {
                try {
                    const regex = new RegExp(filter.regex, 'gi'); // 添加不区分大小写
                    const beforeReplace = result;
                    result = result.replace(regex, filter.replace || '');
                    if (beforeReplace !== result) {
                        filter.usageCount++;
                        hasChanges = true;
                    }
                } catch (error) {
                    console.error(`过滤规则 "${filter.name}" 执行失败:`, error);
                    showToast(`规则 "${filter.name}" 执行失败: ${error.message}`, 'error');
                }
            });
            
            if (hasChanges) {
                saveData();
            }
            
            return result;
        }
        
        function toggleGroup(groupName) {
            if (!appData.settings.collapsedGroups) {
                appData.settings.collapsedGroups = [];
            }
            
            const index = appData.settings.collapsedGroups.indexOf(groupName);
            const groupId = `group_${groupName.replace(/\s+/g, '_')}`;
            const content = document.getElementById(`content_${groupId}`);
            const toggle = document.querySelector(`#content_${groupId}`).parentElement.querySelector('.group-toggle');
            
            if (index > -1) {
                // 展开
                appData.settings.collapsedGroups.splice(index, 1);
                if (content) content.classList.remove('collapsed');
                if (toggle) toggle.classList.add('expanded');
            } else {
                // 折叠
                appData.settings.collapsedGroups.push(groupName);
                if (content) content.classList.add('collapsed');
                if (toggle) toggle.classList.remove('expanded');
            }
            
            saveData();
        }

        // 通用功能函数
        function togglePin(type, id) {
            const items = appData[type];
            const item = items.find(i => i.id === id);
            if (item) {
                item.pinned = !item.pinned;
                saveData();
                
                if (type === 'prompts') renderPrompts();
                else if (type === 'websites') renderWebsites();
                else if (type === 'filters') renderFilters();
                
                showToast(item.pinned ? '已置顶' : '已取消置顶');
            }
        }

        function filterItems(type) {
            if (type === 'prompts') renderPrompts();
            else if (type === 'websites') renderWebsites();
        }

        function sortItems(type) {
            if (type === 'prompts') renderPrompts();
            else if (type === 'websites') renderWebsites();
        }

        function updateCategories() {
            try {
                // 更新提示词分类
                updatePromptCategories();
                
                // 更新网站分类
                updateWebsiteCategories();
                
                // 更新过滤器分组
                updateFilterGroups();
                
            } catch (error) {
                console.error('更新分类时出错:', error);
                showToast('分类更新失败', 'error');
            }
        }
        
        function updatePromptCategories() {
            const promptCategories = appData.prompts
                .map(p => p.category || '默认')
                .filter(cat => cat && cat.trim());
            
            const promptCategorySelect = document.getElementById('promptCategory');
            const promptCategoryDatalist = document.getElementById('promptCategories');
            
            if (promptCategorySelect) {
                const currentValue = promptCategorySelect.value;
                const promptTree = buildCategoryTree(promptCategories);
                const defaultOption = '<option value="">📁 所有分类</option>';
                const treeOptions = renderCategoryTree(promptTree, 0, 'select');
                
                promptCategorySelect.innerHTML = defaultOption + treeOptions;
                
                // 恢复之前选择的值
                if (currentValue && promptCategorySelect.querySelector(`option[value="${currentValue}"]`)) {
                    promptCategorySelect.value = currentValue;
                }
            }
            
            if (promptCategoryDatalist) {
                const uniqueCategories = [...new Set(promptCategories)];
                promptCategoryDatalist.innerHTML = uniqueCategories
                    .filter(cat => cat !== '默认')
                    .map(cat => `<option value="${escapeHtml(cat)}"></option>`)
                    .join('');
            }
        }
        
        function updateWebsiteCategories() {
            const websiteCategories = appData.websites
                .map(w => w.category || '默认')
                .filter(cat => cat && cat.trim());
            
            const websiteCategorySelect = document.getElementById('websiteCategory');
            const websiteCategoryDatalist = document.getElementById('websiteCategories');
            
            if (websiteCategorySelect) {
                const currentValue = websiteCategorySelect.value;
                const websiteTree = buildCategoryTree(websiteCategories);
                const defaultOption = '<option value="">🌐 所有分类</option>';
                const treeOptions = renderCategoryTree(websiteTree, 0, 'select');
                
                websiteCategorySelect.innerHTML = defaultOption + treeOptions;
                
                // 恢复之前选择的值
                if (currentValue && websiteCategorySelect.querySelector(`option[value="${currentValue}"]`)) {
                    websiteCategorySelect.value = currentValue;
                }
            }
            
            if (websiteCategoryDatalist) {
                const uniqueCategories = [...new Set(websiteCategories)];
                websiteCategoryDatalist.innerHTML = uniqueCategories
                    .filter(cat => cat !== '默认')
                    .map(cat => `<option value="${escapeHtml(cat)}"></option>`)
                    .join('');
            }
        }
        
        function updateFilterGroups() {
            const filterGroups = [...new Set(appData.filters.map(f => f.group || '未分组'))];
            const filterGroupDatalist = document.getElementById('filterGroups');
            
            if (filterGroupDatalist) {
                filterGroupDatalist.innerHTML = filterGroups
                    .filter(group => group && group.trim())
                    .map(group => `<option value="${escapeHtml(group)}"></option>`)
                    .join('');
            }
        }

        function updateStats() {
            document.getElementById('promptsCount').textContent = appData.prompts.length;
            document.getElementById('websitesCount').textContent = appData.websites.length;
            document.getElementById('filtersCount').textContent = appData.filters.length;
            
            const totalUsage = appData.prompts.reduce((sum, p) => sum + p.usageCount, 0) + 
                             appData.websites.reduce((sum, w) => sum + w.usageCount, 0) + 
                             appData.filters.reduce((sum, f) => sum + f.usageCount, 0);
            document.getElementById('totalUsage').textContent = totalUsage;
        }

        // 数据导入导出
        function exportData(type) {
            showExportDialog(type);
        }

        function showExportDialog(type) {
            const dialog = document.createElement('div');
            dialog.className = 'export-dialog-overlay';
            dialog.innerHTML = `
                <div class="export-dialog">
                    <h3>选择导出格式</h3>
                    <p>选择您偏好的数据导出格式：</p>
                    
                    <div class="export-options">
                        <button class="export-option" onclick="doExportData('${type}', 'json')">
                            <div class="option-icon">📄</div>
                            <div class="option-content">
                                <strong>JSON格式</strong>
                                <small>程序员友好，包含完整数据结构</small>
                            </div>
                        </button>
                        
                        <button class="export-option" onclick="doExportData('${type}', 'csv')">
                            <div class="option-icon">📊</div>
                            <div class="option-content">
                                <strong>CSV格式</strong>
                                <small>Excel可直接打开的表格格式</small>
                            </div>
                        </button>
                        
                        <button class="export-option" onclick="doExportData('${type}', 'excel')">
                            <div class="option-icon">📈</div>
                            <div class="option-content">
                                <strong>Excel格式</strong>
                                <small>专业的电子表格文件(.xlsx)</small>
                            </div>
                        </button>
                        
                        <button class="export-option" onclick="doExportData('${type}', 'text')">
                            <div class="option-icon">📝</div>
                            <div class="option-content">
                                <strong>纯文本格式</strong>
                                <small>简洁易读的文本文件</small>
                            </div>
                        </button>
                    </div>
                    
                    <div class="export-dialog-buttons">
                        <button class="btn btn-secondary" onclick="closeExportDialog()">取消</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }

        function closeExportDialog() {
            const dialog = document.querySelector('.export-dialog-overlay');
            if (dialog) {
                dialog.remove();
            }
        }

        function doExportData(type, format) {
            closeExportDialog();
            
            try {
                let data, filename;
                const dateStr = new Date().toISOString().split('T')[0];
                
                if (type === 'prompts') {
                    data = appData.prompts;
                    filename = `prompts_${dateStr}`;
                } else if (type === 'websites') {
                    data = appData.websites;
                    filename = `websites_${dateStr}`;
                } else if (type === 'filters') {
                    data = appData.filters;
                    filename = `filters_${dateStr}`;
                } else if (type === 'presets') {
                    data = filterState.presets;
                    filename = `filter_presets_${dateStr}`;
                } else {
                    data = appData;
                    filename = `prompt_manager_backup_${dateStr}`;
                }
                
                if (!data || (Array.isArray(data) && data.length === 0)) {
                    showToast('没有数据可导出', 'error');
                    return;
                }
                
                switch (format) {
                    case 'json':
                        downloadJSON(data, filename + '.json');
                        break;
                    case 'csv':
                        downloadCSV(data, type, filename + '.csv');
                        break;
                    case 'excel':
                        downloadExcel(data, type, filename + '.xlsx');
                        break;
                    case 'text':
                        downloadText(data, type, filename + '.txt');
                        break;
                }
                
                showToast(`数据已导出为${format.toUpperCase()}格式`);
            } catch (error) {
                console.error('Export error:', error);
                showToast('导出失败', 'error');
            }
        }

        function exportAllData() {
            const filename = `prompt_manager_backup_${new Date().toISOString().split('T')[0]}.json`;
            // 添加元数据
            const exportData = {
                ...appData,
                meta: {
                    version: '2.0.0',
                    exportDate: new Date().toISOString(),
                    totalItems: appData.prompts.length + appData.websites.length + appData.filters.length
                }
            };
            downloadJSON(exportData, filename);
            showToast('全部数据已导出');
        }

        function downloadJSON(data, filename) {
            try {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                downloadFile(blob, filename);
            } catch (error) {
                console.error('Download error:', error);
                showToast('下载失败', 'error');
            }
        }

        function downloadCSV(data, type, filename) {
            try {
                let csvContent = '';
                let headers = [];
                let rows = [];

                if (type === 'prompts' || (type === 'all' && data.prompts)) {
                    const prompts = type === 'prompts' ? data : data.prompts;
                    headers = ['标题', '内容', '分类', '标签', '固定', '使用次数', '创建时间', '更新时间'];
                    rows = prompts.map(item => [
                        item.title || '',
                        escapeSpecialChars(item.content || '').replace(/"/g, '""'),
                        item.category || '',
                        (item.tags || []).join(';'),
                        item.pinned ? '是' : '否',
                        item.usageCount || 0,
                        item.createdAt || '',
                        item.updatedAt || ''
                    ]);
                } else if (type === 'websites' || (type === 'all' && data.websites)) {
                    const websites = type === 'websites' ? data : data.websites;
                    headers = ['标题', '网址', '描述', '分类', '标签', '固定', '使用次数', '创建时间', '更新时间'];
                    rows = websites.map(item => [
                        item.title || '',
                        item.url || '',
                        escapeSpecialChars(item.description || '').replace(/"/g, '""'),
                        item.category || '',
                        (item.tags || []).join(';'),
                        item.pinned ? '是' : '否',
                        item.usageCount || 0,
                        item.createdAt || '',
                        item.updatedAt || ''
                    ]);
                } else if (type === 'filters' || (type === 'all' && data.filters)) {
                    const filters = type === 'filters' ? data : data.filters;
                    headers = ['名称', '正则表达式', '替换内容', '分组', '标签', '固定', '激活', '使用次数', '创建时间', '更新时间'];
                    rows = filters.map(item => [
                        item.name || '',
                        (item.regex || '').replace(/"/g, '""'),
                        (item.replace || '').replace(/"/g, '""'),
                        item.group || '',
                        (item.tags || []).join(';'),
                        item.pinned ? '是' : '否',
                        item.active ? '是' : '否',
                        item.usageCount || 0,
                        item.createdAt || '',
                        item.updatedAt || ''
                    ]);
                } else if (type === 'presets') {
                    headers = ['预设名称', '描述', '包含规则数', '规则ID列表', '启用状态', '创建时间'];
                    rows = data.map(item => [
                        item.name || '',
                        (item.description || '').replace(/"/g, '""'),
                        (item.ruleIds || []).length,
                        (item.ruleIds || []).join(';'),
                        item.enabled ? '是' : '否',
                        item.createdAt || ''
                    ]);
                }

                // 构建CSV内容，使用UTF-8 BOM确保中文显示正确
                csvContent = '\uFEFF'; // UTF-8 BOM
                csvContent += headers.map(header => `"${header}"`).join(',') + '\n';
                csvContent += rows.map(row => 
                    row.map(cell => `"${cell}"`).join(',')
                ).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                downloadFile(blob, filename);
            } catch (error) {
                console.error('CSV Export error:', error);
                showToast('CSV导出失败', 'error');
            }
        }

        function downloadExcel(data, type, filename) {
            try {
                // 由于真正的Excel文件生成需要复杂的ZIP库，这里转为CSV格式
                // 并在文件名中说明格式
                const csvFilename = filename.replace('.xlsx', '.csv');
                showToast('Excel格式暂不支持，已转为CSV格式（可在Excel中直接打开）', 'info');
                downloadCSV(data, type, csvFilename);
            } catch (error) {
                console.error('Excel Export error:', error);
                showToast('导出失败', 'error');
            }
        }

        function downloadText(data, type, filename) {
            try {
                let textContent = '';
                const dateStr = new Date().toLocaleDateString('zh-CN');
                
                textContent += `导出时间：${dateStr}\n`;
                textContent += `数据类型：${getModuleDisplayName(type)}\n`;
                textContent += '='.repeat(50) + '\n\n';

                if (type === 'prompts' || (type === 'all' && data.prompts)) {
                    const prompts = type === 'prompts' ? data : data.prompts;
                    textContent += `共 ${prompts.length} 个提示词：\n\n`;
                    prompts.forEach((item, index) => {
                        textContent += `${index + 1}. ${item.title || '无标题'}\n`;
                        textContent += `   分类：${item.category || '未分类'}\n`;
                        textContent += `   标签：${(item.tags || []).join(', ') || '无'}\n`;
                        textContent += `   内容：${escapeSpecialChars(item.content || '无内容')}\n`;
                        textContent += `   使用次数：${item.usageCount || 0}\n`;
                        textContent += `   ${item.pinned ? '★ 已固定' : ''}\n`;
                        textContent += `-`.repeat(40) + '\n\n';
                    });
                } else if (type === 'websites' || (type === 'all' && data.websites)) {
                    const websites = type === 'websites' ? data : data.websites;
                    textContent += `共 ${websites.length} 个网站：\n\n`;
                    websites.forEach((item, index) => {
                        textContent += `${index + 1}. ${item.title || '无标题'}\n`;
                        textContent += `   网址：${item.url || '无网址'}\n`;
                        textContent += `   分类：${item.category || '未分类'}\n`;
                        textContent += `   标签：${(item.tags || []).join(', ') || '无'}\n`;
                        textContent += `   描述：${escapeSpecialChars(item.description || '无描述')}\n`;
                        textContent += `   使用次数：${item.usageCount || 0}\n`;
                        textContent += `   ${item.pinned ? '★ 已固定' : ''}\n`;
                        textContent += `-`.repeat(40) + '\n\n';
                    });
                } else if (type === 'filters' || (type === 'all' && data.filters)) {
                    const filters = type === 'filters' ? data : data.filters;
                    textContent += `共 ${filters.length} 个过滤规则：\n\n`;
                    filters.forEach((item, index) => {
                        textContent += `${index + 1}. ${item.name || '无名称'}\n`;
                        textContent += `   分组：${item.group || '未分组'}\n`;
                        textContent += `   标签：${(item.tags || []).join(', ') || '无'}\n`;
                        textContent += `   正则：${item.regex || '无'}\n`;
                        textContent += `   替换：${item.replace || '无'}\n`;
                        textContent += `   状态：${item.active ? '✓ 激活' : '✗ 未激活'}\n`;
                        textContent += `   使用次数：${item.usageCount || 0}\n`;
                        textContent += `   ${item.pinned ? '★ 已固定' : ''}\n`;
                        textContent += `-`.repeat(40) + '\n\n';
                    });
                } else if (type === 'presets') {
                    textContent += `共 ${data.length} 个过滤规则预设组：\n\n`;
                    data.forEach((item, index) => {
                        textContent += `${index + 1}. ${item.name || '无名称'}\n`;
                        textContent += `   描述：${escapeSpecialChars(item.description || '无描述')}\n`;
                        textContent += `   包含规则：${(item.ruleIds || []).length} 个\n`;
                        textContent += `   规则ID：${(item.ruleIds || []).join(', ') || '无'}\n`;
                        textContent += `   状态：${item.enabled ? '✓ 启用' : '✗ 禁用'}\n`;
                        textContent += `   创建时间：${item.createdAt ? new Date(item.createdAt).toLocaleString('zh-CN') : '未知'}\n`;
                        textContent += `-`.repeat(40) + '\n\n';
                    });
                }

                const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                downloadFile(blob, filename);
            } catch (error) {
                console.error('Text Export error:', error);
                showToast('文本导出失败', 'error');
            }
        }

        function downloadFile(blob, filename) {
            try {
                // 检查浏览器支持
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    // IE/Edge
                    window.navigator.msSaveOrOpenBlob(blob, filename);
                } else {
                    // 现代浏览器
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    
                    document.body.appendChild(a);
                    a.click();
                    
                    // 清理
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                }
            } catch (error) {
                console.error('Download error:', error);
                showToast('下载失败', 'error');
            }
        }


        // 统一导入数据（设置页面使用）
        function importData() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showToast('请选择要导入的文件', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const fileName = file.name.toLowerCase();
            
            // 支持多种文件格式
            if (fileName.endsWith('.json')) {
                importJSONFile(file, fileInput);
            } else if (fileName.endsWith('.csv')) {
                importCSVFile(file, fileInput);
            } else if (fileName.endsWith('.txt')) {
                importTextFile(file, fileInput);
            } else {
                showToast('支持的文件格式：JSON、CSV、TXT', 'error');
                return;
            }
        }

        // JSON文件导入
        function importJSONFile(file, fileInput) {
            const reader = new FileReader();
            reader.onerror = function() {
                showToast('文件读取失败', 'error');
            };
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 检测数据类型并显示详细信息
                    let dataTypeInfo = detectDataType(importedData);
                    
                    if (confirm(`检测到${dataTypeInfo.description}，确定要导入吗？\n\n${dataTypeInfo.warning}`)) {
                        let success = false;
                        
                        if (dataTypeInfo.type === 'complete') {
                            // 完整的应用数据
                            appData = {
                                prompts: validateAndCleanPrompts(importedData.prompts || []),
                                websites: validateAndCleanWebsites(importedData.websites || []),
                                filters: validateAndCleanFilters(importedData.filters || []),
                                settings: importedData.settings || { theme: 'light', autoBackup: true }
                            };
                            success = true;
                        } else if (dataTypeInfo.type === 'prompts') {
                            appData.prompts = validateAndCleanPrompts(importedData);
                            success = true;
                        } else if (dataTypeInfo.type === 'websites') {
                            appData.websites = validateAndCleanWebsites(importedData);
                            success = true;
                        } else if (dataTypeInfo.type === 'filters') {
                            appData.filters = validateAndCleanFilters(importedData);
                            success = true;
                        } else if (dataTypeInfo.type === 'presets') {
                            // 导入预设组
                            importedData.forEach(preset => {
                                if (preset.name && preset.ruleIds) {
                                    preset.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                                    filterState.presets.push(preset);
                                }
                            });
                            savePresetsToStorage();
                            renderPresetGroups();
                            success = true;
                        }
                        
                        if (success) {
                            if (dataTypeInfo.type !== 'presets') {
                                saveData();
                                renderAll();
                                updateCategories();
                            }
                            showToast(`${dataTypeInfo.successMessage}导入成功`);
                            // 清空文件输入
                            if (fileInput) fileInput.value = '';
                        } else {
                            showToast('导入失败：数据格式不正确', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('导入失败：JSON格式错误', 'error');
                }
            };
            reader.readAsText(file);
        }

        // CSV文件导入
        function importCSVFile(file, fileInput) {
            const reader = new FileReader();
            reader.onerror = function() {
                showToast('文件读取失败', 'error');
            };
            
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.trim().split('\n');
                    
                    if (lines.length < 2) {
                        showToast('CSV文件格式错误：至少需要标题行和数据行', 'error');
                        return;
                    }
                    
                    // 解析CSV标题
                    const headers = parseCSVLine(lines[0]);
                    const dataType = detectCSVDataType(headers);
                    
                    if (!dataType) {
                        showToast('无法识别CSV数据类型，请确保文件格式正确', 'error');
                        return;
                    }
                    
                    if (confirm(`检测到CSV格式的${dataType.name}数据，确定要导入吗？这将覆盖现有数据。`)) {
                        const importedData = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = parseCSVLine(lines[i]);
                                const item = convertCSVRowToObject(headers, values, dataType.type);
                                if (item) {
                                    importedData.push(item);
                                }
                            }
                        }
                        
                        if (importedData.length > 0) {
                            if (dataType.type === 'prompts') {
                                appData.prompts = validateAndCleanPrompts(importedData);
                            } else if (dataType.type === 'websites') {
                                appData.websites = validateAndCleanWebsites(importedData);
                            } else if (dataType.type === 'filters') {
                                appData.filters = validateAndCleanFilters(importedData);
                            }
                            
                            saveData();
                            renderAll();
                            updateCategories();
                            showToast(`成功导入 ${importedData.length} 条${dataType.name}数据`);
                            if (fileInput) fileInput.value = '';
                        } else {
                            showToast('没有找到有效数据', 'error');
                        }
                    }
                } catch (error) {
                    console.error('CSV Import error:', error);
                    showToast('CSV导入失败', 'error');
                }
            };
            reader.readAsText(file);
        }

        // 文本文件导入
        function importTextFile(file, fileInput) {
            const reader = new FileReader();
            reader.onerror = function() {
                showToast('文件读取失败', 'error');
            };
            
            reader.onload = function(e) {
                try {
                    const textContent = e.target.result;
                    const importedData = parseTextFileContent(textContent);
                    
                    if (importedData && importedData.length > 0) {
                        if (confirm(`检测到 ${importedData.length} 条数据，确定要导入吗？`)) {
                            // 根据内容特征判断数据类型
                            const dataType = detectTextDataType(importedData);
                            
                            if (dataType === 'prompts') {
                                appData.prompts = [...appData.prompts, ...importedData];
                            } else if (dataType === 'websites') {
                                appData.websites = [...appData.websites, ...importedData];
                            } else {
                                // 默认作为提示词处理
                                appData.prompts = [...appData.prompts, ...importedData];
                            }
                            
                            saveData();
                            renderAll();
                            updateCategories();
                            showToast(`成功导入 ${importedData.length} 条数据`);
                            if (fileInput) fileInput.value = '';
                        }
                    } else {
                        showToast('文本文件中没有找到有效数据', 'error');
                    }
                } catch (error) {
                    console.error('Text Import error:', error);
                    showToast('文本导入失败', 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // CSV解析辅助函数
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // 转义的引号
                        current += '"';
                        i += 2;
                    } else {
                        // 开始或结束引号
                        inQuotes = !inQuotes;
                        i++;
                    }
                } else if (char === ',' && !inQuotes) {
                    // 字段分隔符
                    result.push(current.trim());
                    current = '';
                    i++;
                } else {
                    current += char;
                    i++;
                }
            }
            
            // 添加最后一个字段
            result.push(current.trim());
            return result;
        }

        function detectCSVDataType(headers) {
            const headerStr = headers.join(',').toLowerCase();
            
            if (headerStr.includes('标题') && headerStr.includes('内容')) {
                return { type: 'prompts', name: '提示词' };
            } else if (headerStr.includes('网址') || headerStr.includes('url')) {
                return { type: 'websites', name: '网站' };
            } else if (headerStr.includes('正则') || headerStr.includes('regex')) {
                return { type: 'filters', name: '过滤规则' };
            }
            
            return null;
        }

        function convertCSVRowToObject(headers, values, type) {
            if (headers.length !== values.length) {
                return null;
            }
            
            const obj = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                usageCount: 0,
                pinned: false
            };
            
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase();
                let value = values[i];
                
                // 处理基本字段
                if (header.includes('标题') || header.includes('title')) {
                    obj.title = value;
                } else if (header.includes('内容') || header.includes('content')) {
                    obj.content = unescapeSpecialChars(value);
                } else if (header.includes('网址') || header.includes('url')) {
                    obj.url = value;
                } else if (header.includes('描述') || header.includes('description')) {
                    obj.description = unescapeSpecialChars(value);
                } else if (header.includes('名称') || header.includes('name')) {
                    obj.name = value;
                } else if (header.includes('正则') || header.includes('regex')) {
                    obj.regex = value;
                } else if (header.includes('替换')) {
                    obj.replace = value;
                } else if (header.includes('分类') || header.includes('category')) {
                    obj.category = value;
                } else if (header.includes('分组') || header.includes('group')) {
                    obj.group = value;
                } else if (header.includes('标签') || header.includes('tags')) {
                    obj.tags = value ? value.split(';').map(t => t.trim()).filter(t => t) : [];
                } else if (header.includes('固定') || header.includes('pinned')) {
                    obj.pinned = value === '是' || value === 'true' || value === '1';
                } else if (header.includes('激活') || header.includes('active')) {
                    obj.active = value === '是' || value === 'true' || value === '1';
                } else if (header.includes('使用次数')) {
                    obj.usageCount = parseInt(value) || 0;
                }
            }
            
            return obj;
        }

        function parseTextFileContent(content) {
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            const results = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // 跳过明显的标题行
                if (line.match(/^=+$|^-+$|^导出时间|^数据类型/)) {
                    continue;
                }
                
                // 尝试解析不同格式
                if (line.match(/^\d+\./)) {
                    // 编号格式：1. 标题
                    const title = line.replace(/^\d+\.\s*/, '');
                    const obj = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        title: title,
                        content: '',
                        category: '导入数据',
                        tags: [],
                        pinned: false,
                        usageCount: 0,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // 查找后续的详细信息
                    let j = i + 1;
                    while (j < lines.length && !lines[j].match(/^\d+\.|^-+$/)) {
                        const detailLine = lines[j];
                        if (detailLine.includes('网址：') || detailLine.includes('URL：')) {
                            obj.url = detailLine.replace(/.*?[：:]\s*/, '');
                            obj.description = obj.title; // 网站用标题作为描述
                            delete obj.content; // 网站不需要content字段
                        } else if (detailLine.includes('内容：')) {
                            obj.content = detailLine.replace(/.*?[：:]\s*/, '');
                        } else if (detailLine.includes('分类：')) {
                            obj.category = detailLine.replace(/.*?[：:]\s*/, '');
                        } else if (detailLine.includes('标签：')) {
                            const tagStr = detailLine.replace(/.*?[：:]\s*/, '');
                            obj.tags = tagStr ? tagStr.split(/[,，;；]\s*/).filter(t => t && t !== '无') : [];
                        }
                        j++;
                    }
                    
                    results.push(obj);
                    i = j - 1; // 调整索引
                } else if (line.includes('http')) {
                    // URL格式
                    const obj = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        title: line,
                        url: line,
                        description: '从文本导入',
                        category: '导入数据',
                        tags: [],
                        pinned: false,
                        usageCount: 0,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    results.push(obj);
                } else if (line.length > 10) {
                    // 普通文本，作为提示词
                    const obj = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        title: line.length > 50 ? line.substring(0, 50) + '...' : line,
                        content: line,
                        category: '导入数据',
                        tags: [],
                        pinned: false,
                        usageCount: 0,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    results.push(obj);
                }
            }
            
            return results;
        }

        function detectTextDataType(data) {
            // 检查是否有URL字段的数据更多
            const websiteCount = data.filter(item => item.url).length;
            const promptCount = data.filter(item => item.content).length;
            
            if (websiteCount > promptCount) {
                return 'websites';
            } else {
                return 'prompts';
            }
        }

        // 更新文件输入框的accept属性
        function updateFileInputAccept() {
            const fileInput = document.getElementById('importFile');
            if (fileInput) {
                fileInput.accept = '.json,.csv,.txt';
            }
        }

        // ====== 批量导入工具相关函数 ======
        let batchParsedData = {
            prompts: [],
            websites: [],
            filters: [],
            presets: [],
            errors: []
        };

        let batchSelectedTemplate = null;
        let batchCurrentMethod = 'text';
        let batchTargetType = 'all';

        // 显示特定类型的批量导入
        function showBatchImport(targetType = 'all') {
            console.log('显示批量导入，目标类型:', targetType);
            const modal = document.getElementById('batchImportModal');
            if (!modal) {
                throw new Error('批量导入模态框元素不存在');
            }
            modal.classList.add('show');
            
            // 设置目标类型
            batchTargetType = targetType;
            
            // 根据类型设置示例内容
            let exampleContent = '';
            
            if (targetType === 'presets') {
                exampleContent = `隐私保护套装：包含手机号、身份证、邮箱脱敏规则
规则：filter_001, filter_002, filter_003
状态：启用

文本清理套装：清理空格、HTML标签、换行符
规则：filter_004, filter_005, filter_006
状态：启用

开发专用：代码注释清理和格式化
规则：filter_007, filter_008
描述：适用于代码文档的清理工作
状态：禁用`;
                
                // 更新界面标题
                const title = modal.querySelector('.batch-import-header h2');
                if (title) {
                    title.textContent = '智能导入 - 过滤规则预设组';
                }
                
            } else if (targetType === 'filters') {
                exampleContent = `手机号脱敏 正则：\\d{3}\\d{4}\\d{4} 替换：[手机号] #隐私 #脱敏
邮箱脱敏 正则：[\\w.-]+@[\\w.-]+ 替换：[邮箱] #隐私 #脱敏  
删除空行：^\\s*$\\n -> #格式化 #清理
HTML标签清理：<[^>]+> -> [已过滤] #HTML #清理`;
                
                // 更新界面标题
                const title = modal.querySelector('.batch-import-header h2');
                if (title) {
                    title.textContent = '智能导入 - 过滤规则';
                }
                
            } else if (targetType === 'prompts') {
                exampleContent = `代码审查助手：帮我检查代码问题，找出潜在的bug和优化点 #编程 #代码审查 @ChatGPT
React组件开发：创建可复用的React组件，使用Hooks和TypeScript #前端 #React #TypeScript
SQL查询优化：优化数据库查询性能，提供索引建议 #数据库 #SQL #性能优化`;
                
                const title = modal.querySelector('.batch-import-header h2');
                if (title) {
                    title.textContent = '智能导入 - 提示词';
                }
                
            } else if (targetType === 'websites') {
                exampleContent = `GitHub - https://github.com - 全球最大的代码托管平台 #开发 #Git @官方推荐
Stack Overflow - https://stackoverflow.com - 程序员问答社区 #问答 #编程
MDN文档 - https://developer.mozilla.org - Web开发技术文档 #文档 #前端`;
                
                const title = modal.querySelector('.batch-import-header h2');
                if (title) {
                    title.textContent = '智能导入 - 网站收藏';
                }
                
            } else {
                exampleContent = `代码审查助手：帮我检查代码问题，找出潜在的bug和优化点 #编程 #代码审查 @ChatGPT
React组件开发：创建可复用的React组件，使用Hooks和TypeScript #前端 #React #TypeScript
SQL查询优化：优化数据库查询性能，提供索引建议 #数据库 #SQL #性能优化

GitHub - https://github.com - 全球最大的代码托管平台 #开发 #Git @官方推荐
Stack Overflow - https://stackoverflow.com - 程序员问答社区 #问答 #编程
MDN文档 - https://developer.mozilla.org - Web开发技术文档 #文档 #前端`;
                
                const title = modal.querySelector('.batch-import-header h2');
                if (title) {
                    title.textContent = '智能批量导入工具';
                }
            }
            
            // 设置示例内容
            const batchNaturalInput = document.getElementById('batchNaturalInput');
            if (batchNaturalInput) {
                batchNaturalInput.value = exampleContent;
            } else {
                console.warn('batchNaturalInput 元素不存在');
            }
            
            // 保存目标类型以供后续使用
            batchTargetType = targetType;
            
            // 初始化拖拽上传
            try {
                initBatchDragUpload();
                console.log('拖拽上传初始化成功');
            } catch (error) {
                console.error('拖拽上传初始化失败:', error);
            }
            
            // 初始化现有数据面板
            try {
                initExistingDataPanel();
                console.log('现有数据面板初始化成功');
            } catch (error) {
                console.error('现有数据面板初始化失败:', error);
            }
        }
        
        // 打开批量导入工具
        function openBatchImportTool() {
            try {
                console.log('开始打开批量导入工具...');
                showBatchImport('all');
                console.log('批量导入工具打开成功');
            } catch (error) {
                console.error('批量导入工具打开失败:', error);
                showToast('批量导入工具打开失败: ' + error.message, 'error');
            }
        }

        // 关闭批量导入工具
        function closeBatchImportTool() {
            const modal = document.getElementById('batchImportModal');
            modal.classList.remove('show');
            
            // 清空数据
            clearBatchAll();
        }

        // 切换输入方式
        function switchBatchMethod(method) {
            batchCurrentMethod = method;
            
            // 更新按钮状态
            document.querySelectorAll('.batch-method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 显示对应区域
            document.querySelectorAll('.batch-input-area').forEach(area => {
                area.classList.remove('active');
            });
            document.getElementById('batch' + method.charAt(0).toUpperCase() + method.slice(1) + 'Input').classList.add('active');
        }

        // 智能解析自然语言输入
        function parseBatchNaturalInput() {
            const input = document.getElementById('batchNaturalInput').value.trim();
            if (!input) {
                showToast('请输入内容', 'warning');
                return;
            }

            batchParsedData = {
                prompts: [],
                websites: [],
                filters: [],
                presets: [],
                errors: []
            };

            // 改进的解析：支持多行内容
            const entries = parseMultiLineEntries(input);
            
            entries.forEach((entry, index) => {
                try {
                    const parsed = parseBatchLine(entry.content);
                    if (parsed) {
                        if (parsed.type === 'prompt') {
                            batchParsedData.prompts.push(parsed.data);
                        } else if (parsed.type === 'website') {
                            batchParsedData.websites.push(parsed.data);
                        } else if (parsed.type === 'filter') {
                            batchParsedData.filters.push(parsed.data);
                        } else if (parsed.type === 'preset') {
                            batchParsedData.presets.push(parsed.data);
                        }
                    }
                } catch (error) {
                    batchParsedData.errors.push({
                        line: entry.startLine,
                        content: entry.content.substring(0, 100) + (entry.content.length > 100 ? '...' : ''),
                        error: error.message
                    });
                }
            });

            updateBatchPreview();
            showToast(`解析完成：${batchParsedData.prompts.length}个提示词，${batchParsedData.websites.length}个网站，${batchParsedData.filters.length}个过滤规则，${batchParsedData.presets.length}个预设组`, 'success');
        }

        // 解析多行条目（支持转义符格式）
        function parseMultiLineEntries(input) {
            const entries = [];
            
            // 使用特殊分隔符来分割条目：===ENTRY_SEPARATOR===
            // 这样用户可以明确地分隔条目，避免歧义
            let rawEntries;
            
            if (input.includes('===ENTRY_SEPARATOR===')) {
                // 如果用户使用了明确的分隔符
                rawEntries = input.split('===ENTRY_SEPARATOR===');
            } else {
                // 否则按空行分隔，但要更智能
                // 首先处理所有转义符
                let processedInput = input
                    .replace(/\\n/g, '\uE000')  // 临时替换\n为私用字符
                    .replace(/\\t/g, '\uE001')  // 临时替换\t为私用字符
                    .replace(/\\\\/g, '\uE002'); // 临时替换\\为私用字符
                
                // 按三个或更多连续换行符分割（真正的换行符，不是转义的）
                rawEntries = processedInput.split(/\n\s*\n\s*\n+/);
                
                // 如果只有一个条目，尝试智能分割
                if (rawEntries.length === 1) {
                    const lines = processedInput.split('\n');
                    const smartEntries = [];
                    let currentEntry = '';
                    let currentEntryStarted = false;
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        if (!line) {
                            // 空行作为当前条目的一部分保留
                            if (currentEntryStarted) {
                                currentEntry += '\n';
                            }
                            continue;
                        }
                        
                        // 还原转义符后检测是否是新条目
                        const restoredLine = line
                            .replace(/\uE000/g, '\n')
                            .replace(/\uE001/g, '\t')
                            .replace(/\uE002/g, '\\');
                        
                        const isNewEntry = detectNewEntry(restoredLine);
                        
                        if (isNewEntry && currentEntryStarted && currentEntry.trim()) {
                            // 保存当前条目，开始新条目
                            smartEntries.push(currentEntry.trim());
                            currentEntry = lines[i];
                            currentEntryStarted = true;
                        } else if (isNewEntry && !currentEntryStarted) {
                            // 开始第一个条目
                            currentEntry = lines[i];
                            currentEntryStarted = true;
                        } else if (currentEntryStarted) {
                            // 继续当前条目
                            currentEntry += '\n' + lines[i];
                        }
                    }
                    
                    // 添加最后一个条目
                    if (currentEntry.trim()) {
                        smartEntries.push(currentEntry.trim());
                    }
                    
                    rawEntries = smartEntries;
                }
                
                // 还原所有转义符
                rawEntries = rawEntries.map(entry => 
                    entry
                        .replace(/\uE000/g, '\n')
                        .replace(/\uE001/g, '\t')
                        .replace(/\uE002/g, '\\')
                );
            }
            
            let lineNumber = 1;
            for (let entry of rawEntries) {
                const trimmedEntry = entry.trim();
                if (trimmedEntry) {
                    entries.push({
                        content: trimmedEntry,
                        startLine: lineNumber
                    });
                    // 估算行号
                    lineNumber += entry.split('\n').length + 1;
                }
            }

            return entries;
        }

        // 检测是否为新条目的开始
        function detectNewEntry(line) {
            // 如果行以标签或来源开头，很可能是上一个条目的延续
            if (line.startsWith('#') || line.startsWith('@')) {
                return false;
            }
            
            // 如果是编号列表项或缩进内容，不应该被认为是新条目
            if (line.match(/^\s*\d+[\.\)、]\s+/) || // 匹配 "1. " "1) " "1、" 等
                line.match(/^\s*[a-zA-Z][\.\)]\s+/) || // 匹配 "a. " "a) " 等  
                line.match(/^\s*[•\-\*]\s+/) || // 匹配项目符号
                line.match(/^\s{2,}/)) { // 匹配缩进的行
                return false;
            }
            
            // 检测预设组名称行（优先级最高）
            // 注意：规则：和状态：应该是预设组的组成部分，而不是新条目的开始
            if ((line.includes('套装') && (line.includes('：') || line.includes(':'))) ||
                (line.includes('预设') && (line.includes('：') || line.includes(':'))) ||
                (line.includes('组') && (line.includes('：') || line.includes(':')))) {
                return true;
            }
            
            // 各种属性行不应该被认为是新条目的开始，它们是条目的组成部分
            if (line.startsWith('规则：') || line.startsWith('规则:') ||
                line.startsWith('状态：') || line.startsWith('状态:') ||
                line.startsWith('ruleIds:') || line.startsWith('rule_ids:') ||
                line.startsWith('内容：') || line.startsWith('内容:') ||
                line.startsWith('描述：') || line.startsWith('描述:') ||
                line.startsWith('分类：') || line.startsWith('分类:') ||
                line.startsWith('标签：') || line.startsWith('标签:') ||
                line.startsWith('来源：') || line.startsWith('来源:') ||
                line.startsWith('网址：') || line.startsWith('网址:') ||
                line.startsWith('content:') || line.startsWith('description:') ||
                line.startsWith('category:') || line.startsWith('tags:') ||
                line.startsWith('source:') || line.startsWith('url:')) {
                return false;
            }
            
            // 检测预设组模式：名称后跟描述（不包含URL、正则等）
            if (line.includes('：') && !line.includes('正则') && !line.includes('替换') && 
                !line.match(/https?:\/\//) && 
                (line.includes('包含') || line.includes('清理') || line.includes('脱敏') || 
                 line.includes('过滤') || line.includes('处理') || line.includes('规则') ||
                 line.match(/^\d+[：:]\s*包含/))) {  // 支持 "2：包含 16 个规则" 这种格式
                return true;
            }
            
            // 过滤规则的属性行不应该被识别为新条目
            if (line.startsWith('正则：') || line.startsWith('正则:') ||
                line.startsWith('替换：') || line.startsWith('替换:') ||
                line.startsWith('regex:') || line.startsWith('replace:')) {
                return false;
            }
            
            // 检测过滤规则格式（包含完整规则定义或箭头格式）
            if ((line.includes('正则：') && !line.startsWith('正则：')) || 
                (line.includes('regex:') && !line.startsWith('regex:')) ||
                (line.includes('->') && line.match(/[\w\\\[\]\(\)\{\}\.\+\*\?\^\$\|]+\s*->\s*/))) {
                return true;
            }
            
            // 检测网站格式：包含URL
            if (line.match(/https?:\/\/[^\s]+/)) {
                return true;
            }
            
            // 检测提示词格式：标题：内容（但需要更严格的判断）
            if (line.includes('：') && !line.startsWith('正则：') && !line.startsWith('替换：') && !line.startsWith('replace:')) {
                // 必须是在行的开头部分有冒号，并且冒号前的内容像是标题
                const colonIndex = line.indexOf('：');
                if (colonIndex > 0 && colonIndex < 50) { // 冒号在前50个字符内，像是标题
                    const beforeColon = line.substring(0, colonIndex).trim();
                    const afterColon = line.substring(colonIndex + 1).trim();
                    // 标题部分不应该是纯数字或包含明显的列表标记，且应该像职业或工具名称
                    if (!beforeColon.match(/^\d+$/) && !beforeColon.match(/^\d+[\.\)、]/) && 
                        afterColon.length > 10 && // 内容要足够长，像是完整的描述
                        (beforeColon.includes('师') || beforeColon.includes('助手') || beforeColon.includes('工具') || 
                         beforeColon.includes('分析') || beforeColon.includes('建议') || beforeColon.includes('管理') ||
                         beforeColon.length > 3)) { // 或者标题足够长
                        return true;
                    }
                }
            }
            
            // 检测英文冒号格式（更严格的判断）
            if (line.includes(':') && !line.startsWith('regex:') && !line.startsWith('replace:')) {
                const colonIndex = line.indexOf(':');
                if (colonIndex > 0 && colonIndex < 50) { // 冒号在前50个字符内
                    const beforeColon = line.substring(0, colonIndex).trim();
                    const afterColon = line.substring(colonIndex + 1).trim();
                    // 确保不是列表项，且有足够的内容
                    if (!beforeColon.match(/^\d+$/) && !beforeColon.match(/^\d+[\.\)]/) && 
                        beforeColon.length >= 3 && afterColon.length >= 10) {
                        return true;
                    }
                }
            }
            
            // 检测其他分隔符格式
            if (line.match(/^[^\s#@-].{5,}\s+-\s+.{5,}/)) { // 用短横线分隔的格式
                return true;
            }
            
            return false;
        }
        
        // 检测是否为内容的延续
        function isContentContinuation(line) {
            // 如果是属性行，它们应该作为当前条目的一部分，而不是内容延续
            if (line.startsWith('规则：') || line.startsWith('状态：') ||
                line.startsWith('规则:') || line.startsWith('状态:') ||
                line.startsWith('替换：') || line.startsWith('正则：') ||
                line.startsWith('内容：') || line.startsWith('内容:') ||
                line.startsWith('描述：') || line.startsWith('描述:') ||
                line.startsWith('分类：') || line.startsWith('分类:') ||
                line.startsWith('标签：') || line.startsWith('标签:') ||
                line.startsWith('来源：') || line.startsWith('来源:') ||
                line.startsWith('网址：') || line.startsWith('网址:')) {
                return false;
            }
            
            // 编号列表和项目符号被认为是内容延续
            if (line.match(/^\s*\d+[\.\)、]\s+/) || // 匹配 "1. " "1) " "1、" 等
                line.match(/^\s*[a-zA-Z][\.\)]\s+/) || // 匹配 "a. " "a) " 等
                line.match(/^\s*[•\-\*]\s+/)) { // 匹配项目符号
                return true;
            }
            
            // 如果行以缩进开始，很可能是内容的延续
            if (line.match(/^\s{2,}/)) {
                return true;
            }
            
            // 如果行不包含明显的分隔符，且不是标签或来源，可能是内容延续
            if (!line.includes('：') && !line.includes(':') && !line.includes('-') && 
                !line.startsWith('#') && !line.startsWith('@') && 
                !line.match(/https?:\/\//)) {
                return true;
            }
            
            // 如果行以常见的句子开头词开始
            if (line.match(/^(请|帮|可以|能否|如何|什么|为什么|当|如果|但是|然而|另外|此外|同时|另一方面)/)) {
                return true;
            }
            
            return false;
        }

        // 解析单行
        function parseBatchLine(line) {
            line = line.trim();
            if (!line) return null;

            // 检测是否为预设组（根据目标类型或包含特定关键词）
            if (batchTargetType === 'presets' || 
                (line.includes('预设') && line.includes('：')) ||
                (line.includes('组') && line.includes('：')) ||
                (line.includes('套装') && line.includes('：') && !line.includes('https')) ||
                (line.includes('包含') && line.includes('规则') && !line.startsWith('规则：')) ||
                (/^\d+[：:]\s*包含/.test(line))) {
                return parseBatchPreset(line);
            }

            // 检测是否为过滤规则（包含正则表达式特征）
            if ((line.includes('正则：') && !line.startsWith('正则：')) || 
                (line.includes('regex:') && !line.startsWith('regex:')) || 
                (line.includes('/') && line.includes('->'))) {
                return parseBatchFilter(line);
            }

            // 检测是否为网址
            const urlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/gi;
            const hasUrl = urlRegex.test(line);

            if (hasUrl) {
                return parseBatchWebsite(line);
            } else {
                return parseBatchPrompt(line);
            }
        }

        // 解析提示词
        function parseBatchPrompt(content) {
            let title = '';
            let promptContent = '';
            let tags = [];
            let source = '';
            let category = '未分类';

            // 反转义特殊字符
            content = unescapeSpecialChars(content);

            // 将多行内容分割处理
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            let remainingText = content;

            // 提取来源（@开头）
            const sourceMatch = content.match(/@([^#\s]+)/);
            if (sourceMatch) {
                source = sourceMatch[1];
                remainingText = remainingText.replace(sourceMatch[0], '');
            }

            // 提取标签（#开头）
            const tagMatches = content.match(/#([^#\s]+)/g);
            if (tagMatches) {
                tags = tagMatches.map(tag => tag.substring(1));
                tagMatches.forEach(tag => {
                    remainingText = remainingText.replace(tag, '');
                });
            }

            for (const line of lines) {
                if (line.startsWith('内容：') || line.startsWith('content:')) {
                    promptContent = line.split(/[：:]/)[1].trim();
                } else if (line.startsWith('分类：') || line.startsWith('category:')) {
                    category = line.split(/[：:]/)[1].trim();
                } else if (line.startsWith('标签：') || line.startsWith('tags:')) {
                    const lineTags = line.split(/[：:]/)[1].split(/[,，]/).map(t => t.trim()).filter(t => t);
                    tags.push(...lineTags);
                } else if (line.startsWith('来源：') || line.startsWith('source:')) {
                    source = line.split(/[：:]/)[1].trim();
                } else if (!title && line.includes('：') && !line.startsWith('内容：') && !line.startsWith('分类：')) {
                    // 第一行包含冒号的，可能是标题:内容格式
                    const parts = line.split('：');
                    title = parts[0].trim();
                    if (!promptContent && parts[1]) {
                        promptContent = parts.slice(1).join('：').trim();
                    }
                } else if (!title && line.includes(':') && !line.startsWith('content:') && !line.startsWith('category:')) {
                    const parts = line.split(':');
                    title = parts[0].trim();
                    if (!promptContent && parts[1]) {
                        promptContent = parts.slice(1).join(':').trim();
                    }
                } else if (!title && line.includes(' - ')) {
                    const parts = line.split(' - ');
                    title = parts[0].trim();
                    if (!promptContent && parts[1]) {
                        promptContent = parts.slice(1).join(' - ').trim();
                    }
                } else if (!title && !line.includes('：') && !line.includes(':') && !line.startsWith('#') && !line.startsWith('@')) {
                    // 第一行纯文本作为标题
                    title = line;
                }
            }

            // 如果没有明确的内容，使用标题作为内容
            if (!promptContent && title) {
                promptContent = title;
            }

            // 如果仍然没有标题，从内容生成
            if (!title && promptContent) {
                if (promptContent.length > 30) {
                    title = promptContent.substring(0, 30) + '...';
                } else {
                    title = promptContent;
                }
            }

            // 智能分类（基于标签）
            if (tags.length > 0) {
                const categoryMap = {
                    '编程': ['Python', 'JavaScript', 'Java', 'React', 'Vue', '代码', '开发', 'API', '编程'],
                    '写作': ['文章', '论文', '邮件', '文案', '润色', '写作'],
                    '翻译': ['翻译', '英文', '中文', '日文'],
                    '数据': ['数据库', 'SQL', 'Excel', '分析', '统计'],
                    'AI': ['AI', 'ChatGPT', 'Claude', '机器学习', '深度学习']
                };

                for (const [cat, keywords] of Object.entries(categoryMap)) {
                    if (tags.some(tag => keywords.some(keyword => tag.toLowerCase().includes(keyword.toLowerCase())))) {
                        category = cat;
                        break;
                    }
                }
            }

            return {
                type: 'prompt',
                data: {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    title: title,
                    content: promptContent || title,
                    category: category,
                    tags: tags,
                    pinned: false,
                    usageCount: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            };
        }

        // 解析网站
        function parseBatchWebsite(line) {
            let title = '';
            let url = '';
            let description = '';
            let tags = [];
            let source = '';
            let category = '未分类';

            // 反转义特殊字符
            line = unescapeSpecialChars(line);

            // 提取URL
            const urlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/gi;
            const urlMatch = line.match(urlRegex);
            if (urlMatch) {
                url = urlMatch[0];
                line = line.replace(url, '').trim();
            }

            // 提取来源（@开头）
            const sourceMatch = line.match(/@([^#\s]+)/);
            if (sourceMatch) {
                source = sourceMatch[1];
                line = line.replace(sourceMatch[0], '');
            }

            // 提取标签（#开头）
            const tagMatches = line.match(/#([^#\s]+)/g);
            if (tagMatches) {
                tags = tagMatches.map(tag => tag.substring(1));
                tagMatches.forEach(tag => {
                    line = line.replace(tag, '');
                });
            }

            // 解析名称和描述
            line = line.trim();
            
            if (line.includes(' - ')) {
                const parts = line.split(' - ');
                title = parts[0].trim();
                description = parts.slice(1).join(' - ').trim();
            } else if (line.includes('：')) {
                const parts = line.split('：');
                title = parts[0].trim();
                description = parts.slice(1).join('：').trim();
            } else if (line.includes(':')) {
                const parts = line.split(':');
                title = parts[0].trim();
                description = parts.slice(1).join(':').trim();
            } else {
                title = line || extractBatchDomainName(url);
                description = '';
            }

            // 智能分类
            const urlLower = url.toLowerCase();
            if (urlLower.includes('github') || urlLower.includes('gitlab')) {
                category = '开发工具/代码托管';
            } else if (urlLower.includes('stackoverflow') || urlLower.includes('segmentfault')) {
                category = '开发工具/社区';
            } else if (urlLower.includes('google') || urlLower.includes('baidu') || urlLower.includes('bing')) {
                category = '搜索引擎';
            } else if (urlLower.includes('openai') || urlLower.includes('anthropic') || urlLower.includes('claude')) {
                category = 'AI工具';
            } else if (tags.length > 0) {
                category = tags[0];
            }

            return {
                type: 'website',
                data: {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    title: title,
                    url: url,
                    description: description,
                    category: category,
                    tags: tags,
                    pinned: false,
                    usageCount: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            };
        }

        // 解析过滤规则
        function parseBatchFilter(line) {
            let name = '';
            let regex = '';
            let replace = '';
            let tags = [];
            let group = '未分组';

            // 反转义特殊字符
            line = unescapeSpecialChars(line);

            // 提取标签（#开头）
            const tagMatches = line.match(/#([^#\s]+)/g);
            if (tagMatches) {
                tags = tagMatches.map(tag => tag.substring(1));
                tagMatches.forEach(tag => {
                    line = line.replace(tag, '');
                });
            }

            // 解析规则格式
            line = line.trim();
            
            if (line.includes('正则：') || line.includes('regex:')) {
                // 格式：名称 正则：pattern 替换：replacement
                const regexMatch = line.match(/(.+?)\s*(?:正则|regex)[：:]\s*(.+?)(?:\s+(?:替换|replace)[：:]\s*(.*))?$/);
                if (regexMatch) {
                    name = regexMatch[1].trim();
                    regex = regexMatch[2].trim();
                    replace = regexMatch[3] ? regexMatch[3].trim() : '';
                } else {
                    throw new Error('正则表达式格式解析失败');
                }
            } else if (line.includes('->')) {
                // 格式：pattern -> replacement 或 名称：pattern -> replacement
                const arrowIndex = line.indexOf('->');
                const beforeArrow = line.substring(0, arrowIndex).trim();
                const afterArrow = line.substring(arrowIndex + 2).trim();
                
                // 检查是否有名称
                const colonIndex = beforeArrow.indexOf('：');
                if (colonIndex !== -1) {
                    name = beforeArrow.substring(0, colonIndex).trim();
                    regex = beforeArrow.substring(colonIndex + 1).trim();
                } else {
                    // 从正则表达式生成名称
                    name = generateFilterName(beforeArrow);
                    regex = beforeArrow;
                }
                replace = afterArrow;
            } else {
                throw new Error('无法识别的过滤规则格式');
            }

            // 智能分组
            if (tags.length > 0) {
                const groupMap = {
                    '隐私保护': ['隐私', '脱敏', '个人信息'],
                    '代码清理': ['代码', '注释', '清理'],
                    '格式化': ['格式', '标准化', '统一', '日期', '时间'],
                    '文本处理': ['文本', '字符', '内容']
                };

                for (const [grp, keywords] of Object.entries(groupMap)) {
                    if (tags.some(tag => keywords.some(keyword => tag.toLowerCase().includes(keyword.toLowerCase())))) {
                        group = grp;
                        break;
                    }
                }
            }

            // 验证正则表达式
            try {
                new RegExp(regex);
            } catch (e) {
                throw new Error(`正则表达式无效: ${e.message}`);
            }

            if (!name || !regex) {
                throw new Error('过滤规则缺少必要信息（名称和正则表达式）');
            }

            return {
                type: 'filter',
                data: {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    name: name,
                    regex: regex,
                    replace: replace,
                    group: group,
                    tags: tags,
                    pinned: false,
                    active: false,
                    usageCount: 0,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            };
        }

        // 从正则表达式生成过滤规则名称
        function generateFilterName(regex) {
            // 常见的正则模式对应的名称
            const patterns = {
                '\\d{3}\\)?\\s?-?\\s?\\d{4}\\s?-?\\s?\\d{4}': '手机号处理',
                '\\d{4}-\\d{2}-\\d{2}': '日期格式',
                '\\w+@\\w+': '邮箱处理',
                '\\d{15,18}': '身份证处理',
                '\\s+': '空格处理',
                '<[^>]+>': 'HTML标签',
                '\\n+': '换行符处理'
            };

            for (const [pattern, name] of Object.entries(patterns)) {
                if (regex.includes(pattern.replace(/\\/g, ''))) {
                    return name;
                }
            }

            // 如果没有匹配的模式，生成通用名称
            return `过滤规则_${Date.now().toString().slice(-6)}`;
        }

        // 解析预设组
        function parseBatchPreset(content) {
            let name = '';
            let description = '';
            let ruleIds = [];
            let enabled = false;

            // 反转义特殊字符
            content = unescapeSpecialChars(content);

            // 将多行内容分割处理
            const lines = content.split('\n').map(line => line.trim()).filter(line => line);
            
            for (const line of lines) {
                // 解析预设组名称和描述
                if (line.includes('：') && !line.startsWith('规则：') && !line.startsWith('状态：')) {
                    const colonIndex = line.indexOf('：');
                    const beforeColon = line.substring(0, colonIndex).trim();
                    const afterColon = line.substring(colonIndex + 1).trim();
                    
                    // 检查是否是规则行或状态行
                    if (!beforeColon.includes('规则') && !beforeColon.includes('状态')) {
                        if (!name) {
                            name = beforeColon;
                        }
                        // 检查是否是描述行
                        if (!afterColon.includes('filter_') && !afterColon.includes('rule_') && afterColon) {
                            description = afterColon;
                        }
                    }
                } else if (line.includes(':') && !line.startsWith('规则:') && !line.startsWith('状态:') && !name) {
                    const colonIndex = line.indexOf(':');
                    const beforeColon = line.substring(0, colonIndex).trim();
                    const afterColon = line.substring(colonIndex + 1).trim();
                    
                    if (!beforeColon.includes('规则') && !beforeColon.includes('状态') && !beforeColon.includes('rule')) {
                        name = beforeColon;
                        if (!afterColon.includes('filter_') && !afterColon.includes('rule_') && afterColon) {
                            description = afterColon;
                        }
                    }
                }

                // 解析规则ID（格式：规则：filter_001, filter_002）
                const ruleMatch = line.match(/规则[：:]\s*(.+)$/);
                if (ruleMatch) {
                    const ruleString = ruleMatch[1].trim();
                    // 处理可能的多行规则ID
                    const ids = ruleString.split(/[,，]\s*/).map(id => id.trim()).filter(id => id);
                    ruleIds.push(...ids);
                }

                // 解析状态（格式：状态：启用/禁用）
                const statusMatch = line.match(/状态[：:]\s*(启用|禁用|enabled|disabled)/);
                if (statusMatch) {
                    enabled = statusMatch[1] === '启用' || statusMatch[1] === 'enabled';
                }

                // 解析包含(contain)格式：隐私保护：包含 手机号、身份证脱敏规则
                const containMatch = line.match(/包含[：:]?\s*(.*)/);
                if (containMatch && !description) {
                    description = containMatch[1].trim();
                }

                // 查找行中的规则ID
                const foundRuleIds = line.match(/(?:filter_|rule_)[\w\d]+/g);
                if (foundRuleIds) {
                    ruleIds.push(...foundRuleIds);
                }
            }

            // 去重规则ID
            ruleIds = [...new Set(ruleIds)];

            // 如果第一行没有冒号且没有找到名称，使用第一行作为名称
            if (!name && lines.length > 0) {
                const firstLine = lines[0];
                if (!firstLine.includes('规则') && !firstLine.includes('状态')) {
                    name = firstLine;
                }
            }

            if (!name) {
                // 如果没有名称，尝试从描述中提取或生成默认名称
                if (description) {
                    name = description.substring(0, 20) + '...';
                } else if (ruleIds.length > 0) {
                    name = `规则组_${ruleIds.length}项`;
                } else {
                    name = `预设组_${Date.now().toString().slice(-6)}`;
                }
            }

            return {
                type: 'preset',
                data: {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    name: name,
                    description: description,
                    ruleIds: ruleIds,
                    enabled: enabled,
                    createdAt: new Date().toISOString()
                }
            };
        }

        // 从URL提取域名
        function extractBatchDomainName(url) {
            try {
                const u = new URL(url);
                return u.hostname.replace('www.', '');
            } catch {
                return '未知网站';
            }
        }

        // 文件处理相关函数
        function handleBatchFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const fileName = file.name.toLowerCase();

            showToast('正在处理文件...', 'info');

            if (fileName.endsWith('.csv')) {
                reader.onload = (e) => parseBatchCSV(e.target.result);
                reader.readAsText(file);
            } else if (fileName.endsWith('.txt')) {
                reader.onload = (e) => parseBatchText(e.target.result);
                reader.readAsText(file);
            } else if (fileName.endsWith('.json')) {
                reader.onload = (e) => parseBatchJSON(e.target.result);
                reader.readAsText(file);
            } else {
                showToast('不支持的文件格式', 'error');
                return;
            }
        }

        // 解析CSV文件
        function parseBatchCSV(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    showToast('CSV文件至少需要包含标题行和数据行', 'error');
                    return;
                }

                const headers = parseCSVLine(lines[0]);
                const headerStr = headers.join(',').toLowerCase();
                
                batchParsedData = {
                    prompts: [],
                    websites: [],
                    filters: [],
                    presets: [],
                    errors: []
                };

                // 智能检测数据类型
                let dataType = 'unknown';
                if (headerStr.includes('内容') || headerStr.includes('content')) {
                    dataType = 'prompts';
                } else if (headerStr.includes('网址') || headerStr.includes('url')) {
                    dataType = 'websites';
                } else if (headerStr.includes('正则') || headerStr.includes('regex')) {
                    dataType = 'filters';
                } else if (headerStr.includes('规则id') || headerStr.includes('ruleid') || 
                          headerStr.includes('预设') || headerStr.includes('preset')) {
                    dataType = 'presets';
                }

                for (let i = 1; i < lines.length; i++) {
                    try {
                        const values = parseCSVLine(lines[i]);
                        if (values.length === 0 || !values.some(v => v.trim())) continue;

                        const item = convertBatchCSVRowToObject(headers, values, dataType);
                        if (item) {
                            if (dataType === 'prompts') {
                                batchParsedData.prompts.push(item);
                            } else if (dataType === 'websites') {
                                batchParsedData.websites.push(item);
                            } else if (dataType === 'filters') {
                                batchParsedData.filters.push(item);
                            } else if (dataType === 'presets') {
                                batchParsedData.presets.push(item);
                            }
                        }
                    } catch (error) {
                        batchParsedData.errors.push({
                            line: i + 1,
                            content: lines[i],
                            error: error.message
                        });
                    }
                }

                updateBatchPreview();
                const totalItems = batchParsedData.prompts.length + batchParsedData.websites.length + batchParsedData.filters.length + (batchParsedData.presets || []).length;
                showToast(`CSV导入完成：${totalItems} 条数据`, 'success');
            } catch (error) {
                showToast('CSV解析失败：' + error.message, 'error');
            }
        }

        // 解析文本文件
        function parseBatchText(textContent) {
            try {
                batchParsedData = {
                    prompts: [],
                    websites: [],
                    filters: [],
                    presets: [],
                    errors: []
                };

                const lines = textContent.split('\n').filter(line => line.trim());
                
                lines.forEach((line, index) => {
                    try {
                        const parsed = parseBatchLine(line);
                        if (parsed) {
                            if (parsed.type === 'prompt') {
                                batchParsedData.prompts.push(parsed.data);
                            } else if (parsed.type === 'website') {
                                batchParsedData.websites.push(parsed.data);
                            } else if (parsed.type === 'filter') {
                                batchParsedData.filters.push(parsed.data);
                            } else if (parsed.type === 'preset') {
                                batchParsedData.presets.push(parsed.data);
                            }
                        }
                    } catch (error) {
                        batchParsedData.errors.push({
                            line: index + 1,
                            content: line,
                            error: error.message
                        });
                    }
                });

                updateBatchPreview();
                const totalItems = batchParsedData.prompts.length + batchParsedData.websites.length + batchParsedData.filters.length + (batchParsedData.presets || []).length;
                showToast(`文本导入完成：${totalItems} 条数据`, 'success');
            } catch (error) {
                showToast('文本解析失败：' + error.message, 'error');
            }
        }

        // 解析JSON文件
        function parseBatchJSON(jsonText) {
            try {
                const data = JSON.parse(jsonText);
                
                batchParsedData = {
                    prompts: [],
                    websites: [],
                    filters: [],
                    presets: [],
                    errors: []
                };

                // 检测JSON数据结构
                if (data.prompts || data.websites || data.filters || data.presets) {
                    // 完整备份格式
                    batchParsedData.prompts = validateAndCleanPrompts(data.prompts || []);
                    batchParsedData.websites = validateAndCleanWebsites(data.websites || []);
                    batchParsedData.filters = validateAndCleanFilters(data.filters || []);
                    batchParsedData.presets = validateAndCleanPresets(data.presets || []);
                } else if (Array.isArray(data)) {
                    // 数组格式 - 智能检测类型
                    if (data.length > 0) {
                        const firstItem = data[0];
                        if (firstItem.content) {
                            batchParsedData.prompts = validateAndCleanPrompts(data);
                        } else if (firstItem.url) {
                            batchParsedData.websites = validateAndCleanWebsites(data);
                        } else if (firstItem.regex) {
                            batchParsedData.filters = validateAndCleanFilters(data);
                        } else if (firstItem.name && firstItem.ruleIds) {
                            batchParsedData.presets = validateAndCleanPresets(data);
                        }
                    }
                }

                updateBatchPreview();
                const totalItems = batchParsedData.prompts.length + batchParsedData.websites.length + batchParsedData.filters.length + (batchParsedData.presets || []).length;
                showToast(`JSON导入完成：${totalItems} 条数据`, 'success');
            } catch (error) {
                showToast('JSON解析失败：' + error.message, 'error');
            }
        }

        // CSV行转对象
        function convertBatchCSVRowToObject(headers, values, type) {
            if (headers.length !== values.length) return null;

            const obj = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                usageCount: 0,
                pinned: false
            };

            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase();
                let value = values[i].trim();
                
                if (header.includes('标题') || header.includes('title')) {
                    obj.title = value;
                } else if (header.includes('内容') || header.includes('content')) {
                    obj.content = value;
                } else if (header.includes('网址') || header.includes('url')) {
                    obj.url = value;
                } else if (header.includes('描述') || header.includes('description')) {
                    obj.description = value;
                } else if (header.includes('名称') || header.includes('name')) {
                    obj.name = value;
                } else if (header.includes('正则') || header.includes('regex')) {
                    obj.regex = value;
                } else if (header.includes('替换')) {
                    obj.replace = value;
                } else if (header.includes('分类') || header.includes('category')) {
                    obj.category = value || '未分类';
                } else if (header.includes('分组') || header.includes('group')) {
                    obj.group = value || '未分组';
                } else if (header.includes('标签') || header.includes('tags')) {
                    obj.tags = value ? value.split(/[,;，；]/).map(t => t.trim()).filter(t => t) : [];
                } else if (header.includes('固定')) {
                    obj.pinned = value === '是' || value === 'true' || value === '1';
                } else if (header.includes('激活') || header.includes('active')) {
                    obj.active = value === '是' || value === 'true' || value === '1';
                } else if (header.includes('启用') || header.includes('enabled')) {
                    obj.enabled = value === '是' || value === 'true' || value === '1' || value === '启用';
                } else if (header.includes('规则id') || header.includes('ruleid') || header.includes('ruleids')) {
                    obj.ruleIds = value ? value.split(/[,;，；]/).map(id => id.trim()).filter(id => id) : [];
                }
            }

            // 根据类型设置默认值
            if (type === 'prompts') {
                obj.title = obj.title || obj.name || '未命名提示词';
                obj.content = obj.content || obj.title;
                obj.category = obj.category || '未分类';
            } else if (type === 'websites') {
                obj.title = obj.title || obj.name || '未命名网站';
                obj.description = obj.description || '';
                obj.category = obj.category || '未分类';
            } else if (type === 'filters') {
                obj.name = obj.name || obj.title || '未命名规则';
                obj.group = obj.group || obj.category || '未分组';
                obj.replace = obj.replace || '';
                obj.active = obj.active || false;
            } else if (type === 'presets') {
                obj.name = obj.name || obj.title || '未命名预设组';
                obj.description = obj.description || '';
                obj.ruleIds = obj.ruleIds || [];
                obj.enabled = obj.enabled !== undefined ? obj.enabled : true;
            }

            return obj;
        }

        // 初始化拖拽上传
        function initBatchDragUpload() {
            const uploadArea = document.getElementById('batchUploadArea');
            if (!uploadArea) return;

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    handleBatchFileSelect({ target: { files: [file] } });
                }
            });
        }

        // 模板相关函数
        function selectBatchTemplate(templateId) {
            batchSelectedTemplate = templateId;
            document.querySelectorAll('.batch-template-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.batch-template-card').classList.add('selected');
        }

        // 加载选中的模板
        function loadBatchSelectedTemplate() {
            if (!batchSelectedTemplate) {
                showToast('请先选择一个模板', 'warning');
                return;
            }

            const templates = getBatchTemplates();
            const templateData = templates[batchSelectedTemplate];
            
            if (templateData) {
                batchParsedData = {
                    prompts: templateData.prompts ? templateData.prompts.map(addBatchItemMeta) : [],
                    websites: templateData.websites ? templateData.websites.map(addBatchItemMeta) : [],
                    filters: templateData.filters ? templateData.filters.map(addBatchItemMeta) : [],
                    presets: templateData.presets ? templateData.presets.map(addBatchItemMeta) : [],
                    errors: []
                };

                updateBatchPreview();
                showToast('模板加载成功', 'success');
                
                // 切换到文本输入模式进行编辑
                switchBatchMethod('text');
                
                // 将数据转换为文本格式，方便编辑（自动处理换行符转换）
                generateTextFromBatchData();
            }
        }

        // 添加项目元数据
        function addBatchItemMeta(item) {
            return {
                ...item,
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                pinned: false,
                usageCount: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        }

        // 获取模板数据
        function getBatchTemplates() {
            return {
                'dev-prompts': {
                    prompts: [
                        {
                            title: '代码审查',
                            content: '请帮我审查这段代码，找出潜在的问题和优化点，包括：\n1. 代码逻辑错误\n2. 性能优化建议\n3. 代码规范检查\n4. 安全漏洞排查',
                            category: '编程/代码质量',
                            tags: ['代码审查', '优化', '安全']
                        },
                        {
                            title: 'Bug修复助手',
                            content: '这段代码有个bug，请帮我：\n1. 分析问题原因\n2. 提供修复方案\n3. 解释为什么会出现这个问题\n4. 给出预防措施',
                            category: '编程/调试',
                            tags: ['调试', 'Bug修复', '问题分析']
                        },
                        {
                            title: 'API设计',
                            content: '请帮我设计一个RESTful API，包括：\n1. 端点设计\n2. 请求响应格式\n3. 错误处理\n4. 认证授权\n5. 文档说明',
                            category: '编程/API',
                            tags: ['API', 'RESTful', '接口设计']
                        }
                    ],
                    filters: [
                        {
                            name: '调试日志清理',
                            regex: 'console\\.log\\([^)]*\\);?',
                            replace: '',
                            group: '代码清理/调试',
                            tags: ['调试', '日志', '清理'],
                            active: true
                        },
                        {
                            name: '注释清理',
                            regex: '//.*$',
                            replace: '',
                            group: '代码清理/注释',
                            tags: ['注释', '清理'],
                            active: true
                        }
                    ],
                    presets: [
                        {
                            name: '开发环境清理',
                            description: '清理开发过程中的调试代码和注释',
                            ruleIds: ['filter_dev_001', 'filter_dev_002'],
                            enabled: true
                        }
                    ]
                },
                'ai-tools': {
                    websites: [
                        {
                            title: 'ChatGPT',
                            url: 'https://chat.openai.com',
                            description: 'OpenAI开发的AI对话助手，支持编程、写作、翻译等多种任务',
                            category: 'AI工具/对话助手',
                            tags: ['AI', '对话', '编程助手']
                        },
                        {
                            title: 'Claude',
                            url: 'https://claude.ai',
                            description: 'Anthropic开发的AI助手，擅长长文本处理和深度分析',
                            category: 'AI工具/对话助手',
                            tags: ['AI', '对话', '文本分析']
                        },
                        {
                            title: 'Copilot',
                            url: 'https://github.com/features/copilot',
                            description: 'GitHub的AI编程助手，提供智能代码补全和建议',
                            category: 'AI工具/编程助手',
                            tags: ['AI', '编程', 'GitHub']
                        }
                    ]
                },
                'writing': {
                    prompts: [
                        {
                            title: '文章润色',
                            content: '请帮我润色这篇文章，改善：\n1. 语言流畅度\n2. 表达准确性\n3. 逻辑结构\n4. 语法错误\n5. 用词优化',
                            category: '写作/润色',
                            tags: ['写作', '润色', '优化']
                        },
                        {
                            title: '标题生成器',
                            content: '基于以下内容，生成5-10个吸引人的标题：\n1. 突出核心价值\n2. 增加吸引力\n3. 适合目标受众\n4. 便于传播分享',
                            category: '写作/创意',
                            tags: ['标题', '创意', '营销']
                        }
                    ]
                },
                'learning': {
                    websites: [
                        {
                            title: 'Coursera',
                            url: 'https://www.coursera.org',
                            description: '全球知名在线课程平台，提供大学级别的课程',
                            category: '学习/在线课程',
                            tags: ['教育', '课程', '大学']
                        },
                        {
                            title: 'MDN Web Docs',
                            url: 'https://developer.mozilla.org',
                            description: 'Web开发者的权威技术文档',
                            category: '学习/技术文档',
                            tags: ['Web开发', '文档', '前端']
                        }
                    ]
                },
                'productivity': {
                    websites: [
                        {
                            title: 'Notion',
                            url: 'https://www.notion.so',
                            description: '全能工作空间，集笔记、任务、数据库于一体',
                            category: '效率/笔记工具',
                            tags: ['笔记', '协作', '数据库']
                        },
                        {
                            title: 'Todoist',
                            url: 'https://todoist.com',
                            description: '功能强大的任务管理工具',
                            category: '效率/任务管理',
                            tags: ['任务管理', 'GTD', '时间管理']
                        }
                    ]
                },
                'design': {
                    websites: [
                        {
                            title: 'Figma',
                            url: 'https://www.figma.com',
                            description: '在线协作设计工具，支持UI/UX设计',
                            category: '设计/设计工具',
                            tags: ['设计', 'UI', '协作']
                        },
                        {
                            title: 'Dribbble',
                            url: 'https://dribbble.com',
                            description: '设计师作品展示和灵感分享平台',
                            category: '设计/灵感',
                            tags: ['设计', '灵感', '作品展示']
                        }
                    ]
                }
            };
        }

        // 更新批量预览
        function updateBatchPreview() {
            const container = document.getElementById('batchPreviewContainer');
            const total = batchParsedData.prompts.length + batchParsedData.websites.length + 
                         batchParsedData.filters.length + (batchParsedData.presets || []).length + batchParsedData.errors.length;

            // 更新统计
            document.getElementById('batchTotalItems').textContent = total;
            document.getElementById('batchPromptItems').textContent = batchParsedData.prompts.length;
            document.getElementById('batchWebsiteItems').textContent = batchParsedData.websites.length;
            document.getElementById('batchFilterItems').textContent = batchParsedData.filters.length;
            document.getElementById('batchPresetItems').textContent = (batchParsedData.presets || []).length;
            document.getElementById('batchErrorItems').textContent = batchParsedData.errors.length;
            document.getElementById('batchPreviewCount').textContent = `(${total}条)`;

            // 启用导入按钮
            document.getElementById('batchImportBtn').disabled = 
                batchParsedData.prompts.length === 0 && 
                batchParsedData.websites.length === 0 && 
                batchParsedData.filters.length === 0 && 
                (batchParsedData.presets || []).length === 0;

            if (total === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">📋</div>
                        <div>暂无数据，请在左侧输入或导入数据</div>
                    </div>
                `;
                return;
            }

            let html = '';

            // 显示提示词
            batchParsedData.prompts.forEach(prompt => {
                html += `
                    <div class="batch-preview-item">
                        <div class="batch-preview-title">📝 ${escapeHtml(prompt.title)}</div>
                        <div class="batch-preview-content">${escapeHtml((prompt.content || '').substring(0, 100))}${(prompt.content || '').length > 100 ? '...' : ''}</div>
                        <div class="batch-preview-meta">
                            <span>分类: ${prompt.category || '未分类'}</span>
                            <span>标签: ${(prompt.tags || []).map(t => `<span class="batch-preview-tag">${t}</span>`).join('')}</span>
                        </div>
                    </div>
                `;
            });

            // 显示网站
            batchParsedData.websites.forEach(website => {
                html += `
                    <div class="batch-preview-item">
                        <div class="batch-preview-title">🌐 ${escapeHtml(website.title)}</div>
                        <div class="batch-preview-content">${escapeHtml(website.url)}</div>
                        ${website.description ? `<div class="batch-preview-content">${escapeHtml(website.description)}</div>` : ''}
                        <div class="batch-preview-meta">
                            <span>分类: ${website.category || '未分类'}</span>
                            <span>标签: ${(website.tags || []).map(t => `<span class="batch-preview-tag">${t}</span>`).join('')}</span>
                        </div>
                    </div>
                `;
            });

            // 显示过滤规则
            batchParsedData.filters.forEach(filter => {
                html += `
                    <div class="batch-preview-item">
                        <div class="batch-preview-title">🔧 ${escapeHtml(filter.name)}</div>
                        <div class="batch-preview-content">正则: ${escapeHtml(filter.regex)}</div>
                        ${filter.replace ? `<div class="batch-preview-content">替换: ${escapeHtml(filter.replace)}</div>` : ''}
                        <div class="batch-preview-meta">
                            <span>分组: ${filter.group || '未分组'}</span>
                            <span>标签: ${(filter.tags || []).map(t => `<span class="batch-preview-tag">${t}</span>`).join('')}</span>
                        </div>
                    </div>
                `;
            });

            // 显示预设组
            if (batchParsedData.presets) {
                batchParsedData.presets.forEach(preset => {
                    html += `
                        <div class="batch-preview-item">
                            <div class="batch-preview-title">📦 ${escapeHtml(preset.name)}</div>
                            <div class="batch-preview-content">${escapeHtml(preset.description || '')}</div>
                            <div class="batch-preview-content">规则ID: ${(preset.ruleIds || []).join(', ')}</div>
                            <div class="batch-preview-meta">
                                <span>状态: ${preset.enabled ? '启用' : '禁用'}</span>
                                <span>规则数量: ${(preset.ruleIds || []).length}</span>
                            </div>
                        </div>
                    `;
                });
            }

            // 显示错误
            batchParsedData.errors.forEach(error => {
                html += `
                    <div class="batch-preview-item error">
                        <div class="batch-preview-title">❌ 第 ${error.line} 行解析错误</div>
                        <div class="batch-preview-content">${escapeHtml(error.content)}</div>
                        <div class="batch-preview-meta">
                            <span>错误: ${error.error}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 验证批量数据
        function validateBatchData() {
            let issues = [];

            // 首先检查是否有任何数据
            const hasData = batchParsedData.prompts.length > 0 || 
                           batchParsedData.websites.length > 0 || 
                           batchParsedData.filters.length > 0 || 
                           (batchParsedData.presets || []).length > 0;

            if (!hasData) {
                showToast('数据验证失败！没有检测到任何有效数据，请检查导入的文件格式或内容。', 'error');
                return;
            }

            // 验证提示词
            batchParsedData.prompts.forEach((prompt, index) => {
                if (!prompt.title) issues.push(`提示词 #${index + 1} 缺少标题`);
                if (!prompt.content) issues.push(`提示词 #${index + 1} 缺少内容`);
                if (prompt.content && prompt.content.length > 10000) {
                    issues.push(`提示词 #${index + 1} 内容过长（超过10000字符）`);
                }
            });

            // 验证网站
            batchParsedData.websites.forEach((website, index) => {
                if (!website.title) issues.push(`网站 #${index + 1} 缺少标题`);
                if (!website.url) issues.push(`网站 #${index + 1} 缺少网址`);
                if (website.url && !isValidBatchUrl(website.url)) {
                    issues.push(`网站 #${index + 1} 网址格式无效`);
                }
            });

            // 验证过滤规则
            batchParsedData.filters.forEach((filter, index) => {
                if (!filter.name) issues.push(`过滤规则 #${index + 1} 缺少名称`);
                if (!filter.regex) issues.push(`过滤规则 #${index + 1} 缺少正则表达式`);
                if (filter.regex) {
                    try {
                        new RegExp(filter.regex);
                    } catch (e) {
                        issues.push(`过滤规则 #${index + 1} 正则表达式无效: ${e.message}`);
                    }
                }
            });

            if (issues.length > 0) {
                const issueText = issues.slice(0, 5).join('；') + (issues.length > 5 ? `...还有${issues.length - 5}个问题` : '');
                showToast('数据验证发现问题：' + issueText, 'error');
            } else {
                showToast('数据验证通过！所有数据格式正确，可以安全导入。', 'success');
            }
        }

        // 导入到系统
        function importBatchToSystem() {
            if (batchParsedData.prompts.length === 0 && 
                batchParsedData.websites.length === 0 && 
                batchParsedData.filters.length === 0 && 
                (batchParsedData.presets || []).length === 0) {
                showToast('没有可导入的数据', 'warning');
                return;
            }

            // 显示进度条
            const progressBar = document.getElementById('batchProgressBar');
            const progressFill = document.getElementById('batchProgressFill');
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            const total = batchParsedData.prompts.length + batchParsedData.websites.length + batchParsedData.filters.length + (batchParsedData.presets || []).length;
            let processed = 0;

            // 模拟导入过程
            const importInterval = setInterval(() => {
                processed += Math.min(5, total - processed);
                const progress = (processed / total) * 100;
                progressFill.style.width = progress + '%';

                if (processed >= total) {
                    clearInterval(importInterval);
                    
                    // 实际导入数据
                    try {
                        // 合并到现有数据
                        if (batchParsedData.prompts.length > 0) {
                            appData.prompts = [...appData.prompts, ...batchParsedData.prompts];
                        }
                        if (batchParsedData.websites.length > 0) {
                            appData.websites = [...appData.websites, ...batchParsedData.websites];
                        }
                        if (batchParsedData.filters.length > 0) {
                            appData.filters = [...appData.filters, ...batchParsedData.filters];
                        }
                        if (batchParsedData.presets && batchParsedData.presets.length > 0) {
                            filterState.presets = [...(filterState.presets || []), ...batchParsedData.presets];
                            savePresetsToStorage();
                        }

                        // 保存数据
                        saveData();
                        
                        // 刷新界面
                        renderAll();
                        updateCategories();
                        updateAllFunctionTags();

                        setTimeout(() => {
                            progressBar.style.display = 'none';
                            const presetCount = (batchParsedData.presets || []).length;
                            let message = `成功导入 ${batchParsedData.prompts.length} 个提示词、${batchParsedData.websites.length} 个网站、${batchParsedData.filters.length} 个过滤规则`;
                            if (presetCount > 0) {
                                message += `、${presetCount} 个预设组`;
                            }
                            showToast(message, 'success');
                            
                            // 关闭工具并清空数据
                            setTimeout(() => {
                                closeBatchImportTool();
                            }, 1000);
                        }, 500);
                    } catch (error) {
                        progressBar.style.display = 'none';
                        showToast('导入失败：' + error.message, 'error');
                    }
                }
            }, 100);
        }

        // 导出为JSON
        function exportBatchAsJson() {
            if (batchParsedData.prompts.length === 0 && 
                batchParsedData.websites.length === 0 && 
                batchParsedData.filters.length === 0 &&
                (batchParsedData.presets || []).length === 0) {
                showToast('没有可导出的数据', 'warning');
                return;
            }

            const dataToExport = {
                prompts: batchParsedData.prompts,
                websites: batchParsedData.websites,
                filters: batchParsedData.filters,
                presets: batchParsedData.presets || [],
                meta: {
                    exportDate: new Date().toISOString(),
                    source: 'Batch Import Tool',
                    totalItems: batchParsedData.prompts.length + batchParsedData.websites.length + batchParsedData.filters.length + (batchParsedData.presets || []).length
                }
            };

            downloadJSON(dataToExport, `batch_import_${new Date().getTime()}.json`);
            showToast('导出成功', 'success');
        }

        // 下载模板文件
        function downloadBatchTemplate() {
            const template = `标题,内容,分类,标签
代码审查助手,帮我检查代码问题,编程/代码质量,"代码审查,优化"
React组件开发,创建可复用的React组件,编程/前端,"React,组件"
SQL优化,优化数据库查询性能,编程/数据库,"SQL,性能优化"

名称,网址,描述,分类,标签
GitHub,https://github.com,代码托管平台,开发工具,"Git,开源"
Stack Overflow,https://stackoverflow.com,程序员问答社区,开发工具,"问答,编程"
MDN文档,https://developer.mozilla.org,Web开发文档,开发工具,"文档,前端"

名称,正则表达式,替换内容,分组,标签
手机号脱敏,(\d{3})\d{4}(\d{4}),$1****$2,隐私保护,"隐私,脱敏"
邮箱脱敏,(\w+)@(\w+),***@$2,隐私保护,"隐私,邮箱"

名称,描述,规则ID列表,启用状态
隐私保护套装,包含手机号和邮箱脱敏规则,"filter_001,filter_002",启用
开发清理工具,清理调试日志和注释,"filter_003,filter_004",启用`;

            const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
            downloadFile(blob, 'batch_import_template.csv');
            showToast('模板下载成功', 'success');
        }

        // 清空批量输入
        function clearBatchInput() {
            if (confirm('确定要清空输入内容吗？')) {
                document.getElementById('batchNaturalInput').value = '';
                showToast('已清空', 'success');
            }
        }

        // 清空批量数据
        function clearBatchAll() {
            batchParsedData = {
                prompts: [],
                websites: [],
                filters: [],
                presets: [],
                errors: []
            };
            batchSelectedTemplate = null;
            batchTargetType = 'all';
            updateBatchPreview();
        }

        // 预览模板
        function previewBatchTemplate() {
            if (!batchSelectedTemplate) {
                showToast('请先选择一个模板', 'warning');
                return;
            }

            const templates = getBatchTemplates();
            const templateData = templates[batchSelectedTemplate];
            
            if (templateData) {
                const previewData = {
                    prompts: templateData.prompts || [],
                    websites: templateData.websites || [],
                    filters: templateData.filters || [],
                    presets: templateData.presets || [],
                    errors: []
                };

                const totalItems = previewData.prompts.length + previewData.websites.length + previewData.filters.length + previewData.presets.length;
                const templateName = document.querySelector('.batch-template-card.selected .batch-template-name').textContent;
                
                showToast(`模板预览：${templateName} - 提示词: ${previewData.prompts.length} 个，网站: ${previewData.websites.length} 个，过滤规则: ${previewData.filters.length} 个，预设组: ${previewData.presets.length} 个，总计: ${totalItems} 条数据`, 'info');
            }
        }

        // 验证URL格式
        function isValidBatchUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // ====== 加载现有数据相关函数 ======
        let selectedExistingData = {
            prompts: [],
            websites: [],
            filters: [],
            presets: []
        };

        // 初始化加载现有数据面板
        function initExistingDataPanel() {
            // 更新数据计数
            const existingPromptsCount = document.getElementById('existingPromptsCount');
            const existingWebsitesCount = document.getElementById('existingWebsitesCount');
            const existingFiltersCount = document.getElementById('existingFiltersCount');
            const existingPresetsCount = document.getElementById('existingPresetsCount');
            
            if (existingPromptsCount) existingPromptsCount.textContent = appData.prompts.length;
            if (existingWebsitesCount) existingWebsitesCount.textContent = appData.websites.length;
            if (existingFiltersCount) existingFiltersCount.textContent = appData.filters.length;
            if (existingPresetsCount) existingPresetsCount.textContent = (filterState.presets || []).length;

            // 填充分类下拉框
            updateCategoryFilter();
            
            // 初始预览
            updateExistingDataPreview();
        }

        // 更新分类筛选器
        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            if (!categoryFilter) {
                console.warn('categoryFilter 元素不存在');
                return;
            }
            const categories = new Set();
            
            // 收集所有分类
            appData.prompts.forEach(item => {
                if (item.category) categories.add(item.category);
            });
            appData.websites.forEach(item => {
                if (item.category) categories.add(item.category);
            });
            appData.filters.forEach(item => {
                if (item.group) categories.add(item.group);
            });

            // 清空并重新填充
            categoryFilter.innerHTML = '<option value="">全部分类</option>';
            [...categories].sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        // 更新现有数据预览
        function updateExistingDataPreview() {
            const loadPrompts = document.getElementById('loadPrompts').checked;
            const loadWebsites = document.getElementById('loadWebsites').checked;
            const loadFilters = document.getElementById('loadFilters').checked;
            const loadPresets = document.getElementById('loadPresets').checked;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const tagFilter = document.getElementById('tagFilter').value.toLowerCase();
            const onlyPinned = document.getElementById('onlyPinned').checked;
            const onlyActive = document.getElementById('onlyActive').checked;

            let filteredData = [];

            // 筛选提示词
            if (loadPrompts) {
                const filtered = appData.prompts.filter(item => {
                    if (onlyPinned && !item.pinned) return false;
                    if (categoryFilter && item.category !== categoryFilter) return false;
                    if (tagFilter && !(item.tags || []).some(tag => tag.toLowerCase().includes(tagFilter))) return false;
                    return true;
                });
                filteredData.push(...filtered.map(item => ({ ...item, type: 'prompt' })));
            }

            // 筛选网站
            if (loadWebsites) {
                const filtered = appData.websites.filter(item => {
                    if (onlyPinned && !item.pinned) return false;
                    if (categoryFilter && item.category !== categoryFilter) return false;
                    if (tagFilter && !(item.tags || []).some(tag => tag.toLowerCase().includes(tagFilter))) return false;
                    return true;
                });
                filteredData.push(...filtered.map(item => ({ ...item, type: 'website' })));
            }

            // 筛选过滤规则
            if (loadFilters) {
                const filtered = appData.filters.filter(item => {
                    if (onlyPinned && !item.pinned) return false;
                    if (onlyActive && !item.active) return false;
                    if (categoryFilter && item.group !== categoryFilter) return false;
                    if (tagFilter && !(item.tags || []).some(tag => tag.toLowerCase().includes(tagFilter))) return false;
                    return true;
                });
                filteredData.push(...filtered.map(item => ({ ...item, type: 'filter' })));
            }

            // 筛选预设组
            if (loadPresets) {
                const filtered = (filterState.presets || []).filter(item => {
                    if (categoryFilter && item.name !== categoryFilter) return false;
                    if (tagFilter && !item.name.toLowerCase().includes(tagFilter)) return false;
                    return true;
                });
                filteredData.push(...filtered.map(item => ({ ...item, type: 'preset' })));
            }

            // 更新计数
            document.getElementById('filteredDataCount').textContent = filteredData.length;

            // 渲染预览
            renderExistingDataPreview(filteredData);

            return filteredData;
        }

        // 渲染现有数据预览
        function renderExistingDataPreview(data) {
            const container = document.getElementById('existingDataPreview');
            
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">没有符合条件的数据</div>';
                return;
            }

            let html = '';
            data.forEach((item, index) => {
                const isSelected = isItemSelected(item);
                const typeIcon = item.type === 'prompt' ? '📝' : 
                                item.type === 'website' ? '🌐' : 
                                item.type === 'filter' ? '🔧' : '📦';
                const title = item.title || item.name || '无标题';
                const description = item.type === 'prompt' ? (item.content || '').substring(0, 50) :
                                 item.type === 'website' ? item.url :
                                 item.type === 'filter' ? `正则: ${item.regex || ''}` :
                                 `规则: ${(item.ruleIds || []).join(', ')}`;

                html += `
                    <div class="existing-data-item ${isSelected ? 'selected' : ''}" onclick="toggleExistingDataItem(${index})" data-index="${index}">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleExistingDataItem(${index})">
                            <span>${typeIcon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px;">${escapeHtml(title)}</div>
                                <div style="color: #666; font-size: 11px;">${escapeHtml(description)}${description.length > 50 ? '...' : ''}</div>
                                <div style="color: #999; font-size: 10px;">
                                    ${item.type === 'filter' ? `分组: ${item.group || '未分组'}` : 
                                      item.type === 'preset' ? `规则数: ${(item.ruleIds || []).length}` :
                                      `分类: ${item.category || '未分类'}`}
                                    ${(item.tags || []).length > 0 ? ` | 标签: ${item.tags.join(', ')}` : ''}
                                    ${item.type === 'preset' && item.enabled !== undefined ? ` | 状态: ${item.enabled ? '启用' : '禁用'}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.filteredData = data; // 存储过滤后的数据
        }

        // 检查项目是否被选中
        function isItemSelected(item) {
            const lists = [selectedExistingData.prompts, selectedExistingData.websites, selectedExistingData.filters, selectedExistingData.presets];
            return lists.some(list => list.some(selected => selected.id === item.id));
        }

        // 切换现有数据项选择状态
        function toggleExistingDataItem(index) {
            const container = document.getElementById('existingDataPreview');
            const filteredData = container.filteredData;
            if (!filteredData || index >= filteredData.length) return;

            const item = filteredData[index];
            const isCurrentlySelected = isItemSelected(item);

            if (isCurrentlySelected) {
                // 取消选择
                if (item.type === 'prompt') {
                    selectedExistingData.prompts = selectedExistingData.prompts.filter(p => p.id !== item.id);
                } else if (item.type === 'website') {
                    selectedExistingData.websites = selectedExistingData.websites.filter(w => w.id !== item.id);
                } else if (item.type === 'filter') {
                    selectedExistingData.filters = selectedExistingData.filters.filter(f => f.id !== item.id);
                } else if (item.type === 'preset') {
                    selectedExistingData.presets = selectedExistingData.presets.filter(p => p.id !== item.id);
                }
            } else {
                // 选择
                const cleanItem = { ...item };
                delete cleanItem.type; // 移除临时的type字段
                
                if (item.type === 'prompt') {
                    selectedExistingData.prompts.push(cleanItem);
                } else if (item.type === 'website') {
                    selectedExistingData.websites.push(cleanItem);
                } else if (item.type === 'filter') {
                    selectedExistingData.filters.push(cleanItem);
                } else if (item.type === 'preset') {
                    selectedExistingData.presets.push(cleanItem);
                }
            }

            // 重新渲染预览
            renderExistingDataPreview(filteredData);
        }

        // 全选现有数据
        function selectAllExistingData() {
            const filteredData = updateExistingDataPreview();
            
            selectedExistingData = {
                prompts: [],
                websites: [],
                filters: [],
                presets: []
            };

            filteredData.forEach(item => {
                const cleanItem = { ...item };
                delete cleanItem.type;
                
                if (item.type === 'prompt') {
                    selectedExistingData.prompts.push(cleanItem);
                } else if (item.type === 'website') {
                    selectedExistingData.websites.push(cleanItem);
                } else if (item.type === 'filter') {
                    selectedExistingData.filters.push(cleanItem);
                } else if (item.type === 'preset') {
                    selectedExistingData.presets.push(cleanItem);
                }
            });

            renderExistingDataPreview(filteredData);
            showToast(`已选择 ${filteredData.length} 条数据`, 'success');
        }

        // 清除所有选择
        function clearAllExistingData() {
            selectedExistingData = {
                prompts: [],
                websites: [],
                filters: [],
                presets: []
            };

            const filteredData = updateExistingDataPreview();
            renderExistingDataPreview(filteredData);
            showToast('已清除所有选择', 'success');
        }

        // 加载选中的现有数据到批量编辑器
        function loadExistingDataToBatch() {
            const totalSelected = selectedExistingData.prompts.length + 
                                selectedExistingData.websites.length + 
                                selectedExistingData.filters.length + 
                                selectedExistingData.presets.length;

            if (totalSelected === 0) {
                showToast('请先选择要加载的数据', 'warning');
                return;
            }

            // 复制数据到批量编辑器，并添加新的ID以避免冲突
            batchParsedData = {
                prompts: selectedExistingData.prompts.map(item => ({
                    ...item,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9) // 生成新ID
                })),
                websites: selectedExistingData.websites.map(item => ({
                    ...item,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9)
                })),
                filters: selectedExistingData.filters.map(item => ({
                    ...item,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9)
                })),
                presets: selectedExistingData.presets.map(item => ({
                    ...item,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9)
                })),
                errors: []
            };

            // 更新预览
            updateBatchPreview();

            showToast(`成功加载 ${totalSelected} 条数据到编辑器`, 'success');
            
            // 切换到文本输入模式进行编辑
            switchBatchMethod('text');
            
            // 将数据转换为文本格式，方便编辑
            generateTextFromBatchData();
        }

        // 将批量数据转换为文本格式（将特殊字符转换为转义符）
        function generateTextFromBatchData() {
            let textContent = '';

            // 转换提示词
            batchParsedData.prompts.forEach(prompt => {
                const tags = (prompt.tags || []).map(tag => `#${tag}`).join(' ');
                // 转换所有特殊字符为转义符
                const content = escapeSpecialChars(prompt.content || '');
                textContent += `${prompt.title}：${content} ${tags}\n`;
            });

            // 转换网站
            batchParsedData.websites.forEach(website => {
                const tags = (website.tags || []).map(tag => `#${tag}`).join(' ');
                const description = website.description ? ` - ${escapeSpecialChars(website.description)}` : '';
                textContent += `${website.title} - ${website.url}${description} ${tags}\n`;
            });

            // 转换过滤规则
            batchParsedData.filters.forEach(filter => {
                const tags = (filter.tags || []).map(tag => `#${tag}`).join(' ');
                const replace = filter.replace ? ` 替换：${escapeSpecialChars(filter.replace)}` : '';
                textContent += `${filter.name} 正则：${filter.regex}${replace} ${tags}\n`;
            });

            // 转换预设组
            batchParsedData.presets.forEach(preset => {
                const status = preset.enabled ? '启用' : '禁用';
                const description = escapeSpecialChars(preset.description || '');
                textContent += `${preset.name}：${description}\\n规则：${(preset.ruleIds || []).join(', ')}\\n状态：${status}\n`;
                textContent += '===ENTRY_SEPARATOR===\n'; // 使用明确的分隔符
            });

            // 设置到文本输入框
            document.getElementById('batchNaturalInput').value = textContent.trim();
        }

        // 转义特殊字符的辅助函数
        function escapeSpecialChars(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')  // 先转义反斜杠
                .replace(/\n/g, '\\n')   // 转义换行符
                .replace(/\t/g, '\\t');  // 转义制表符
        }

        // 反转义特殊字符的辅助函数
        function unescapeSpecialChars(text) {
            if (!text) return '';
            return text
                .replace(/\\n/g, '\n')   // 反转义换行符
                .replace(/\\t/g, '\t')   // 反转义制表符
                .replace(/\\\\/g, '\\'); // 最后反转义反斜杠
        }

        // 单模块导入数据
        function importModuleData(moduleType) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv,.txt';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onerror = function() {
                    showToast('文件读取失败', 'error');
                };
                
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // 检测数据类型
                        let dataTypeInfo = detectDataType(importedData);
                        
                        // 验证数据类型是否匹配
                        if (dataTypeInfo.type !== moduleType && dataTypeInfo.type !== 'complete') {
                            showToast(`数据类型不匹配！期望${getModuleDisplayName(moduleType)}数据，但检测到${dataTypeInfo.description}`, 'error');
                            return;
                        }
                        
                        let confirmMessage = '';
                        if (dataTypeInfo.type === 'complete') {
                            confirmMessage = `检测到完整备份数据，将只导入其中的${getModuleDisplayName(moduleType)}部分，确定继续吗？`;
                        } else {
                            confirmMessage = `确定要导入${dataTypeInfo.description}吗？这将覆盖当前的${getModuleDisplayName(moduleType)}数据。`;
                        }
                        
                        if (confirm(confirmMessage)) {
                            let success = false;
                            let importCount = 0;
                            
                            if (moduleType === 'prompts') {
                                const sourceData = dataTypeInfo.type === 'complete' ? importedData.prompts || [] : importedData;
                                appData.prompts = validateAndCleanPrompts(sourceData);
                                importCount = appData.prompts.length;
                                success = true;
                            } else if (moduleType === 'websites') {
                                const sourceData = dataTypeInfo.type === 'complete' ? importedData.websites || [] : importedData;
                                appData.websites = validateAndCleanWebsites(sourceData);
                                importCount = appData.websites.length;
                                success = true;
                            } else if (moduleType === 'filters') {
                                const sourceData = dataTypeInfo.type === 'complete' ? importedData.filters || [] : importedData;
                                appData.filters = validateAndCleanFilters(sourceData);
                                importCount = appData.filters.length;
                                success = true;
                            }
                            
                            if (success) {
                                saveData();
                                renderAll();
                                updateCategories();
                                showToast(`成功导入 ${importCount} 条${getModuleDisplayName(moduleType)}数据`);
                            } else {
                                showToast('导入失败：数据格式不正确', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('导入失败：JSON格式错误', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // 检测数据类型
        function detectDataType(data) {
            if (data && typeof data === 'object' && !Array.isArray(data)) {
                // 检查是否为完整数据格式
                if (data.prompts && Array.isArray(data.prompts) && 
                    data.websites && Array.isArray(data.websites) &&
                    data.filters && Array.isArray(data.filters)) {
                    return {
                        type: 'complete',
                        description: '完整应用数据备份',
                        warning: '这将覆盖所有现有数据（提示词、网站、过滤规则）！',
                        successMessage: '完整数据'
                    };
                }
            }
            
            if (Array.isArray(data) && data.length > 0) {
                const firstItem = data[0];
                if (firstItem && typeof firstItem === 'object') {
                    // 检查预设组格式
                    if (firstItem.name && firstItem.ruleIds && Array.isArray(firstItem.ruleIds)) {
                        return {
                            type: 'presets',
                            description: `过滤规则预设组 (${data.length} 个预设)`,
                            warning: '将添加到现有预设组中',
                            successMessage: '预设组'
                        };
                    }
                    // 检查提示词格式
                    else if (firstItem.content && firstItem.title) {
                        return {
                            type: 'prompts',
                            description: `提示词数据 (${data.length} 条)`,
                            warning: '这将覆盖现有的提示词数据！',
                            successMessage: '提示词'
                        };
                    }
                    // 检查网站格式
                    else if (firstItem.url && firstItem.title) {
                        return {
                            type: 'websites',
                            description: `网站收藏数据 (${data.length} 条)`,
                            warning: '这将覆盖现有的网站收藏数据！',
                            successMessage: '网站收藏'
                        };
                    }
                    // 检查过滤规则格式
                    else if (firstItem.regex && firstItem.name) {
                        return {
                            type: 'filters',
                            description: `过滤规则数据 (${data.length} 条)`,
                            warning: '这将覆盖现有的过滤规则数据！',
                            successMessage: '过滤规则'
                        };
                    }
                }
            }
            
            return {
                type: 'unknown',
                description: '未知数据格式',
                warning: '无法识别数据格式',
                successMessage: ''
            };
        }
        
        // 获取模块显示名称
        function getModuleDisplayName(moduleType) {
            const nameMap = {
                'prompts': '提示词',
                'websites': '网站收藏', 
                'filters': '过滤规则',
                'presets': '过滤规则预设组'
            };
            return nameMap[moduleType] || moduleType;
        }
        
        function validateAndCleanPrompts(prompts) {
            return prompts.filter(item => item && item.title && item.content)
                         .map(item => ({
                             id: item.id || Date.now().toString() + Math.random(),
                             title: String(item.title).trim(),
                             content: String(item.content).trim(),
                             category: String(item.category || '默认').trim(),
                             tags: Array.isArray(item.tags) ? item.tags : [],
                             pinned: Boolean(item.pinned),
                             usageCount: Number(item.usageCount) || 0,
                             createdAt: item.createdAt || new Date().toISOString(),
                             updatedAt: item.updatedAt || new Date().toISOString(),
                             lastUsed: item.lastUsed || null
                         }));
        }
        
        function validateAndCleanWebsites(websites) {
            return websites.filter(item => item && item.title && item.url)
                          .map(item => ({
                              id: item.id || Date.now().toString() + Math.random(),
                              title: String(item.title).trim(),
                              url: String(item.url).trim(),
                              description: String(item.description || '').trim(),
                              category: String(item.category || '默认').trim(),
                              tags: Array.isArray(item.tags) ? item.tags : [],
                              pinned: Boolean(item.pinned),
                              usageCount: Number(item.usageCount) || 0,
                              createdAt: item.createdAt || new Date().toISOString(),
                              updatedAt: item.updatedAt || new Date().toISOString(),
                              lastUsed: item.lastUsed || null
                          }));
        }
        
        function validateAndCleanPresets(presets) {
            return presets.filter(item => item && item.name && Array.isArray(item.ruleIds))
                         .map(item => ({
                             id: item.id || Date.now().toString() + Math.random(),
                             name: String(item.name).trim(),
                             description: item.description ? String(item.description).trim() : '',
                             ruleIds: Array.isArray(item.ruleIds) ? item.ruleIds : [],
                             enabled: Boolean(item.enabled),
                             createdAt: item.createdAt || new Date().toISOString()
                         }));
        }

        function validateAndCleanFilters(filters) {
            return filters.filter(item => item && item.name && item.regex)
                         .map(item => {
                             // 验证正则表达式
                             try {
                                 new RegExp(item.regex);
                                 return {
                                     id: item.id || Date.now().toString() + Math.random(),
                                     name: String(item.name).trim(),
                                     regex: String(item.regex).trim(),
                                     replace: String(item.replace || ''),
                                     group: String(item.group || '未分组').trim(),
                                     tags: Array.isArray(item.tags) ? item.tags : [],
                                     pinned: Boolean(item.pinned),
                                     active: Boolean(item.active),
                                     usageCount: Number(item.usageCount) || 0,
                                     createdAt: item.createdAt || new Date().toISOString(),
                                     updatedAt: item.updatedAt || new Date().toISOString()
                                 };
                             } catch (error) {
                                 console.warn(`Invalid regex filter skipped: ${item.name}`);
                                 return null;
                             }
                         }).filter(Boolean);
        }

        function clearAllData() {
            if (confirm('确定要清空所有数据吗？此操作不可撤销！')) {
                appData = {
                    prompts: [],
                    websites: [],
                    filters: [],
                    settings: {
                        theme: 'light',
                        autoBackup: true
                    }
                };
                saveData();
                renderAll();
                updateCategories();
                showToast('所有数据已清空');
            }
        }

        // 工具函数
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text || '');
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message || '操作完成';
            toast.className = `toast ${type} show`;
            
            // 清除上一个定时器
            if (toast.timeoutId) {
                clearTimeout(toast.timeoutId);
            }
            
            toast.timeoutId = setTimeout(() => {
                toast.classList.remove('show');
                toast.timeoutId = null;
            }, 3000);
        }

        // 移动端触摸优化
        let touchStartTime = 0;
        let touchStartTarget = null;
        
        document.addEventListener('touchstart', function(e) {
            touchStartTime = Date.now();
            touchStartTarget = e.target;
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            const touchDuration = Date.now() - touchStartTime;
            const target = e.target;
            
            // 长按手势处理 (500ms以上)
            if (touchDuration > 500 && target === touchStartTarget) {
                // 可以在这里添加长按功能，如显示上下文菜单
                if (target.closest('.item-card') && !target.closest('.batch-mode')) {
                    e.preventDefault();
                    // 例如：显示编辑菜单
                }
            }
        }, { passive: false });
        
        // 防止移动端双击缩放（改进版）
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            const touchDuration = now - touchStartTime;
            
            // 只在快速点击且不是长按的情况下处理
            if (touchDuration < 300 && e.target === touchStartTarget) {
                // 检查是否是可点击元素
                const clickableElement = e.target.closest('button, a, .btn, .nav-tab, .item-card, [onclick], [data-clickable]');
                if (clickableElement) {
                    e.preventDefault();
                    // 使用更精确的点击事件触发
                    setTimeout(() => {
                        const clickEvent = new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            clientX: e.changedTouches[0].clientX,
                            clientY: e.changedTouches[0].clientY
                        });
                        e.target.dispatchEvent(clickEvent);
                    }, 0);
                }
            }
        }, { passive: false });

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // 检查是否在输入框中
            const isInputFocused = document.activeElement && 
                                 (document.activeElement.tagName === 'INPUT' || 
                                  document.activeElement.tagName === 'TEXTAREA' || 
                                  document.activeElement.isContentEditable);
            
            if (e.ctrlKey || e.metaKey) {
                switch (e.key.toLowerCase()) {
                    case 'n':
                        if (!isInputFocused) {
                            e.preventDefault();
                            const activeTabElement = document.querySelector('.nav-tab.active');
                            if (activeTabElement) {
                                const activeTab = activeTabElement.dataset.tab;
                                if (activeTab === 'prompts') openModal('addPromptModal');
                                else if (activeTab === 'websites') openModal('addWebsiteModal');
                                else if (activeTab === 'privacy') openModal('addFilterModal');
                            }
                        }
                        break;
                    case 's':
                        if (!isInputFocused) {
                            e.preventDefault();
                            exportAllData();
                        }
                        break;
                    case 'b':
                        if (!isInputFocused) {
                            e.preventDefault();
                            const activeTabElement = document.querySelector('.nav-tab.active');
                            if (activeTabElement) {
                                const currentTab = activeTabElement.dataset.tab;
                                if (currentTab !== 'settings') {
                                    toggleBatchMode(currentTab);
                                }
                            }
                        }
                        break;
                }
            }
            
            if (e.key === '?' && !isInputFocused) {
                e.preventDefault();
                toggleShortcuts();
            }
            
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                } else {
                    // 隐藏快捷键提示
                    const panel = document.getElementById('shortcutsPanel');
                    if (panel && panel.classList.contains('show')) {
                        panel.classList.remove('show');
                    }
                }
            }
        });

        // 点击模态框外部关闭
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
        
        // 多级分类解析工具函数
        function parseCategory(categoryPath) {
            if (!categoryPath || typeof categoryPath !== 'string') {
                return ['默认'];
            }
            const parts = categoryPath.split('/').map(part => part.trim()).filter(part => part);
            return parts.length > 0 ? parts : ['默认'];
        }
        
        function buildCategoryTree(categories) {
            const tree = {};
            const categoryCount = {};
            
            // 首先计算每个分类的数量
            categories.forEach(categoryPath => {
                if (categoryPath && categoryPath !== '默认') {
                    categoryCount[categoryPath] = (categoryCount[categoryPath] || 0) + 1;
                }
            });
            
            // 构建树结构
            Object.keys(categoryCount).forEach(categoryPath => {
                const parts = parseCategory(categoryPath);
                let current = tree;
                
                parts.forEach((part, index) => {
                    const currentPath = parts.slice(0, index + 1).join('/');
                    
                    if (!current[part]) {
                        current[part] = {
                            name: part,
                            fullPath: currentPath,
                            children: {},
                            count: 0
                        };
                    }
                    
                    // 计算当前节点包含的所有子分类的数量
                    let nodeCount = 0;
                    Object.keys(categoryCount).forEach(cat => {
                        if (cat === currentPath || cat.startsWith(currentPath + '/')) {
                            nodeCount += categoryCount[cat];
                        }
                    });
                    current[part].count = nodeCount;
                    
                    current = current[part].children;
                });
            });
            
            return tree;
        }
        
        function renderCategoryTree(tree, level = 0, containerType = 'select') {
            let html = '';
            
            // 按名称排序
            const sortedKeys = Object.keys(tree).sort((a, b) => {
                return a.localeCompare(b, 'zh-CN');
            });
            
            sortedKeys.forEach(key => {
                const node = tree[key];
                
                if (containerType === 'select') {
                    // 为选择框生成层级缩进
                    const indent = '　'.repeat(level);
                    const prefix = level > 0 ? (level === 1 ? '├─ ' : '　├─ ') : '';
                    const displayName = `${indent}${prefix}${node.name}`;
                    const countInfo = node.count > 0 ? ` (${node.count})` : '';
                    
                    html += `<option value="${escapeHtml(node.fullPath)}">${escapeHtml(displayName)}${countInfo}</option>`;
                } else if (containerType === 'breadcrumb') {
                    html += `<span class="category-breadcrumb" onclick="filterByCategory('${escapeHtml(node.fullPath)}')">${escapeHtml(node.name)}</span>`;
                }
                
                // 递归渲染子分类
                if (Object.keys(node.children).length > 0) {
                    html += renderCategoryTree(node.children, level + 1, containerType);
                }
            });
            
            return html;
        }
        
        function getCategoryPath(fullPath) {
            if (!fullPath) return [];
            return fullPath.split('/').map(part => part.trim()).filter(part => part);
        }
        
        function getParentCategory(categoryPath) {
            const parts = parseCategory(categoryPath);
            if (parts.length <= 1) return '';
            return parts.slice(0, -1).join('/');
        }
        
        function renderCategoryBreadcrumb(categoryPath, type) {
            if (!categoryPath || categoryPath === '默认') {
                return '<span class="category-breadcrumb">默认</span>';
            }
            
            const parts = parseCategory(categoryPath);
            if (parts.length === 0 || (parts.length === 1 && parts[0] === '默认')) {
                return '<span class="category-breadcrumb">默认</span>';
            }
            
            let breadcrumbs = [];
            let currentPath = '';
            
            parts.forEach((part, index) => {
                currentPath = index === 0 ? part : currentPath + '/' + part;
                const encodedPath = escapeHtml(currentPath).replace(/'/g, '&quot;');
                const encodedPart = escapeHtml(part);
                
                breadcrumbs.push(
                    `<span class="category-breadcrumb" ` +
                    `onclick="filterByCategory('${type}', '${encodedPath}')" ` +
                    `title="点击筛选: ${encodedPath}">${encodedPart}</span>`
                );
                
                if (index < parts.length - 1) {
                    breadcrumbs.push('<span class="category-breadcrumb-separator">></span>');
                }
            });
            
            return breadcrumbs.join('');
        }
        
        function filterByCategory(type, categoryPath) {
            try {
                let categorySelect = null;
                let displayName = categoryPath || '所有分类';
                
                if (type === 'prompts') {
                    categorySelect = document.getElementById('promptCategory');
                    if (categorySelect) {
                        // 查找匹配的选项
                        const option = categorySelect.querySelector(`option[value="${categoryPath}"]`);
                        if (option || !categoryPath) {
                            categorySelect.value = categoryPath || '';
                            filterItems('prompts');
                        } else {
                            showToast('未找到对应的分类', 'error');
                            return;
                        }
                    }
                } else if (type === 'websites') {
                    categorySelect = document.getElementById('websiteCategory');
                    if (categorySelect) {
                        // 查找匹配的选项
                        const option = categorySelect.querySelector(`option[value="${categoryPath}"]`);
                        if (option || !categoryPath) {
                            categorySelect.value = categoryPath || '';
                            filterItems('websites');
                        } else {
                            showToast('未找到对应的分类', 'error');
                            return;
                        }
                    }
                }
                
                if (categorySelect) {
                    // 添加视觉反馈
                    categorySelect.classList.add('filter-active');
                    setTimeout(() => {
                        categorySelect.classList.remove('filter-active');
                    }, 1000);
                    
                    const message = categoryPath ? `已按分类 "${displayName}" 筛选` : '已显示所有分类';
                    showToast(message);
                }
            } catch (error) {
                console.error('分类筛选失败:', error);
                showToast('分类筛选失败', 'error');
            }
        }

        // 标签系统相关函数（已更新为分离功能）
        
        function updateTagsSuggestions() {
            const allTags = new Set();
            
            // 收集现有标签
            appData.prompts.forEach(item => {
                if (item.tags) {
                    item.tags.forEach(tag => allTags.add(tag));
                }
            });
            appData.websites.forEach(item => {
                if (item.tags) {
                    item.tags.forEach(tag => allTags.add(tag));
                }
            });
            appData.filters.forEach(item => {
                if (item.tags) {
                    item.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            // 更新建议
            const suggestionContainers = [
                'promptTagsSuggestions',
                'websiteTagsSuggestions', 
                'filterTagsSuggestions'
            ];
            
            suggestionContainers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container && allTags.size > 0) {
                    const sortedTags = Array.from(allTags).sort().slice(0, 10); // 最多显示10个
                    container.innerHTML = `
                        <div style="margin-top: 5px;">
                            <small style="color: #666;">常用标签：</small>
                            ${sortedTags.map(tag => `<span class="tag-suggestion" onclick="addTagToInput('${containerId}', '${escapeHtml(tag)}')">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    `;
                }
            });
        }
        
        function addTagToInput(suggestionContainerId, tag) {
            let inputId;
            if (suggestionContainerId.includes('prompt')) {
                inputId = 'promptTags';
            } else if (suggestionContainerId.includes('website')) {
                inputId = 'websiteTags';
            } else if (suggestionContainerId.includes('filter')) {
                inputId = 'filterTags';
            }
            
            const input = document.getElementById(inputId);
            if (input) {
                const currentTags = input.value.trim();
                const tagsArray = currentTags ? currentTags.split(',').map(t => t.trim()) : [];
                
                if (!tagsArray.includes(tag)) {
                    tagsArray.push(tag);
                    input.value = tagsArray.join(', ');
                }
            }
        }
        
        function updateFunctionTags(type) {
            
            // 确保数据存在
            if (!appData || !appData[type]) {
                const typeMap = {
                    'prompts': 'prompt',
                    'websites': 'website', 
                    'filters': 'filter'
                };
                const container = document.getElementById(`${typeMap[type] || type}TagsContainer`);
                if (container) {
                    container.innerHTML = '<p style="color: #999; text-align: center; margin: 10px 0;">暂无标签</p>';
                }
                return;
            }
            
            const functionTags = new Set();
            
            // 收集当前功能的标签
            appData[type].forEach(item => {
                if (item.tags && Array.isArray(item.tags)) {
                    item.tags.forEach(tag => {
                        if (tag && typeof tag === 'string' && tag.trim()) {
                            functionTags.add(tag.trim());
                        }
                    });
                }
            });
            
            // 渲染当前功能的标签
            // 修正ID映射，移除多余的's'
            const typeMap = {
                'prompts': 'prompt',
                'websites': 'website', 
                'filters': 'filter'
            };
            const containerId = `${typeMap[type] || type}TagsContainer`;
            const container = document.getElementById(containerId);
            
            if (container) {
                if (functionTags.size === 0) {
                    container.innerHTML = '<p style="color: #999; text-align: center; margin: 10px 0;">暂无标签</p>';
                } else {
                    const sortedTags = Array.from(functionTags).sort();
                    container.innerHTML = `
                        <div class="tags-container">
                            ${sortedTags.map(tag => `<span class="tag clickable" onclick="filterByTag('${type}', '${escapeHtml(tag)}')\" title="点击筛选">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    `;
                }
            }
        }
        
        function updateAllFunctionTags() {
            try {
                ['prompts', 'websites', 'filters'].forEach(type => {
                    updateFunctionTags(type);
                });
            } catch (error) {
                console.error('更新标签时出错:', error);
            }
        }
        
        // 立即清除加载状态的函数
        function clearLoadingStates() {
            const typeMap = {
                'prompts': 'prompt',
                'websites': 'website', 
                'filters': 'filter'
            };
            ['prompts', 'websites', 'filters'].forEach(type => {
                const containerId = `${typeMap[type]}TagsContainer`;
                const container = document.getElementById(containerId);
                if (container && container.innerHTML.includes('正在加载标签')) {
                    container.innerHTML = '<p style="color: #999; text-align: center; margin: 10px 0;">暂无标签</p>';
                }
            });
        }

        // ===== 多级分类管理函数 =====
        
        // 解析多级分类路径
        // 使用统一的parseCategory函数，删除重复的parseCategoryPath

        // 构建分类树结构
        function buildFilterCategoryTree() {
            const tree = {};
            const categories = new Set();
            
            // 收集所有分类
            appData.filters.forEach(filter => {
                if (filter.group) {
                    categories.add(filter.group);
                }
            });
            
            // 构建树结构
            categories.forEach(categoryPath => {
                const parts = parseCategory(categoryPath);
                let currentNode = tree;
                let currentPath = '';
                
                parts.forEach((part, index) => {
                    currentPath += (index > 0 ? '/' : '') + part;
                    
                    if (!currentNode[part]) {
                        currentNode[part] = {
                            name: part,
                            fullPath: currentPath,
                            children: {},
                            rules: [],
                            count: 0,
                            selected: false,
                            expanded: filterState.expandedCategories.has(currentPath)
                        };
                    }
                    currentNode = currentNode[part].children;
                });
            });
            
            // 统计每个节点的规则数量
            function countRules(node, path = '') {
                let totalCount = 0;
                
                // 统计当前层级的规则
                const directRules = appData.filters.filter(filter => filter.group === path);
                node.rules = directRules;
                totalCount += directRules.length;
                
                // 递归统计子级规则
                Object.keys(node.children).forEach(childKey => {
                    const childNode = node.children[childKey];
                    const childPath = path ? `${path}/${childKey}` : childKey;
                    totalCount += countRules(childNode, childPath);
                });
                
                node.count = totalCount;
                return totalCount;
            }
            
            // 为根级节点统计规则
            Object.keys(tree).forEach(key => {
                countRules(tree[key], key);
            });
            
            return tree;
        }

        // 获取分类的选择状态（全选/部分选/未选）
        function getCategorySelectionState(categoryPath) {
            const categoryRules = getFiltersByCategory(categoryPath);
            if (categoryRules.length === 0) return 'none';
            
            const selectedCount = categoryRules.filter(rule => 
                filterState.selectedRules.has(rule.id)
            ).length;
            
            if (selectedCount === 0) return 'none';
            if (selectedCount === categoryRules.length) return 'all';
            return 'partial';
        }

        // 获取指定分类下的所有规则（包括子分类）
        function getFiltersByCategory(categoryPath, includeChildren = true) {
            if (!categoryPath) return appData.filters;
            
            return appData.filters.filter(filter => {
                if (!filter.group) return false;
                if (filter.group === categoryPath) return true;
                if (includeChildren && filter.group.startsWith(categoryPath + '/')) return true;
                return false;
            });
        }

        // 切换分类选择状态
        function toggleCategorySelection(categoryPath) {
            const rules = getFiltersByCategory(categoryPath);
            const selectionState = getCategorySelectionState(categoryPath);
            
            if (selectionState === 'all') {
                // 全选状态 -> 取消全部选择
                rules.forEach(rule => filterState.selectedRules.delete(rule.id));
            } else {
                // 未选或部分选择状态 -> 全部选择
                rules.forEach(rule => filterState.selectedRules.add(rule.id));
            }
            
            updateFilterDisplay();
            updateActionButtons();
        }

        // 切换单个规则选择状态
        function toggleRuleSelection(ruleId) {
            if (filterState.selectedRules.has(ruleId)) {
                filterState.selectedRules.delete(ruleId);
            } else {
                filterState.selectedRules.add(ruleId);
            }
            
            updateFilterDisplay();
            updateActionButtons();
            renderCurrentSelection(); // 更新当前选择显示
        }

        // 展开/折叠分类
        function toggleCategoryExpansion(categoryPath) {
            if (filterState.expandedCategories.has(categoryPath)) {
                filterState.expandedCategories.delete(categoryPath);
            } else {
                filterState.expandedCategories.add(categoryPath);
            }
            
            renderFilterCategoryTree();
        }

        // 选择分类进行筛选
        function selectCategory(categoryPath) {
            filterState.selectedCategory = categoryPath;
            renderFilterCategoryTree();
            renderFilterRulesList();
        }

        // 搜索规则
        function searchFilters() {
            const searchInput = document.getElementById('filterSearch');
            filterState.searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                clearBtn.style.display = filterState.searchTerm ? 'block' : 'none';
            }
            
            renderFilterRulesList();
        }

        // 清除搜索
        function clearFilterSearch() {
            const searchInput = document.getElementById('filterSearch');
            if (searchInput) {
                searchInput.value = '';
            }
            filterState.searchTerm = '';
            
            const clearBtn = document.getElementById('clearSearchBtn');
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
            
            renderFilterRulesList();
        }

        // ===== 面板折叠展开管理 =====
        
        // 切换面板折叠状态
        function togglePanel(panelName) {
            const panelStates = filterState.panelStates;
            panelStates[panelName] = !panelStates[panelName];
            
            const panel = document.getElementById(`${panelName}Panel`);
            const content = document.getElementById(`${panelName}Content`);
            const toggle = document.getElementById(`${panelName}Toggle`);
            
            if (panelStates[panelName]) {
                // 展开
                if (panel) panel.classList.remove('collapsed');
                if (content) content.classList.remove('collapsed');
                if (toggle) {
                    toggle.textContent = '▼';
                    toggle.classList.remove('collapsed');
                }
            } else {
                // 折叠
                if (panel) panel.classList.add('collapsed');
                if (content) content.classList.add('collapsed');
                if (toggle) {
                    toggle.textContent = '▶';
                    toggle.classList.add('collapsed');
                }
            }
            
            // 保存状态
            saveFilterPanelStates();
            
            // 智能测试面板定位：检查是否所有主要面板都已折叠
            updateTestPanelPosition();
        }
        
        // 智能测试面板定位函数
        function updateTestPanelPosition() {
            const panelStates = filterState.panelStates;
            
            // 检查三个主要面板的状态：categories、rules、presets
            const categoriesCollapsed = !panelStates.categories;
            const rulesCollapsed = !panelStates.rules;
            const presetsCollapsed = !panelStates.presets;
            
            // 只有当所有三个面板都折叠时，测试面板才向上移动
            const allPanelsCollapsed = categoriesCollapsed && rulesCollapsed && presetsCollapsed;
            
            const testPanel = document.getElementById('testPanel');
            const filterMainLayout = document.querySelector('.filter-main-layout');
            
            if (testPanel && filterMainLayout) {
                // 添加自动定位类以启用平滑动画
                testPanel.classList.add('auto-positioned');
                
                if (allPanelsCollapsed) {
                    // 所有面板都折叠，保持正常间距避免重叠
                    testPanel.style.marginTop = '20px'; // 保持正常间距
                    filterMainLayout.style.height = 'auto'; // 主布局自动高度
                    filterMainLayout.style.minHeight = '45px'; // 最小高度适应折叠状态
                    
                    // 调试信息
                    console.log('所有面板已折叠，保持正常间距');
                } else {
                    // 至少有一个面板展开，测试面板保持正常位置
                    testPanel.style.marginTop = '20px'; // 保持正常间距
                    filterMainLayout.style.height = 'auto'; // 使用自动高度
                    filterMainLayout.style.minHeight = '45px'; // 最小高度
                    filterMainLayout.style.maxHeight = '65vh'; // 最大高度限制
                    
                    // 调试信息
                    console.log('至少一个面板展开，保持正常布局');
                }
            }
        }

        // 保存面板状态
        function saveFilterPanelStates() {
            localStorage.setItem('filterPanelStates', JSON.stringify(filterState.panelStates));
        }
        
        // 加载面板状态
        function loadFilterPanelStates() {
            const saved = localStorage.getItem('filterPanelStates');
            if (saved) {
                filterState.panelStates = { ...filterState.panelStates, ...JSON.parse(saved) };
            }
        }
        
        // 初始化面板状态
        function initFilterPanelStates() {
            loadFilterPanelStates();
            
            // 应用保存的状态
            Object.keys(filterState.panelStates).forEach(panelName => {
                const isExpanded = filterState.panelStates[panelName];
                const panel = document.getElementById(`${panelName}Panel`);
                const content = document.getElementById(`${panelName}Content`);
                const toggle = document.getElementById(`${panelName}Toggle`);
                
                if (isExpanded) {
                    if (panel) panel.classList.remove('collapsed');
                    if (content) content.classList.remove('collapsed');
                    if (toggle) {
                        toggle.textContent = '▼';
                        toggle.classList.remove('collapsed');
                    }
                } else {
                    if (panel) panel.classList.add('collapsed');
                    if (content) content.classList.add('collapsed');
                    if (toggle) {
                        toggle.textContent = '▶';
                        toggle.classList.add('collapsed');
                    }
                }
            });
            
            // 初始化时也要设置测试面板位置
            updateTestPanelPosition();
        }

        // ===== 新界面控制函数 =====
        
        // 切换测试面板显示/隐藏
        function toggleTestPanel() {
            const testPanel = document.getElementById('testPanel');
            const toggleBtn = testPanel?.querySelector('.btn-toggle');
            
            if (testPanel) {
                testPanel.classList.toggle('collapsed');
                if (toggleBtn) {
                    toggleBtn.textContent = testPanel.classList.contains('collapsed') ? '▼' : '▲';
                }
                
                // 保存状态
                const isCollapsed = testPanel.classList.contains('collapsed');
                if (appData.settings.testPanelCollapsed !== undefined) {
                    appData.settings.testPanelCollapsed = isCollapsed;
                    saveData();
                }
            }
        }

        // 展开所有分类
        function expandAllCategories() {
            function addAllPaths(tree, basePath = '') {
                Object.keys(tree).forEach(key => {
                    const fullPath = basePath ? `${basePath}/${key}` : key;
                    filterState.expandedCategories.add(fullPath);
                    
                    if (Object.keys(tree[key].children).length > 0) {
                        addAllPaths(tree[key].children, fullPath);
                    }
                });
            }
            
            addAllPaths(filterState.categoryTree);
            renderFilterCategoryTree();
        }

        // 折叠所有分类
        function collapseAllCategories() {
            filterState.expandedCategories.clear();
            renderFilterCategoryTree();
        }

        // 启用选中的过滤规则
        function enableSelectedFilters() {
            if (filterState.selectedRules.size === 0) {
                showToast('请先选择要启用的规则', 'error');
                return;
            }
            
            appData.filters.forEach(filter => {
                if (filterState.selectedRules.has(filter.id)) {
                    filter.active = true;
                }
            });
            
            saveData();
            renderFilters();
            
            const selectedCount = filterState.selectedRules.size;
            showToast(`已启用 ${selectedCount} 个过滤规则`);
        }

        // 停用选中的过滤规则
        function disableSelectedFilters() {
            if (filterState.selectedRules.size === 0) {
                showToast('请先选择要停用的规则', 'error');
                return;
            }
            
            appData.filters.forEach(filter => {
                if (filterState.selectedRules.has(filter.id)) {
                    filter.active = false;
                }
            });
            
            saveData();
            renderFilters();
            
            const selectedCount = filterState.selectedRules.size;
            showToast(`已停用 ${selectedCount} 个过滤规则`);
        }

        // 测试选中的规则
        function testSelectedFilters() {
            if (filterState.selectedRules.size === 0) {
                showToast('请先选择要测试的规则', 'error');
                return;
            }
            
            const testInput = document.getElementById('testInput');
            const testResult = document.getElementById('testResult');
            
            if (!testInput || !testResult) return;
            
            const inputText = testInput.value;
            if (!inputText.trim()) {
                showToast('请输入要测试的文本', 'error');
                return;
            }
            
            // 获取选中的规则（无论是否启用）
            const selectedFilters = appData.filters.filter(f => filterState.selectedRules.has(f.id));
            
            let processedText = inputText;
            let appliedCount = 0;
            
            selectedFilters.forEach(filter => {
                try {
                    const regex = new RegExp(filter.regex, 'gi');
                    const beforeLength = processedText.length;
                    
                    if (filter.replace) {
                        processedText = processedText.replace(regex, filter.replace);
                    } else {
                        processedText = processedText.replace(regex, '');
                    }
                    
                    if (processedText.length !== beforeLength) {
                        appliedCount++;
                        filter.usageCount = (filter.usageCount || 0) + 1;
                    }
                } catch (error) {
                    console.warn('Filter regex error:', filter.regex, error);
                }
            });
            
            testResult.value = processedText;
            
            // 保存使用统计
            if (appliedCount > 0) {
                saveData();
                renderFilters(); // 刷新显示以更新使用计数
            }
            
            showToast(`已测试 ${selectedFilters.length} 个规则，其中 ${appliedCount} 个生效`);
        }

        // 复制原文
        function copyOriginalText() {
            const testInput = document.getElementById('testInput');
            if (testInput && testInput.value) {
                navigator.clipboard.writeText(testInput.value).then(() => {
                    showToast('原文已复制到剪贴板');
                });
            }
        }

        // 复制编辑后的结果
        function copyEditedResult() {
            const testResult = document.getElementById('testResult');
            if (testResult && testResult.value) {
                navigator.clipboard.writeText(testResult.value).then(() => {
                    showToast('结果已复制到剪贴板');
                });
            }
        }

        // 清空测试输入
        function clearTestInput() {
            const testInput = document.getElementById('testInput');
            if (testInput) {
                testInput.value = '';
                testFilters();
            }
        }

        // 清空测试结果
        function clearTestResult() {
            const testResult = document.getElementById('testResult');
            if (testResult) {
                testResult.value = '';
            }
        }

        // ===== 增强的预设管理系统 =====
        
        // 渲染当前选择的规则
        function renderCurrentSelection() {
            const container = document.getElementById('currentSelectionContent');
            const countElement = document.getElementById('currentSelectionCount');
            
            if (!container || !countElement) return;
            
            const selectedCount = filterState.selectedRules.size;
            countElement.textContent = selectedCount;
            
            if (selectedCount === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px; font-size: 13px;">
                        暂无选择的规则<br>
                        <small>从右侧规则列表中选择规则</small>
                    </div>
                `;
                return;
            }
            
            const selectedRules = appData.filters.filter(rule => filterState.selectedRules.has(rule.id));
            
            container.innerHTML = selectedRules.map(rule => {
                const previewText = rule.replace ? 
                    `/${rule.regex}/ → "${rule.replace}"` : 
                    `/${rule.regex}/ → [删除]`;
                    
                return `
                    <div class="selected-rule-item">
                        <div class="selected-rule-checkbox">
                            <input type="checkbox" 
                                   checked 
                                   onchange="toggleRuleInSelection('${rule.id}')"
                                   title="取消选择">
                        </div>
                        <div class="selected-rule-info">
                            <div class="selected-rule-name">${escapeHtml(rule.name)}</div>
                            <div class="selected-rule-regex">${escapeHtml(previewText)}</div>
                        </div>
                        <button class="selected-rule-remove" 
                                onclick="removeRuleFromSelection('${rule.id}')"
                                title="移除">×</button>
                    </div>
                `;
            }).join('');
        }
        
        // 从选择中移除规则
        function removeRuleFromSelection(ruleId) {
            filterState.selectedRules.delete(ruleId);
            renderCurrentSelection();
            updateFilterDisplay();
            updateActionButtons();
        }
        
        // 切换规则在选择中的状态
        function toggleRuleInSelection(ruleId) {
            if (filterState.selectedRules.has(ruleId)) {
                filterState.selectedRules.delete(ruleId);
            } else {
                filterState.selectedRules.add(ruleId);
            }
            renderCurrentSelection();
            updateFilterDisplay();
            updateActionButtons();
        }
        
        // 启用所有选中的规则
        function enableAllSelected() {
            if (filterState.selectedRules.size === 0) {
                showToast('请先选择规则', 'error');
                return;
            }
            enableSelectedFilters();
        }
        
        // 停用所有选中的规则
        function disableAllSelected() {
            if (filterState.selectedRules.size === 0) {
                showToast('请先选择规则', 'error');
                return;
            }
            disableSelectedFilters();
        }
        
        // 清空当前选择
        function clearCurrentSelection() {
            filterState.selectedRules.clear();
            renderCurrentSelection();
            updateFilterDisplay();
            updateActionButtons();
            showToast('已清空规则选择');
        }
        
        // 保存为新预设
        function saveAsNewPreset() {
            if (filterState.selectedRules.size === 0) {
                showToast('请先选择要保存的规则', 'error');
                return;
            }
            
            const presetName = prompt('请输入预设组名称：');
            if (!presetName || !presetName.trim()) return;
            
            const preset = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                name: presetName.trim(),
                ruleIds: Array.from(filterState.selectedRules),
                createdAt: new Date().toISOString(),
                description: `包含 ${filterState.selectedRules.size} 个规则`,
                enabled: false
            };
            
            filterState.presets.push(preset);
            savePresetsToStorage();
            renderPresetGroups();
            showToast(`预设组"${preset.name}"已保存`);
        }
        
        // 渲染预设组
        function renderPresetGroups() {
            const container = document.getElementById('presetGroupsContent');
            if (!container) return;
            
            if (filterState.presets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px; font-size: 13px;">
                        暂无预设组<br>
                        <small>选择规则后点击💾保存</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filterState.presets.map(preset => {
                const validRuleCount = preset.ruleIds.filter(ruleId => 
                    appData.filters.some(f => f.id === ruleId)
                ).length;
                
                const activeRuleCount = preset.ruleIds.filter(ruleId => {
                    const rule = appData.filters.find(f => f.id === ruleId);
                    return rule && rule.active;
                }).length;
                
                const isSelected = filterState.selectedPresets.has(preset.id);
                
                return `
                    <div class="preset-group-item ${isSelected ? 'selected' : ''}">
                        <div class="preset-group-header">
                            <div class="preset-group-name">${escapeHtml(preset.name)}</div>
                            <div class="preset-group-actions">
                                <button class="btn-icon" onclick="editPresetName('${preset.id}')" title="重命名">✏️</button>
                                <button class="btn-icon" onclick="exportSinglePreset('${preset.id}')" title="导出">📤</button>
                                <button class="btn-icon" onclick="deletePresetGroup('${preset.id}')" title="删除">🗑️</button>
                            </div>
                        </div>
                        
                        <div class="preset-group-stats">
                            有效规则：${validRuleCount} / ${preset.ruleIds.length} | 
                            激活规则：${activeRuleCount} | 
                            创建时间：${new Date(preset.createdAt).toLocaleDateString()}
                        </div>
                        
                        <div class="preset-group-controls">
                            <div class="preset-group-checkbox">
                                <input type="checkbox" 
                                       ${isSelected ? 'checked' : ''} 
                                       onchange="togglePresetSelection('${preset.id}')" 
                                       title="选择预设组">
                                <label>选择此组</label>
                            </div>
                            
                            <div class="preset-group-buttons">
                                <button class="btn btn-xs btn-success" 
                                        onclick="enablePresetGroup('${preset.id}')" 
                                        title="启用此组所有规则">🔓 启用</button>
                                <button class="btn btn-xs btn-secondary" 
                                        onclick="disablePresetGroup('${preset.id}')" 
                                        title="停用此组所有规则">🔒 停用</button>
                                <button class="btn btn-xs btn-primary" 
                                        onclick="loadPresetToSelection('${preset.id}')" 
                                        title="加载到当前选择">📥 加载</button>
                                <button class="btn btn-xs btn-warning" 
                                        onclick="editPresetRules('${preset.id}')" 
                                        title="编辑规则">✏️ 编辑</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 切换预设选择状态
        function togglePresetSelection(presetId) {
            if (filterState.selectedPresets.has(presetId)) {
                filterState.selectedPresets.delete(presetId);
            } else {
                filterState.selectedPresets.add(presetId);
            }
            renderPresetGroups();
        }
        
        // 启用预设组
        function enablePresetGroup(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset) return;
            
            let enabledCount = 0;
            preset.ruleIds.forEach(ruleId => {
                const rule = appData.filters.find(f => f.id === ruleId);
                if (rule) {
                    rule.active = true;
                    enabledCount++;
                }
            });
            
            saveData();
            renderFilters();
            renderPresetGroups();
            showToast(`预设组"${preset.name}"已启用 ${enabledCount} 个规则`);
        }
        
        // 停用预设组
        function disablePresetGroup(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset) return;
            
            let disabledCount = 0;
            preset.ruleIds.forEach(ruleId => {
                const rule = appData.filters.find(f => f.id === ruleId);
                if (rule) {
                    rule.active = false;
                    disabledCount++;
                }
            });
            
            saveData();
            renderFilters();
            renderPresetGroups();
            showToast(`预设组"${preset.name}"已停用 ${disabledCount} 个规则`);
        }
        
        // 加载预设到当前选择
        function loadPresetToSelection(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset) return;
            
            // 清空当前选择
            filterState.selectedRules.clear();
            
            // 加载预设中的有效规则
            preset.ruleIds.forEach(ruleId => {
                if (appData.filters.some(f => f.id === ruleId)) {
                    filterState.selectedRules.add(ruleId);
                }
            });
            
            renderCurrentSelection();
            updateFilterDisplay();
            updateActionButtons();
            showToast(`已加载预设组"${preset.name}"`);
        }
        
        // 编辑预设规则
        function editPresetRules(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset) return;
            
            // 加载预设到当前选择，然后用户可以修改选择后保存
            loadPresetToSelection(presetId);
            showToast(`预设组"${preset.name}"已加载到当前选择，修改后可保存为新预设或更新当前预设`);
        }
        
        // 编辑预设名称
        function editPresetName(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset) return;
            
            const newName = prompt('请输入新的预设组名称：', preset.name);
            if (!newName || newName.trim() === preset.name) return;
            
            preset.name = newName.trim();
            savePresetsToStorage();
            renderPresetGroups();
            showToast('预设组已重命名');
        }
        
        // 删除预设组
        function deletePresetGroup(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset || !confirm(`确定要删除预设组"${preset.name}"吗？`)) return;
            
            const index = filterState.presets.findIndex(p => p.id === presetId);
            filterState.presets.splice(index, 1);
            filterState.selectedPresets.delete(presetId);
            
            savePresetsToStorage();
            renderPresetGroups();
            showToast(`预设组"${preset.name}"已删除`);
        }
        
        // 启用选中的预设组
        function enableSelectedPresets() {
            if (filterState.selectedPresets.size === 0) {
                showToast('请先选择预设组', 'error');
                return;
            }
            
            let totalEnabled = 0;
            filterState.selectedPresets.forEach(presetId => {
                const preset = filterState.presets.find(p => p.id === presetId);
                if (preset) {
                    preset.ruleIds.forEach(ruleId => {
                        const rule = appData.filters.find(f => f.id === ruleId);
                        if (rule) {
                            rule.active = true;
                            totalEnabled++;
                        }
                    });
                }
            });
            
            saveData();
            renderFilters();
            renderPresetGroups();
            showToast(`已启用 ${filterState.selectedPresets.size} 个预设组中的 ${totalEnabled} 个规则`);
        }
        
        // 停用选中的预设组
        function disableSelectedPresets() {
            if (filterState.selectedPresets.size === 0) {
                showToast('请先选择预设组', 'error');
                return;
            }
            
            let totalDisabled = 0;
            filterState.selectedPresets.forEach(presetId => {
                const preset = filterState.presets.find(p => p.id === presetId);
                if (preset) {
                    preset.ruleIds.forEach(ruleId => {
                        const rule = appData.filters.find(f => f.id === ruleId);
                        if (rule) {
                            rule.active = false;
                            totalDisabled++;
                        }
                    });
                }
            });
            
            saveData();
            renderFilters();
            renderPresetGroups();
            showToast(`已停用 ${filterState.selectedPresets.size} 个预设组中的 ${totalDisabled} 个规则`);
        }
        
        // 测试选中的预设组
        function testSelectedPresets() {
            if (filterState.selectedPresets.size === 0) {
                showToast('请先选择预设组', 'error');
                return;
            }
            
            // 收集所有预设组中的规则
            const allRuleIds = new Set();
            filterState.selectedPresets.forEach(presetId => {
                const preset = filterState.presets.find(p => p.id === presetId);
                if (preset) {
                    preset.ruleIds.forEach(ruleId => allRuleIds.add(ruleId));
                }
            });
            
            // 暂时设置选择的规则为预设组中的规则
            const originalSelection = new Set(filterState.selectedRules);
            filterState.selectedRules.clear();
            allRuleIds.forEach(ruleId => filterState.selectedRules.add(ruleId));
            
            // 执行测试
            testSelectedFilters();
            
            // 恢复原始选择
            filterState.selectedRules = originalSelection;
            
            showToast(`已测试 ${filterState.selectedPresets.size} 个预设组中的规则`);
        }
        
        // 显示预设导入对话框
        function showPresetImportDialog() {
            const dialog = document.createElement('div');
            dialog.className = 'export-dialog-overlay';
            dialog.innerHTML = `
                <div class="export-dialog">
                    <h3>导入过滤规则预设组</h3>
                    <p>选择导入方式，支持多种格式：</p>
                    
                    <div class="export-options">
                        <button class="export-option" onclick="importPresetsFromFile()">
                            <div class="option-icon">📁</div>
                            <div class="option-content">
                                <strong>从文件导入</strong>
                                <small>支持JSON、CSV、TXT格式文件</small>
                            </div>
                        </button>
                        
                        <button class="export-option" onclick="showBatchImport('presets')">
                            <div class="option-icon">🚀</div>
                            <div class="option-content">
                                <strong>智能批量导入</strong>
                                <small>使用智能导入工具，支持自然语言</small>
                            </div>
                        </button>
                        
                        <button class="export-option" onclick="importPresetsFromText()">
                            <div class="option-icon">📝</div>
                            <div class="option-content">
                                <strong>从文本导入</strong>
                                <small>粘贴文本内容直接导入</small>
                            </div>
                        </button>
                    </div>
                    
                    <div class="export-dialog-buttons">
                        <button class="btn btn-secondary" onclick="closePresetImportDialog()">取消</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }
        
        function closePresetImportDialog() {
            const dialog = document.querySelector('.export-dialog-overlay');
            if (dialog) {
                dialog.remove();
            }
        }
        
        // 从文件导入预设
        function importPresetsFromFile() {
            closePresetImportDialog();
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv,.txt';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let importedPresets = [];
                        const fileName = file.name.toLowerCase();
                        const content = e.target.result;
                        
                        if (fileName.endsWith('.json')) {
                            importedPresets = JSON.parse(content);
                        } else if (fileName.endsWith('.csv')) {
                            importedPresets = parsePresetsFromCSV(content);
                        } else if (fileName.endsWith('.txt')) {
                            importedPresets = parsePresetsFromText(content);
                        }
                        
                        if (!Array.isArray(importedPresets)) {
                            throw new Error('Invalid format');
                        }
                        
                        // 处理导入的预设
                        const processedPresets = importedPresets.filter(preset => preset.name && preset.ruleIds)
                            .map(preset => ({
                                ...preset,
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                createdAt: preset.createdAt || new Date().toISOString(),
                                enabled: preset.enabled !== undefined ? preset.enabled : false
                            }));
                        
                        // 合并到现有预设
                        filterState.presets.push(...processedPresets);
                        savePresetsToStorage();
                        renderPresetGroups();
                        
                        showToast(`成功导入 ${processedPresets.length} 个预设组`, 'success');
                    } catch (error) {
                        console.error('Import error:', error);
                        showToast('导入失败，请检查文件格式', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // 从文本导入预设
        function importPresetsFromText() {
            closePresetImportDialog();
            
            const textModal = document.createElement('div');
            textModal.className = 'export-dialog-overlay';
            textModal.innerHTML = `
                <div class="export-dialog" style="max-width: 600px;">
                    <h3>从文本导入预设组</h3>
                    <p>请粘贴预设组数据（支持JSON或纯文本格式）：</p>
                    
                    <textarea id="presetTextInput" style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;" placeholder="请粘贴预设组数据..."></textarea>
                    
                    <div class="export-dialog-buttons">
                        <button class="btn btn-primary" onclick="doImportFromText()">导入</button>
                        <button class="btn btn-secondary" onclick="closeTextImportModal()">取消</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(textModal);
        }
        
        function closeTextImportModal() {
            const modal = document.querySelector('.export-dialog-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        function doImportFromText() {
            const textInput = document.getElementById('presetTextInput');
            const content = textInput.value.trim();
            
            if (!content) {
                showToast('请输入预设组数据', 'error');
                return;
            }
            
            try {
                let importedPresets = [];
                
                // 尝试解析JSON
                try {
                    importedPresets = JSON.parse(content);
                } catch {
                    // 如果JSON解析失败，尝试文本解析
                    importedPresets = parsePresetsFromText(content);
                }
                
                if (!Array.isArray(importedPresets)) {
                    throw new Error('数据格式错误');
                }
                
                // 处理导入的预设
                const processedPresets = importedPresets.filter(preset => preset.name && preset.ruleIds)
                    .map(preset => ({
                        ...preset,
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        createdAt: preset.createdAt || new Date().toISOString(),
                        enabled: preset.enabled !== undefined ? preset.enabled : false
                    }));
                
                // 合并到现有预设
                filterState.presets.push(...processedPresets);
                savePresetsToStorage();
                renderPresetGroups();
                
                closeTextImportModal();
                showToast(`成功导入 ${processedPresets.length} 个预设组`, 'success');
            } catch (error) {
                console.error('Import error:', error);
                showToast('导入失败，请检查数据格式', 'error');
            }
        }
        
        // 解析CSV格式的预设组数据
        function parsePresetsFromCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            // 解析表头
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
            const presets = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const preset = {};
                
                // 映射CSV列到预设对象
                headers.forEach((header, index) => {
                    const value = values[index] || '';
                    switch (header) {
                        case '预设名称':
                        case 'name':
                            preset.name = value;
                            break;
                        case '描述':
                        case 'description':
                            preset.description = value;
                            break;
                        case '规则id列表':
                        case 'ruleids':
                        case 'rule_ids':
                            preset.ruleIds = value ? value.split(';').map(id => id.trim()).filter(id => id) : [];
                            break;
                        case '启用状态':
                        case 'enabled':
                            preset.enabled = value === '是' || value === 'true' || value === '1';
                            break;
                        case '创建时间':
                        case 'createdat':
                            preset.createdAt = value;
                            break;
                    }
                });
                
                if (preset.name && preset.ruleIds) {
                    presets.push(preset);
                }
            }
            
            return presets;
        }
        
        // 解析纯文本格式的预设组数据
        function parsePresetsFromText(textContent) {
            const lines = textContent.split('\n');
            const presets = [];
            let currentPreset = null;
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // 检测预设组开始（数字开头或特定格式）
                const presetMatch = trimmed.match(/^(\d+\.\s*)?(.+?)(?:\s*[:：]\s*(.*))?$/);
                if (presetMatch) {
                    // 如果看起来像是预设名称（不包含规则ID格式）
                    if (!trimmed.includes('filter_') && !trimmed.includes('rule_')) {
                        // 保存之前的预设
                        if (currentPreset && currentPreset.name) {
                            presets.push(currentPreset);
                        }
                        
                        // 开始新预设
                        currentPreset = {
                            name: presetMatch[2].trim(),
                            description: presetMatch[3] || '',
                            ruleIds: [],
                            enabled: false
                        };
                        continue;
                    }
                }
                
                // 如果当前有预设，尝试解析规则ID
                if (currentPreset) {
                    // 查找规则ID（filter_xxx 或 rule_xxx 格式）
                    const ruleIdMatches = trimmed.match(/(?:filter_|rule_)[\w\d]+/g);
                    if (ruleIdMatches) {
                        currentPreset.ruleIds.push(...ruleIdMatches);
                    }
                    
                    // 检测描述信息
                    if (trimmed.includes('描述') || trimmed.includes('说明')) {
                        const descMatch = trimmed.match(/(?:描述|说明)[：:]?\s*(.+)/);
                        if (descMatch) {
                            currentPreset.description = descMatch[1];
                        }
                    }
                    
                    // 检测启用状态
                    if (trimmed.includes('启用') || trimmed.includes('状态')) {
                        currentPreset.enabled = trimmed.includes('✓') || trimmed.includes('启用');
                    }
                }
            }
            
            // 添加最后一个预设
            if (currentPreset && currentPreset.name) {
                presets.push(currentPreset);
            }
            
            return presets;
        }
        
        // 导入预设（旧版保持兼容）
        function importPresets() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedPresets = JSON.parse(event.target.result);
                        if (!Array.isArray(importedPresets)) {
                            throw new Error('Invalid format');
                        }
                        
                        // 合并预设
                        importedPresets.forEach(preset => {
                            if (preset.name && preset.ruleIds) {
                                preset.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                                filterState.presets.push(preset);
                            }
                        });
                        
                        savePresetsToStorage();
                        renderPresetGroups();
                        showToast(`已导入 ${importedPresets.length} 个预设组`);
                    } catch (error) {
                        showToast('导入失败，文件格式错误', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // 显示预设导出对话框
        function showPresetExportDialog() {
            if (filterState.presets.length === 0) {
                showToast('没有预设组可导出', 'error');
                return;
            }
            
            showExportDialog('presets');
        }
        
        // 导出预设（旧版保持兼容）
        function exportPresets() {
            showPresetExportDialog();
        }
        
        // 导出单个预设
        function exportSinglePreset(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset) return;
            
            const dataStr = JSON.stringify([preset], null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `preset-${preset.name.replace(/[^\w\-_]/g, '_')}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast(`预设组"${preset.name}"已导出`);
        }
        
        // 保存预设到localStorage
        function savePresetsToStorage() {
            localStorage.setItem('filterPresets', JSON.stringify(filterState.presets));
        }
        
        // ===== 规则预设管理（旧版兼容） =====
        
        // 保存当前选择为预设
        function saveCurrentPreset() {
            if (filterState.selectedRules.size === 0) {
                showToast('请先选择要保存的规则', 'error');
                return;
            }
            
            const presetName = prompt('请输入预设名称：');
            if (!presetName || !presetName.trim()) return;
            
            const preset = {
                id: Date.now().toString(),
                name: presetName.trim(),
                ruleIds: Array.from(filterState.selectedRules),
                createdAt: new Date().toISOString(),
                description: `包含 ${filterState.selectedRules.size} 个规则`
            };
            
            filterState.presets.push(preset);
            savePresets();
            renderFilterPresets();
            showToast(`预设"${preset.name}"已保存`);
        }
        
        // 加载预设
        function loadPreset(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset) return;
            
            // 清空当前选择
            filterState.selectedRules.clear();
            
            // 加载预设中的规则
            preset.ruleIds.forEach(ruleId => {
                if (appData.filters.some(f => f.id === ruleId)) {
                    filterState.selectedRules.add(ruleId);
                }
            });
            
            updateFilterDisplay();
            updateActionButtons();
            showToast(`已加载预设"${preset.name}"`);
        }
        
        // 删除预设
        function deletePreset(presetId) {
            if (!confirm('确定要删除这个预设吗？')) return;
            
            const index = filterState.presets.findIndex(p => p.id === presetId);
            if (index >= 0) {
                const preset = filterState.presets[index];
                filterState.presets.splice(index, 1);
                savePresets();
                renderFilterPresets();
                showToast(`预设"${preset.name}"已删除`);
            }
        }
        
        // 重命名预设
        function renamePreset(presetId) {
            const preset = filterState.presets.find(p => p.id === presetId);
            if (!preset) return;
            
            const newName = prompt('请输入新的预设名称：', preset.name);
            if (!newName || newName.trim() === preset.name) return;
            
            preset.name = newName.trim();
            savePresets();
            renderFilterPresets();
            showToast('预设已重命名');
        }
        
        // 保存预设到localStorage
        function savePresets() {
            localStorage.setItem('filterPresets', JSON.stringify(filterState.presets));
        }
        
        // 渲染预设列表
        function renderFilterPresets() {
            const container = document.getElementById('filterPresetsList');
            if (!container) return;
            
            if (filterState.presets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 15px; font-size: 13px;">
                        暂无预设<br>
                        <small>选择规则后点击💾保存</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filterState.presets.map(preset => `
                <div class="preset-item">
                    <div style="flex: 1; cursor: pointer;" onclick="loadPreset('${preset.id}')" title="${preset.description}">
                        <div style="font-weight: 500;">${escapeHtml(preset.name)}</div>
                        <div style="font-size: 11px; color: #666;">${preset.ruleIds.length} 个规则</div>
                    </div>
                    <div style="display: flex; gap: 2px;">
                        <button class="btn-icon" onclick="renamePreset('${preset.id}')" title="重命名">✏️</button>
                        <button class="btn-icon" onclick="deletePreset('${preset.id}')" title="删除">🗑️</button>
                    </div>
                </div>
            `).join('');
        }
        
        // 初始化预设显示
        function initFilterPresets() {
            renderFilterPresets();
        }

        // 初始化测试面板状态
        function initTestPanelState() {
            const testPanel = document.getElementById('testPanel');
            if (testPanel) {
                // 检查是否有保存的状态，默认为折叠
                const isCollapsed = appData.settings.testPanelCollapsed !== false;
                
                if (isCollapsed) {
                    testPanel.classList.add('collapsed');
                } else {
                    testPanel.classList.remove('collapsed');
                }
                
                const toggleBtn = testPanel.querySelector('.btn-toggle');
                if (toggleBtn) {
                    toggleBtn.textContent = isCollapsed ? '▼' : '▲';
                }
            }
        }
        
        // 安全的标签更新，确保在DOM准备就绪后执行
        function safeUpdateTags() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateAllFunctionTags);
            } else {
                setTimeout(updateAllFunctionTags, 10);
            }
        }
        
        function toggleFunctionTags(type) {
            // 修正ID映射
            const typeMap = {
                'prompts': 'prompt',
                'websites': 'website', 
                'filters': 'filter'
            };
            const baseType = typeMap[type] || type;
            const content = document.getElementById(`${baseType}TagsContent`);
            const toggle = document.getElementById(`${baseType}TagsToggle`);
            
            if (content && toggle) {
                const isCollapsed = content.classList.contains('collapsed');
                if (isCollapsed) {
                    // 展开
                    content.classList.remove('collapsed');
                    toggle.textContent = '▼';
                } else {
                    // 折叠
                    content.classList.add('collapsed');
                    toggle.textContent = '▶';
                }
                
                // 保存折叠状态（true表示折叠）
                if (!appData.settings.collapsedTagsPanels) {
                    appData.settings.collapsedTagsPanels = {};
                }
                appData.settings.collapsedTagsPanels[type] = !isCollapsed;
                saveData();
            }
        }
        
        function initTagsPanelsState() {
            const types = ['prompts', 'websites', 'filters'];
            const typeMap = {
                'prompts': 'prompt',
                'websites': 'website', 
                'filters': 'filter'
            };
            types.forEach(type => {
                const baseType = typeMap[type] || type;
                const content = document.getElementById(`${baseType}TagsContent`);
                const toggle = document.getElementById(`${baseType}TagsToggle`);
                
                if (content && toggle) {
                    // 默认展开状态，只有设置为true时才折叠
                    const isCollapsed = appData.settings.collapsedTagsPanels?.[type] === true;
                    if (isCollapsed) {
                        content.classList.add('collapsed');
                        toggle.textContent = '▶';
                    } else {
                        content.classList.remove('collapsed');
                        toggle.textContent = '▼';
                    }
                }
            });
        }
        
        function filterByTag(type, tag) {
            // 根据类型进行标签筛选
            if (type === 'prompts') {
                const searchInput = document.getElementById('promptSearch');
                if (searchInput) {
                    searchInput.value = tag;
                    filterItems('prompts');
                }
            } else if (type === 'websites') {
                const searchInput = document.getElementById('websiteSearch');
                if (searchInput) {
                    searchInput.value = tag;
                    filterItems('websites');
                }
            } else if (type === 'filters') {
                // 对于过滤器，可以在此添加标签筛选逻辑
                showToast(`正在按标签 "${tag}" 筛选过滤器`);
            }
            
            showToast(`已按标签 "${tag}" 筛选`);
        }

        // 批量操作功能
        function toggleBatchMode(type) {
            batchMode[type] = !batchMode[type];
            const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);
            const button = document.getElementById(`batchMode${capitalizedType}`);
            const actions = document.getElementById(`batchActions${capitalizedType}`);
            const container = document.getElementById(`${type}Container`);
            
            if (!button || !actions || !container) {
                console.error(`Batch mode elements not found for type: ${type}`);
                return;
            }
            
            if (batchMode[type]) {
                button.textContent = '❌ 退出批量';
                button.classList.remove('btn-primary');
                button.classList.add('btn-danger');
                actions.classList.add('active');
                container.classList.add('batch-mode');
            } else {
                button.textContent = '📋 批量操作';
                button.classList.remove('btn-danger');
                button.classList.add('btn-primary');
                actions.classList.remove('active');
                container.classList.remove('batch-mode');
                selectedItems[type].clear();
                updateSelectedCount(type);
            }
            
            // 重新渲染以显示/隐藏复选框
            if (type === 'prompts') renderPrompts();
            else if (type === 'websites') renderWebsites();
            else if (type === 'filters') renderFilters();
        }

        function toggleSelection(type, id, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            if (!batchMode[type]) return;
            
            if (selectedItems[type].has(id)) {
                selectedItems[type].delete(id);
            } else {
                selectedItems[type].add(id);
            }
            
            updateSelectedCount(type);
            
            // 更新对应的复选框状态
            const checkbox = document.querySelector(`[data-id="${id}"] .batch-checkbox`);
            if (checkbox) {
                checkbox.checked = selectedItems[type].has(id);
            }
        }

        function updateSelectedCount(type) {
            const count = selectedItems[type].size;
            const spanId = `selectedCount${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const span = document.getElementById(spanId);
            if (span) {
                span.textContent = count;
            }
        }

        function selectAllItems(type) {
            const items = appData[type];
            selectedItems[type].clear();
            items.forEach(item => selectedItems[type].add(item.id));
            
            updateSelectedCount(type);
            
            // 重新渲染以更新复选框状态
            if (type === 'prompts') renderPrompts();
            else if (type === 'websites') renderWebsites();
            else if (type === 'filters') renderFilters();
        }

        function clearSelection(type) {
            selectedItems[type].clear();
            updateSelectedCount(type);
            
            // 重新渲染以更新复选框状态
            if (type === 'prompts') renderPrompts();
            else if (type === 'websites') renderWebsites();
            else if (type === 'filters') renderFilters();
        }

        function batchPin(type) {
            if (selectedItems[type].size === 0) {
                showToast('请先选择要操作的项目', 'error');
                return;
            }
            
            selectedItems[type].forEach(id => {
                const item = appData[type].find(i => i.id === id);
                if (item) item.pinned = true;
            });
            
            saveData();
            
            if (type === 'prompts') renderPrompts();
            else if (type === 'websites') renderWebsites();
            else if (type === 'filters') renderFilters();
            
            showToast(`已置顶 ${selectedItems[type].size} 项`);
            clearSelection(type);
        }

        function batchDelete(type) {
            if (selectedItems[type].size === 0) {
                showToast('请先选择要删除的项目', 'error');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedItems[type].size} 项吗？`)) {
                appData[type] = appData[type].filter(item => !selectedItems[type].has(item.id));
                saveData();
                
                if (type === 'prompts') renderPrompts();
                else if (type === 'websites') renderWebsites();
                else if (type === 'filters') renderFilters();
                
                showToast(`已删除 ${selectedItems[type].size} 项`);
                clearSelection(type);
                updateCategories();
            }
        }

        // 拖拽排序功能
        function addDragListeners(type) {
            const cards = document.querySelectorAll(`[data-type="${type}"]`);
            
            cards.forEach(card => {
                // 移除旧的事件监听器
                card.removeEventListener('dragstart', handleDragStart);
                card.removeEventListener('dragover', handleDragOver);
                card.removeEventListener('dragenter', handleDragEnter);
                card.removeEventListener('dragleave', handleDragLeave);
                card.removeEventListener('drop', handleDrop);
                card.removeEventListener('dragend', handleDragEnd);
                
                // 只在非批量模式下添加拖拽监听器
                if (card.getAttribute('draggable') === 'true') {
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('dragenter', handleDragEnter);
                    card.addEventListener('dragleave', handleDragLeave);
                    card.addEventListener('drop', handleDrop);
                    card.addEventListener('dragend', handleDragEnd);
                }
            });
        }

        function handleDragStart(e) {
            const card = e.target.closest('.item-card');
            if (!card) return;
            
            const type = card.dataset.type;
            if (batchMode[type]) {
                e.preventDefault();
                return;
            }
            
            dragState.draggedElement = card;
            dragState.draggedId = card.dataset.id;
            dragState.draggedType = type;
            
            card.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', card.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const card = e.target.closest('.item-card');
            if (card && card.dataset.type === dragState.draggedType && card !== dragState.draggedElement) {
                card.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const card = e.target.closest('.item-card');
            if (card && !card.contains(e.relatedTarget)) {
                card.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            const targetElement = e.target.closest('.item-card');
            if (!targetElement || targetElement === dragState.draggedElement) {
                return;
            }
            
            const targetId = targetElement.dataset.id;
            const targetType = targetElement.dataset.type;
            
            if (targetType === dragState.draggedType) {
                reorderItems(dragState.draggedType, dragState.draggedId, targetId);
            }
            
            targetElement.classList.remove('drag-over');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            dragState.draggedElement = null;
            dragState.draggedId = null;
            dragState.draggedType = null;
        }

        function reorderItems(type, draggedId, targetId) {
            const items = appData[type];
            const draggedIndex = items.findIndex(item => item.id === draggedId);
            const targetIndex = items.findIndex(item => item.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // 重新排列数组
            const draggedItem = items.splice(draggedIndex, 1)[0];
            items.splice(targetIndex, 0, draggedItem);
            
            saveData();
            
            // 重新渲染
            if (type === 'prompts') renderPrompts();
            else if (type === 'websites') renderWebsites();
            else if (type === 'filters') renderFilters();
            
            showToast('排序已更新');
        }

        // ==================== 云端同步和认证功能 ====================
        
        // 认证状态管理
        let authState = {
            isLoggedIn: false,
            token: localStorage.getItem('authToken') || null,
            lastSync: localStorage.getItem('lastSync') || null
        };

        // API 基础配置
        const API_BASE = window.location.origin + '/api';

        // 认证相关函数
        async function showLoginModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>登录云端同步</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="loginPassword">密码:</label>
                            <input type="password" id="loginPassword" class="form-control" placeholder="请输入密码" />
                        </div>
                        <div class="auth-actions">
                            <button class="btn btn-primary" onclick="attemptLogin()">登录</button>
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">取消</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 添加样式
            if (!document.getElementById('authStyles')) {
                const style = document.createElement('style');
                style.id = 'authStyles';
                style.textContent = `
                    .modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    }
                    .modal-content {
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        width: 90%;
                        max-width: 400px;
                    }
                    .modal-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    }
                    .close {
                        font-size: 24px;
                        cursor: pointer;
                    }
                    .auth-actions {
                        display: flex;
                        gap: 10px;
                        margin-top: 20px;
                    }
                    .sync-status {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 8px 12px;
                        background: var(--surface-color);
                        border-radius: var(--radius-md);
                        border: 1px solid var(--border-color);
                        font-size: var(--font-size-sm);
                    }
                    .sync-indicator {
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                    }
                    .sync-indicator.synced {
                        background-color: var(--success-color);
                    }
                    .sync-indicator.offline {
                        background-color: var(--secondary-color);
                    }
                    .sync-indicator.error {
                        background-color: var(--danger-color);
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.getElementById('loginPassword').focus();
        }

        async function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            if (!password) {
                showToast('请输入密码', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password })
                });

                const result = await response.json();
                
                if (result.success) {
                    authState.token = result.token;
                    authState.isLoggedIn = true;
                    localStorage.setItem('authToken', result.token);
                    
                    document.querySelector('.modal').remove();
                    updateSyncStatus();
                    showToast('登录成功', 'success');
                    
                    // 自动同步数据
                    await syncToCloud();
                } else {
                    showToast(result.error || '登录失败', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('登录失败，请检查网络连接', 'error');
            }
        }

        async function logout() {
            authState.isLoggedIn = false;
            authState.token = null;
            localStorage.removeItem('authToken');
            updateSyncStatus();
            showToast('已退出登录', 'info');
        }

        async function verifyToken() {
            if (!authState.token) return false;
            
            try {
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${authState.token}`
                    }
                });
                
                const result = await response.json();
                authState.isLoggedIn = result.valid;
                return result.valid;
            } catch (error) {
                console.error('Token verification error:', error);
                authState.isLoggedIn = false;
                return false;
            }
        }

        // 云端同步功能
        async function syncToCloud() {
            if (!authState.isLoggedIn) {
                showToast('请先登录', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/data/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authState.token}`
                    },
                    body: JSON.stringify(appData)
                });

                const result = await response.json();
                
                if (result.success) {
                    const now = new Date().toISOString();
                    authState.lastSync = now;
                    localStorage.setItem('lastSync', now);
                    updateSyncStatus();
                    showToast('数据已同步到云端', 'success');
                } else {
                    throw new Error(result.error || '同步失败');
                }
            } catch (error) {
                console.error('Sync error:', error);
                showToast('同步失败: ' + error.message, 'error');
                updateSyncStatus();
            }
        }

        async function loadFromCloud() {
            if (!authState.isLoggedIn) {
                showToast('请先登录', 'warning');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/data/load`, {
                    headers: {
                        'Authorization': `Bearer ${authState.token}`
                    }
                });

                const result = await response.json();
                
                if (result.data) {
                    // 备份当前数据
                    const backup = JSON.stringify(appData);
                    localStorage.setItem('dataBackup', backup);
                    
                    // 加载云端数据
                    appData = result.data;
                    saveData();
                    
                    // 更新UI
                    renderPrompts();
                    renderWebsites();
                    renderFilters();
                    updateStats();
                    
                    authState.lastSync = result.lastSync;
                    localStorage.setItem('lastSync', result.lastSync);
                    updateSyncStatus();
                    
                    showToast('已从云端加载数据', 'success');
                } else {
                    showToast('云端暂无数据', 'info');
                }
            } catch (error) {
                console.error('Load error:', error);
                showToast('加载失败: ' + error.message, 'error');
            }
        }

        function updateSyncStatus() {
            let statusEl = document.querySelector('.sync-status');
            if (!statusEl) {
                // 创建同步状态显示元素
                statusEl = document.createElement('div');
                statusEl.className = 'sync-status';
                
                // 添加到头部工具栏
                const toolbar = document.querySelector('.header-toolbar');
                if (toolbar) {
                    toolbar.appendChild(statusEl);
                }
            }

            const indicator = document.createElement('span');
            indicator.className = 'sync-indicator';
            
            let statusText = '';
            if (authState.isLoggedIn) {
                indicator.classList.add('synced');
                statusText = `已登录 ${authState.lastSync ? '· 最后同步: ' + new Date(authState.lastSync).toLocaleString() : ''}`;
            } else {
                indicator.classList.add('offline');
                statusText = '未登录';
            }
            
            statusEl.innerHTML = '';
            statusEl.appendChild(indicator);
            statusEl.appendChild(document.createTextNode(statusText));
        }

        // 添加同步按钮到工具栏
        function addSyncButtons() {
            const toolbar = document.querySelector('.header-toolbar');
            if (!toolbar) return;

            // 创建同步按钮组
            const syncGroup = document.createElement('div');
            syncGroup.className = 'sync-buttons';
            syncGroup.innerHTML = `
                <button class="btn btn-sm btn-outline-primary" onclick="authState.isLoggedIn ? syncToCloud() : showLoginModal()" title="同步到云端">
                    <span class="icon">☁️</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="authState.isLoggedIn ? loadFromCloud() : showLoginModal()" title="从云端加载">
                    <span class="icon">⬇️</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="authState.isLoggedIn ? logout() : showLoginModal()" title="${authState.isLoggedIn ? '退出登录' : '登录'}">
                    <span class="icon">${authState.isLoggedIn ? '🚪' : '🔑'}</span>
                </button>
            `;
            
            // 添加样式
            const style = document.createElement('style');
            style.textContent = `
                .sync-buttons {
                    display: flex;
                    gap: 4px;
                    margin-left: auto;
                }
                .sync-buttons .btn {
                    padding: 4px 8px;
                    min-width: 32px;
                }
                .sync-buttons .icon {
                    font-size: 14px;
                }
            `;
            document.head.appendChild(style);
            
            toolbar.appendChild(syncGroup);
        }

        // 初始化认证和同步功能
        async function initCloudSync() {
            // 验证已保存的token
            if (authState.token) {
                const isValid = await verifyToken();
                if (!isValid) {
                    localStorage.removeItem('authToken');
                    authState.token = null;
                }
            }
            
            // 添加同步按钮
            addSyncButtons();
            updateSyncStatus();
            
            // 定期自动同步（每5分钟）
            if (authState.isLoggedIn) {
                setInterval(() => {
                    if (authState.isLoggedIn) {
                        syncToCloud();
                    }
                }, 5 * 60 * 1000);
            }
        }

        // 在页面加载完成后初始化云端同步
        document.addEventListener('DOMContentLoaded', function() {
            // 原有的初始化代码...
            setTimeout(initCloudSync, 1000); // 延迟初始化以确保DOM已准备好
        });

        // 增强原有的保存函数，自动云端同步
        const originalSaveData = saveData;
        saveData = function() {
            originalSaveData.call(this);
            
            // 如果已登录，延迟同步到云端
            if (authState.isLoggedIn) {
                clearTimeout(window.autoSyncTimeout);
                window.autoSyncTimeout = setTimeout(() => {
                    syncToCloud();
                }, 2000); // 2秒后自动同步
            }
        };

        // 页面退出前同步
        window.addEventListener('beforeunload', function() {
            if (authState.isLoggedIn) {
                // 同步数据（注意：这可能不会完成，因为页面即将关闭）
                navigator.sendBeacon && navigator.sendBeacon(`${API_BASE}/data/sync`, JSON.stringify({
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authState.token}`
                    },
                    body: JSON.stringify(appData)
                }));
            }
        });
    </script>
</body>
</html>